<div class="card  p-0 radius-12">
    <div class="card-body p-24">
        <form id="addPageForm">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card border">
                        <div class="card-body">
                            <!-- <h6 class="text-md text-primary-light mb-16">Profile Image</h6> -->

                            <!-- Upload Image Start -->
                            <!-- <div class="mb-24 mt-16">
                                <div class="avatar-upload">
                                    <div class="avatar-edit position-absolute bottom-0 end-0 me-24 mt-16 z-1 cursor-pointer">
                                        <input type='file' id="imageUpload" accept=".png, .jpg, .jpeg" hidden>
                                        <label for="imageUpload" class="w-32-px h-32-px d-flex justify-content-center align-items-center bg-primary-50 text-primary-600 border border-primary-600 bg-hover-primary-100 text-lg rounded-circle">
                                            <iconify-icon icon="solar:camera-outline" class="icon"></iconify-icon>
                                        </label>
                                    </div>
                                    <div class="avatar-preview">
                                        <div id="imagePreview"> </div>
                                    </div>
                                </div>
                            </div> -->
                            <!-- Upload Image End -->

                            <!-- <form id="addPageForm"> -->
                                <div class="mb-20">
                                    <label for="name" class="form-label fw-semibold text-primary-light text-sm mb-8">Page
                                        Name <span class="text-danger-600">*</span></label>
                                    <input type="text" class="form-control radius-8" id="name" name="name"
                                        placeholder="Enter Page Name" maxlength="150" pattern="[A-Za-z\s]+"
                                        title="Only letters and spaces allowed, max 150 characters" required>
                                    <small class="text-muted">Only letters allowed (max 150 characters)</small>
                                </div>
                                <div class="mb-20">
                                    <label for="path"
                                        class="form-label fw-semibold text-primary-light text-sm mb-8">Slug</label>
                                    <input type="text" class="form-control radius-8" id="path" name="path"
                                        placeholder="e.g., /about or /services" readonly>
                                    <small class="text-muted">Slug will be auto-generated from page name if left
                                        empty</small>
                                </div>
                                <div class="mb-20">
                                    <label for="template"
                                        class="form-label fw-semibold text-primary-light text-sm mb-8">Select Template</label>
                                    <select class="form-control radius-8" id="template" name="template">
                                        <!-- <option value="">-- No Template (Empty Page) --</option> -->
                                        <option value="home">Home Template - Hero + 3 Callout Cards</option>
                                        <option value="about">About Template - Hero with Button + Tabs Section</option>
                                        <option value="newsletter">Newsletter Template - Hero with Button + Tabs Section</option>
                                        <option value="legislation">Legislation Template - Hero with 2 Buttons + 1 Callout Card</option>
                                        <option value="query">Query Template - Hero with 3 CTA Buttons</option>
                                        <option value="membership">Membership Template - Hero with Buttons + Community Groups</option>
                                        <option value="contact">Contact Template - Contact blocks + Helpful Links</option>
                                        <option value="custom">Custom Template - Empty template with custom sections</option>
                                    </select>
                                    <small class="text-muted">Select a template to auto-create page sections</small>
                                </div>

                                <div class="mb-20" id="templatePreview" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6 class="mb-2">Template Layout</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div id="templateDescription"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <div id="templateImageContainer" class="text-center">
                                                    <img id="templateImage" src="" alt="Template Preview" class="img-fluid rounded border" style="max-height: 200px; display: none;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- <div class="mb-20">
                                    <label for="status"
                                        class="form-label fw-semibold text-primary-light text-sm mb-8">Status</label>
                                    <select class="form-control radius-8" id="status" name="status">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div> -->
                                <!-- <div class="mb-20">
                                    <label for="metaTitle" class="form-label fw-semibold text-primary-light text-sm mb-8">Meta Title</label>
                                    <input type="text" class="form-control radius-8" id="metaTitle" name="metaTitle" placeholder="Enter Meta Title for SEO">
                                </div>
                                <div class="mb-20">
                                    <label for="metaDescription" class="form-label fw-semibold text-primary-light text-sm mb-8">Meta Description</label>
                                    <textarea class="form-control radius-8" id="metaDescription" name="metaDescription" rows="3" placeholder="Enter Meta Description for SEO"></textarea>
                                </div> -->
                                
                            
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="page-publish-box">
                        <h4 class="publish-heading">Publish</h4>
                        <div class="status-dropdown">
                            <label for="">Status:</label>
                            <select name="status" id="status">
                                <option value="inactive">Draft</option>
                                <!-- <option value="active">Publish</option> -->
                            </select>
                        </div>
                        <div class="d-flex publish-btns">
                            <a href="/page-master/web-page-master"
                                class="btn btn-sm  btn-outline-secondary">
                                Cancel
                            </a>
                           
                            <button type="submit"
                                class="btn btn-sm btn-secondary d-flex align-items-center gap-1">
                                Next
                            </button>
                             <button type="button" id="saveDraftBtn"
                                class="btn btn-sm btn-primary d-flex align-items-center gap-1">
                                Save 
                            </button>
                        </div>
                    </div>
                    
                    <!-- Categories Section -->
                    <div class="page-categories-box mt-3">
                        <h4 class="categories-heading">Categories</h4>
                        <div class="categories-checkboxes">
                            <div class="category-checkbox-item mb-3">
                                <input type="checkbox" value="community" id="category-community" name="categories" class="category-checkbox-input">
                                <label class="category-checkbox-label" for="category-community">
                                    <div class="category-checkbox-content">
                                        <div class="category-checkbox-icon">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <span class="category-checkbox-text">Community</span>
                                    </div>
                                </label>
                            </div>
                            <!-- <div class="category-checkbox-item mb-3">
                                <input type="checkbox" value="news" id="category-news" name="categories" class="category-checkbox-input">
                                <label class="category-checkbox-label" for="category-news">
                                    <div class="category-checkbox-content">
                                        <div class="category-checkbox-icon">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <span class="category-checkbox-text">News</span>
                                    </div>
                                </label>
                            </div>
                            <div class="category-checkbox-item mb-3">
                                <input type="checkbox" value="events" id="category-events" name="categories" class="category-checkbox-input">
                                <label class="category-checkbox-label" for="category-events">
                                    <div class="category-checkbox-content">
                                        <div class="category-checkbox-icon">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <span class="category-checkbox-text">Events</span>
                                    </div>
                                </label>
                            </div>
                            <div class="category-checkbox-item mb-3">
                                <input type="checkbox" value="resources" id="category-resources" name="categories" class="category-checkbox-input">
                                <label class="category-checkbox-label" for="category-resources">
                                    <div class="category-checkbox-content">
                                        <div class="category-checkbox-icon">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <span class="category-checkbox-text">Resources</span>
                                    </div>
                                </label>
                            </div> -->
                            <div class="category-checkbox-item mb-3">
                                <input type="checkbox" value="blog" id="category-blog" name="categories" class="category-checkbox-input">
                                <label class="category-checkbox-label" for="category-blog">
                                    <div class="category-checkbox-content">
                                        <div class="category-checkbox-icon">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <span class="category-checkbox-text">Blog</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <small class="text-muted">Select categories to group related pages (required for community groups display)</small>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<% script=` 
<script>
    $(document).ready(function() {
    // Template descriptions and images
    const templateData = {
        home: {
            description: 'This template includes:<br>• Hero section (heading + subheading)<br>• 3 Callout Cards (heading, paragraph, button text, button link)',
            image: '/images/templates/home-template-preview.jpg'
        },
        about: {
            description: 'This template includes:<br>• Hero section (heading + subheading + button text + button link)<br>• Tabs section (3 default tabs, add/remove as needed)',
            image: '/images/templates/about-template-preview.jpg'
        },
        newsletter: {
            description: 'This template includes:<br>• Hero section (heading + subheading + button text + button link)<br>• Tabs section (3 default tabs, add/remove as needed)',
            image: '/images/templates/newsletter-template-preview.jpg'
        },
        legislation: {
            description: 'This template includes:<br>• Hero section (heading + subheading + 2 buttons: text + link)<br>• 1 Callout Card (heading, paragraph, button text, button link)',
            image: '/images/templates/legislation-template-preview.jpg'
        },
        query: {
            description: 'This template includes:<br>• Hero section (heading + subheading + 3 CTA buttons: text + link + style)',
            image: '/images/templates/query-template-preview.jpg'
        },
        membership: {
            description: 'This template includes:<br>• Hero section (heading + subheading + 2 CTA buttons)<br>• Community Groups section (displays pages with community category)',
            image: '/images/templates/membership-template-preview.jpg'
        }
        ,
        contact: {
            description: 'This template includes:<br>• Contact section (email, call, general contact form)<br>• Helpful links list (dynamic)',
            image: '/images/templates/contact-template-preview.jpg'
        },
        custom: {
            description: 'This template includes:<br>• Empty template - no predefined sections<br>• Add custom sections with flexible content<br>• Perfect for unique page layouts',
            image: '/images/templates/custom-template-preview.svg'
        }
    };
    //default template selection preview
    const $defaultPreview = $('#templatePreview');
    const $defaultDescription = $('#templateDescription');
    const $defaultImage = $('#templateImage');
    
    // Show default template preview (home template)
    function showDefaultTemplatePreview() {
        const defaultTemplate = 'home'; // Default to home template for new pages
        if (templateData[defaultTemplate]) {
            $defaultDescription.html(templateData[defaultTemplate].description);
            $defaultImage.attr('src', templateData[defaultTemplate].image);
            $defaultImage.show();
            $defaultPreview.show();
        }
    }
    
    // Initialize default preview
    showDefaultTemplatePreview();
    // Handle template selection
    $('#template').on('change', function() {
        const selectedTemplate = $(this).val();
        const $preview = $('#templatePreview');
        const $description = $('#templateDescription');
        const $image = $('#templateImage');
        
        if (selectedTemplate && templateData[selectedTemplate]) {
            $description.html(templateData[selectedTemplate].description);
            $image.attr('src', templateData[selectedTemplate].image);
            $image.show();
            $preview.show();
        } else {
            $image.hide();
            $preview.hide();
        }
    });
    $('#name').on('input', function() {
        let value = $(this).val();

        // 1. FILTER INPUT: Allow ONLY letters and standard spaces (NO NUMBERS).
        const cleanedValue = value.replace(/[^A-Za-z\s ]/g, '');

        // Update the input field only if cleaning occurred
        if (value !== cleanedValue) {
            $(this).val(cleanedValue);
            value = cleanedValue; 
        }
        
        // 2. ENFORCE MAX LENGTH (30 characters)
        if (value.length > 150) {
            value = value.substring(0, 150);
            if ($(this).val().length > 150) {
                $(this).val(value);
            }
        }

        // 3. AUTO-GENERATE ROBUST SLUG/PATH
        const slug = value.toLowerCase()
        // 1. Replace ALL non-alphanumeric characters (including spaces and symbols) 
        //    with a single hyphen. This is the most reliable way to create a slug.
        .replace(/[^a-z0-9]+/g, '-') 
        // 2. Remove any leading or trailing hyphens
        .replace(/^-+|-+$/g, ''); 

        // Determine the final path
        // If the slug is empty, set path to '', otherwise prepend '/'
        const path = slug === '' ? '' : (slug === 'home' ? '/' : '/' + slug);

        $('#path').val(path);
    });

    // Handle Save Draft button
    $('#saveDraftBtn').on('click', function(e) {
        e.preventDefault();
        
        const nameVal = $('#name').val().trim();
        
        if (nameVal.length === 0) {
            showToast('Page Name cannot be empty or spaces only!', 'error');
            return;
        }
        
        const saveDraftBtn = $(this);
        const originalText = saveDraftBtn.html();
        const publishBtns = $('#addPageForm .publish-btns a, #addPageForm button[type="submit"]');
        
        // Disable all buttons
        publishBtns.each(function() {
            $(this).prop('disabled', true);
            if ($(this).is('a')) {
                $(this).addClass('disabled');
                $(this).css('cursor', 'not-allowed');
            }
        });
        
        saveDraftBtn.prop('disabled', true);
        saveDraftBtn.html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...');
        
        // Get selected categories
        const selectedCategories = [];
        $('input[name="categories"]:checked').each(function() {
            selectedCategories.push($(this).val());
        });
        
        const formData = {
            name: $('#name').val(),
            path: $('#path').val().trim() || undefined,
            status: 'inactive', // Always save as draft
            template: $('#template').val(),
            category: selectedCategories.length > 0 ? selectedCategories[0] : '',
            metaTitle: $('#metaTitle').val(),
            metaDescription: $('#metaDescription').val()
        };
        
        console.log('Draft form data being sent:', formData);
        console.log('Draft template value:', $('#template').val());
        
        $.ajax({
            url: '/api/pages',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showToast('Draft saved successfully!', 'success');
                    setTimeout(function() {
                        window.location.href = '/page-master/web-page-master';
                    }, 1500);
                } else {
                    showToast('Error: ' + response.message, 'error');
                    // Re-enable buttons
                    saveDraftBtn.prop('disabled', false);
                    saveDraftBtn.html(originalText);
                    publishBtns.each(function() {
                        $(this).prop('disabled', false);
                        if ($(this).is('a')) {
                            $(this).removeClass('disabled');
                            $(this).css('cursor', 'pointer');
                        }
                    });
                }
            },
            error: function(xhr) {
                console.error('Full error:', xhr);
                let errorMessage = 'Unknown error';
                
                if (xhr.responseJSON) {
                    errorMessage = xhr.responseJSON.message || xhr.responseJSON.error || 'Unknown error';
                } else if (xhr.responseText) {
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        errorMessage = errorData.message || errorData.error || 'Unknown error';
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                
                showToast('Error saving draft: ' + errorMessage, 'error');
                // Re-enable buttons
                saveDraftBtn.prop('disabled', false);
                saveDraftBtn.html(originalText);
                publishBtns.each(function() {
                    $(this).prop('disabled', false);
                    if ($(this).is('a')) {
                        $(this).removeClass('disabled');
                        $(this).css('cursor', 'pointer');
                    }
                });
            }
        });
    });

    // Handle form submission
    $('#addPageForm').on('submit', function(e) {
        const nameVal = $('#name').val().trim();  // Trim spaces

        if (nameVal.length === 0) {
            e.preventDefault();

            // Disable Save button
            const saveBtn = $('#addPageForm button[type="submit"]')[0];
            saveBtn.disabled = true;
            // saveBtn.innerHTML = 'Name cannot be blank or spaces only';
            
            // Re-enable after short delay
            setTimeout(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save';
            }, 2000);

            showToast('Page Name cannot be empty or spaces only!', 'error');
            return; // Stop submission
        }

        const saveBtn = $('#addPageForm button[type="submit"]')[0];
        const publishBtns = $('#addPageForm .publish-btns a');
            // Disable all anchor tags
            publishBtns.each(function () {
                // Add disabled class for styling
                $(this).addClass('disabled');
                $(this).css('cursor', 'not-allowed');
                $(this).attr('disabled',true);

                // Remove click functionality
                $(this).on('click.disabled', function (e) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                });

            });
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
        e.preventDefault();

        // Get selected categories
        const selectedCategories = [];
        $('input[name="categories"]:checked').each(function() {
            selectedCategories.push($(this).val());
        });

        const formData = {
            name: $('#name').val(),
            path: $('#path').val().trim() || undefined,
            status: $('#status').val(),
            template: $('#template').val(),
            category: selectedCategories.length > 0 ? selectedCategories[0] : '', // For now, take first selected category
            metaTitle: $('#metaTitle').val(),
            metaDescription: $('#metaDescription').val()
        };

        console.log('Form data being sent:', formData);
        console.log('Template value:', $('#template').val());

        $.ajax({
            url: '/api/pages',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    const template = $('#template').val();
                    if (template) {
                        showToast('Page created successfully! Redirecting to content editor...', 'success');
                        setTimeout(function() {
                          window.location.href = '/cms/edit-content-management/' + response.data._id;

                        }, 1500);
                    } else {
                        showToast('Page created successfully!', 'success');
                        setTimeout(function() {
                            window.location.href = '/page-master/web-page-master';
                        }, 1000);
                    }
                } else {
                    showToast('Error: ' + response.message, 'error');
                }
            },
            error: function(xhr) {
                console.error('Full error:', xhr);
                let errorMessage = 'Unknown error';

                if (xhr.responseJSON) {
                    errorMessage = xhr.responseJSON.message || xhr.responseJSON.error || 'Unknown error';
                } else if (xhr.responseText) {
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        errorMessage = errorData.message || errorData.error || 'Unknown error';
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }

                showToast('Error creating page: ' + errorMessage, 'error');
            }
        });
    });
    });
    </script>
      ` %>