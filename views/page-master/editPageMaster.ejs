<div class="card p-0 radius-12">
    <div class="card-body p-24">
         <form id="editPageForm">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border">
                    <div class="card-body">
                       
                            <input type="hidden" id="pageId" value="<%= page._id %>">

                            <div class="mb-20">
                                <label for="name" class="form-label fw-semibold text-primary-light text-sm mb-8">Page Name <span class="text-danger-600">*</span></label>
                                <input type="text" class="form-control radius-8" id="name" name="name" value="<%= page.name %>" placeholder="Enter Page Name" required>
                            </div>
                            <div class="mb-20">
                                <label for="path" class="form-label fw-semibold text-primary-light text-sm mb-8">Slug <span class="text-danger-600">*</span></label>
                                <input type="text" class="form-control radius-8" id="path" name="path" value="<%= page.path %>" placeholder="e.g., /about or /services" required readonly>
                            </div>
                            <div class="mb-20">
                                <label for="template" class="form-label fw-semibold text-primary-light text-sm mb-8">Page Template</label>
                                <input type="hidden" name="originalPageTemplate" id="originalPageTemplate" value="<%= page.template %>">
                                <select class="form-control radius-8" id="template" name="template" disabled style="cursor: not-allowed; opacity: 0.6;">
                                    <!-- <option value="" <%= !page.template ? 'selected' : '' %>>-- No Template (Custom Page) --</option> -->
                                    <option value="home" <%= page.template === 'home' ? 'selected' : '' %>>Home Template - Hero + 3 Callout Cards</option>
                                    <option value="about" <%= page.template === 'about' ? 'selected' : '' %>>About Template - Hero with Button + Tabs Section</option>
                                    <option value="legislation" <%= page.template === 'legislation' ? 'selected' : '' %>>Legislation Template - Hero with 2 Buttons + 1 Callout Card</option>
                                    <option value="query" <%= page.template === 'query' ? 'selected' : '' %>>Query Template - Hero with 3 CTA Buttons</option>
                                    <option value="membership" <%= page.template === 'membership' ? 'selected' : '' %>>Membership Template - Hero with Buttons + Community Groups</option>
                                </select>
                                <small class="text-muted">
                                    <i class="fas fa-lock me-1"></i>
                                    Template cannot be changed after page creation to preserve existing content
                                </small>
                            </div>

                            <div class="mb-20" id="templatePreview" style="display: none;">
                                <div class="alert alert-warning">
                                    <!-- <h6 class="mb-2">⚠️ Template Change Warning:</h6> -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div id="templateDescription"></div>
                                            <!-- <p class="mb-0 mt-2"><strong>This will replace all existing page content!</strong></p> -->
                                        </div>
                                        <div class="col-md-6">
                                            <div id="templateImageContainer" class="text-center">
                                                <img id="templateImage" src="" alt="Template Preview" class="img-fluid rounded border" style="max-height: 200px; display: none;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="mb-20">
                                <label for="status" class="form-label fw-semibold text-primary-light text-sm mb-8">Status</label>
                                <select class="form-control radius-8" id="status" name="status">
                                    <option value="active" <%= page.status === 'active' ? 'selected' : '' %>>Active</option>
                                    <option value="inactive" <%= page.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                                </select>
                            </div> -->
                            <!-- <div class="mb-20">
                                <label for="metaTitle" class="form-label fw-semibold text-primary-light text-sm mb-8">Meta Title</label>
                                <input type="text" class="form-control radius-8" id="metaTitle" name="metaTitle" value="<%= page.metaTitle || '' %>" placeholder="Enter Meta Title for SEO">
                            </div>
                            <div class="mb-20">
                                <label for="metaDescription" class="form-label fw-semibold text-primary-light text-sm mb-8">Meta Description</label>
                                <textarea class="form-control radius-8" id="metaDescription" name="metaDescription" rows="3" placeholder="Enter Meta Description for SEO"><%= page.metaDescription || '' %></textarea>
                            </div> -->
                            
                        
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="page-publish-box">
                    <h4 class="publish-heading">Publish</h4>
                    <div class="status-dropdown">
                        <label for="status" class="form-label fw-semibold text-primary-light text-sm mb-8">Status</label>
                                <select class="form-controlradius-8" id="status" name="status">
                                    <option value="inactive" <%= page.status === 'inactive' ? 'selected' : '' %>>Draft</option>
                                    <option value="active" <%= page.status === 'active' ? 'selected' : '' %>>Publish</option>
                                </select>
                    </div>
                    <div class="d-flex publish-btns">
                        <a href="/page-master/web-page-master"
                            class="border border-danger-600 bg-hover-danger-200 text-danger-600 text-md px-56 py-11 radius-8">
                            Cancel
                        </a>
                        <a href="/cms/edit-content-management/<%= page._id %>"
                            class="border border-success-600 bg-hover-success-200 text-success-600 text-md px-56 py-11 radius-8">
                            Edit Content
                        </a>
                        <button type="submit"
                            class="btn btn-primary border border-primary-600 text-md px-56 py-12 radius-8 submit-form-page">
                            Update
                        </button>
                    </div>
                </div>
                
                <!-- Categories Section -->
                <div class="page-categories-box mt-3">
                    <h4 class="categories-heading">Categories</h4>
                    <div class="categories-checkboxes">
                        <div class="category-checkbox-item mb-3">
                            <input type="checkbox" value="community" id="category-community" name="categories" class="category-checkbox-input" <%= page.category === 'community' ? 'checked' : '' %>>
                            <label class="category-checkbox-label" for="category-community">
                                <div class="category-checkbox-content">
                                    <div class="category-checkbox-icon">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <span class="category-checkbox-text">Community</span>
                                </div>
                            </label>
                        </div>
                        <!-- <div class="category-checkbox-item mb-3">
                            <input type="checkbox" value="news" id="category-news" name="categories" class="category-checkbox-input" <%= page.category === 'news' ? 'checked' : '' %>>
                            <label class="category-checkbox-label" for="category-news">
                                <div class="category-checkbox-content">
                                    <div class="category-checkbox-icon">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <span class="category-checkbox-text">News</span>
                                </div>
                            </label>
                        </div>
                        <div class="category-checkbox-item mb-3">
                            <input type="checkbox" value="events" id="category-events" name="categories" class="category-checkbox-input" <%= page.category === 'events' ? 'checked' : '' %>>
                            <label class="category-checkbox-label" for="category-events">
                                <div class="category-checkbox-content">
                                    <div class="category-checkbox-icon">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <span class="category-checkbox-text">Events</span>
                                </div>
                            </label>
                        </div>
                        <div class="category-checkbox-item mb-3">
                            <input type="checkbox" value="resources" id="category-resources" name="categories" class="category-checkbox-input" <%= page.category === 'resources' ? 'checked' : '' %>>
                            <label class="category-checkbox-label" for="category-resources">
                                <div class="category-checkbox-content">
                                    <div class="category-checkbox-icon">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <span class="category-checkbox-text">Resources</span>
                                </div>
                            </label>
                        </div> -->
                    </div>
                    <small class="text-muted">Select categories to group related pages (required for community groups display)</small>
                </div>
            </div>
        </div>
        </form>
    </div>
</div>

<% script = `
<script>
    $(document).ready(function() {
        // Template descriptions and images
        const templateData = {
            home: {
                description: 'This template includes:<br>• Hero section (heading + subheading)<br>• 3 Callout Cards (heading, paragraph, button text, button link)',
                image: '/images/templates/home-template-preview.svg'
            },
            about: {
                description: 'This template includes:<br>• Hero section (heading + subheading + button text + button link)<br>• Tabs section (3 default tabs, add/remove as needed)',
                image: '/images/templates/about-template-preview.svg'
            },
            legislation: {
                description: 'This template includes:<br>• Hero section (heading + subheading + 2 buttons: text + link)<br>• 1 Callout Card (heading, paragraph, button text, button link)',
                image: '/images/templates/legislation-template-preview.svg'
            },
            query: {
                description: 'This template includes:<br>• Hero section (heading + subheading + 3 CTA buttons: text + link + style)',
                image: '/images/templates/query-template-preview.svg'
            },
            membership: {
                description: 'This template includes:<br>• Hero section (heading + subheading + 2 CTA buttons)<br>• Community Groups section (displays pages with community category)',
                image: '/images/templates/membership-template-preview.svg'
            },
            // membership: {
            //     description: 'This template includes:<br>• Hero section (heading + subheading)',
            //     image: '/images/templates/membership-template-preview.svg'
            // }
        };
        const $defaultPreview = $('#templatePreview');
        const $defaultDescription = $('#templateDescription');
        const $defaultImage = $('#templateImage');
        
        // Store original template value
        const originalTemplate = $('#originalPageTemplate').val();
        
        // Show current template preview on page load
        function showCurrentTemplatePreview() {
            const currentTemplate = $('#originalPageTemplate').val();
            if (currentTemplate && templateData[currentTemplate]) {
                $defaultDescription.html(templateData[currentTemplate].description);
                $defaultImage.attr('src', templateData[currentTemplate].image);
                $defaultImage.show();
                $defaultPreview.show();
            }
        }
        
        // Initialize preview on page load
        showCurrentTemplatePreview();

        // Handle template selection
        /* $('#template').on('change', function() {
            const selectedTemplate = $(this).val();
            const $preview = $('#templatePreview');
            const $description = $('#templateDescription');
            const $image = $('#templateImage');
            
            if (selectedTemplate && selectedTemplate !== originalTemplate && templateData[selectedTemplate]) {
                $description.html(templateData[selectedTemplate].description);
                $image.attr('src', templateData[selectedTemplate].image);
                $(".submit-form-page").text("Next");
                $image.show();
                $preview.show();
            } else {
                $(".submit-form-page").text("Update");
                $image.hide();
                $preview.hide();
            }
        }); */

        $('#name').on('input', function() {
            let value = $(this).val();

            // 1. FILTER INPUT: Allow ONLY letters, numbers, and standard spaces.
            // The previous fix ensures we allow standard spaces:
            const cleanedValue = value.replace(/[^A-Za-z0-9\s ]/g, '');

            // Update the input field only if cleaning occurred
            if (value !== cleanedValue) {
                $(this).val(cleanedValue);
                value = cleanedValue; 
            }
            
            // 2. ENFORCE MAX LENGTH (30 characters)
            if (value.length > 30) {
                value = value.substring(0, 30);
                if ($(this).val().length > 30) {
                    $(this).val(value);
                }
            }
        });
        // Handle form submission
        $('#editPageForm').on('submit', function(e) {
            const saveBtn = $('#editPageForm button[type="submit"]')[0];
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
            e.preventDefault();

            const pageId = $('#pageId').val();
            // Get selected categories
            const selectedCategories = [];
            $('input[name="categories"]:checked').each(function() {
                selectedCategories.push($(this).val());
            });

            const formData = {
                name: $('#name').val(),
                path: $('#path').val(),
                status: $('#status').val(),
                template: $('#template').val(),
                category: selectedCategories.length > 0 ? selectedCategories[0] : '', // For now, take first selected category
                metaTitle: $('#metaTitle').val(),
                metaDescription: $('#metaDescription').val()
            };

            $.ajax({
                url: '/api/pages/' + pageId,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        const template = $('#template').val();
                        if (template && template !== originalTemplate) {
                            showToast('Page template updated successfully! Redirecting to content editor...', 'success');
                            setTimeout(function() {
                                
                                window.location.href = '/cms/edit-content-management/' + pageId;
                            }, 1500);
                        } else {
                            showToast('Page updated successfully!', 'success');
                            setTimeout(function() {
                                window.location.href = '/page-master/web-page-master';
                            }, 1000);
                        }
                    } else {
                        showToast('Error: ' + response.message, 'error');
                    }
                },
                error: function(xhr) {
                    showToast('Error updating page: ' + (xhr.responseJSON?.message || 'Unknown error'), 'error');
                }
            });
        });
    });
</script>
` %>
