<div class="row gy-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header border-bottom">
                <h6 class="text-xl mb-0">Edit Content Section > <%= page.name %></h6>
            </div>
            <div class="card-body p-24">
                <form id="editContentForm" class="d-flex flex-column gap-20">
                    <input type="hidden" id="contentId" value="<%= content._id %>">
                    <div class="row">
                        <div class="col-lg-8">
                            <div id="sectionsContainer">
                        <% if (allSections && allSections.length> 0) { %>
                            <% allSections.forEach(function(section, index) { %>
                                <div class="section-block border border-neutral-300 radius-8 p-5 bg-neutral-50 mb-4"
                                    data-id="<%= section._id %>">
                                    <!-- <h6 class="text-lg mb-3">Section <%= index + 1 %>
                                    </h6> -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="text-lg mb-0">Section <%= index + 1 %></h6>
                                        <span class="badge bg-primary-600">Template Section</span>
                                    </div>
                                    <div class="mb-3">
                                        <input type="hidden" class="original-section-type"
                                            value="<%= section.sectionType %>">
                                        <label class="form-label">Section Type: <span
                                                class="text-danger-600">*</span></label>
                                        <select class="form-control border border-neutral-200 radius-8 section-type section-type-select"
                                            disabled>
                                            <option value="" <%= !section.sectionType ? 'selected' : '' %>>-- Please Select Section --</option>

                                            <option value="hero-section" <%= section.sectionType === 'hero-section' ? 'selected' : '' %>>Hero Section</option>
                                            <option value="three-column-info" <%= section.sectionType === 'three-column-info' ? 'selected' : '' %>>Header Section</option>
                                            <option value="call-out-cards" <%= section.sectionType === 'call-out-cards' ? 'selected' : '' %>>Call Out Section</option>
                                            <option value="tabs-section" <%= section.sectionType === 'tabs-section' ? 'selected' : '' %>>Tabs Section</option>
                                        </select>
                                    </div>

                                    <!-- server-side renders active fields; per-block JS removed -->

                                    <!-- Dynamic fields based on section type -->
                                    <div class="section-fields asdf">
                                        <!-- <pre><%= JSON.stringify(section, null, 2) %></pre> -->
                                        <% if (section.sectionType==='image-with-text' ) { %>
                                            <div class="image-with-text-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwt-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Subheading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwt-subheading"
                                                        value="<%= section.customFields?.subheading || '' %>"
                                                        placeholder="Subheading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Text:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 iwt-text"
                                                        rows="4"
                                                        placeholder="Description"><%= section.customFields?.richText || '' %></textarea>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='image-with-list' ) { %>
                                            <div class="image-with-list-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwl-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">List Items:</label>
                                                    <div class="iwl-items">
                                                        <% (section.customFields?.items || []).forEach(function(it){
                                                            %>
                                                            <div
                                                                class="iwl-item d-flex align-items-center gap-2 mb-2">
                                                                <input type="text"
                                                                    class="form-control border border-neutral-200 radius-8 iwl-item-input"
                                                                    value="<%= it %>">
                                                                <button type="button"
                                                                    class="btn btn-sm btn-danger-600 remove-iwl-item">Remove</button>
                                                            </div>
                                                            <% }) %>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='heading-subheading' ) { %>
                                            <div class="heading-subheading-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hs-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Subheading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hs-subheading"
                                                        value="<%= section.customFields?.subheading || '' %>"
                                                        placeholder="Subheading">
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input hs-center" type="checkbox"
                                                        <%=section.customFields?.alignCenter ? 'checked' : ''
                                                        %>>
                                                    <label class="form-check-label">Center Align</label>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='hero-section' ) { %>
                                            <div class="hero-section-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hero-heading"
                                                        value="<%= section.heroSection?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Paragraph:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 hero-paragraph"
                                                        rows="4"
                                                        placeholder="Paragraph"><%= section.heroSection?.paragraph || '' %></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Call To Action Buttons:</label>
                                                    <div class="cta-container">
                                                        <% if (section.heroSection?.ctas && section.heroSection.ctas.length > 0) { %>
                                                            <% section.heroSection.ctas.forEach(function(cta, index) { %>
                                                                <div class="cta-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                                        <span class="fw-semibold text-sm">CTA Button #<%= index + 1 %></span>
                                                                        <button type="button" class="btn btn-sm btn-danger-600 remove-cta-btn">Remove</button>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label class="form-label text-sm">Button Text:</label>
                                                                        <input type="text" class="form-control border border-neutral-200 radius-8 cta-text"
                                                                            value="<%= cta.text || '' %>" placeholder="e.g., Learn More">
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label class="form-label text-sm">Button Link:</label>
                                                                        <input type="text" class="form-control border border-neutral-200 radius-8 cta-link"
                                                                            value="<%= cta.link || '' %>" placeholder="e.g., /about">
                                                                    </div>
                                                                    <!-- <div>
                                                                        <label class="form-label text-sm">Button Style:</label>
                                                                        <select class="form-control border border-neutral-200 radius-8 cta-style">
                                                                            <option value="primary" <%= cta.style === 'primary' ? 'selected' : '' %>>Primary</option>
                                                                            <option value="secondary" <%= cta.style === 'secondary' ? 'selected' : '' %>>Secondary</option>
                                                                            <option value="outline" <%= cta.style === 'outline' ? 'selected' : '' %>>Outline</option>
                                                                        </select>
                                                                    </div> -->
                                                                </div>
                                                            <% }) %>
                                                        <% } %>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-cta-btn">Add CTA Button</button>
                                                </div>
                                                <% if (section.heroSection?.rightImage) { %>
                                                    <div class="mb-3">
                                                        <label class="form-label">Current Image:</label>
                                                        <div class="existing-image">
                                                            <img src="<%= section.heroSection.rightImage %>"
                                                                class="img-thumbnail"
                                                                style="max-height: 200px;">
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        <% } else if (section.sectionType==='three-column-info' ) { %>
                                            <!-- <pre><%= JSON.stringify(section) %></pre> -->
                                            <!-- <pre><%= JSON.stringify(section.threeColumnInfo.heading) %></pre> -->
                                            <div class="three-column-info-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Section Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 tci-heading"
                                                        value="<%= section.threeColumnInfo?.heading || '' %>"
                                                        placeholder="Main Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Section Sub-heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 tci-subheading"
                                                        value="<%= section.threeColumnInfo?.subheading || '' %>"
                                                        placeholder="Sub-heading">
                                                </div>
                                                <!-- <div class="form-check mb-3">
                                                    <input class="form-check-input tci-image-left" type="checkbox"
                                                        <%=section.threeColumnInfo?.imageOnLeft ? 'checked' : '' %>>
                                                    <label class="form-check-label">Image on Left</label>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">Upload Section Image</label>
                                                    <div class="upload-image-wrapper">
                                                        <% if (section.threeColumnInfo?.image) { %>
                                                            <div class="mb-3">
                                                                <label class="form-label">Current Image:</label>
                                                                <div class="existing-image">
                                                                    <img src="<%= section.threeColumnInfo.image %>"
                                                                        class="img-thumbnail"
                                                                        style="max-height: 200px;">
                                                                </div>
                                                            </div>
                                                        <% } %>
                                                        <div
                                                            class="uploaded-img-tci d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                                            <button type="button" class="uploaded-img-tci__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                                                <iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon>
                                                            </button>
                                                            <img class="uploaded-img-tci__preview w-100 h-100 object-fit-cover"
                                                                src="/images/user.png"
                                                                alt="image">
                                                        </div>
                                                        <label
                                                            class="upload-file-tci h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                                            <iconify-icon icon="solar:camera-outline"
                                                                class="text-xl text-secondary-light"></iconify-icon>
                                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                                            <input type="file" class="upload-file-tci-input" hidden accept="image/*" data-existing-image="<%= section.threeColumnInfo?.image || '' %>">
                                                        </label>
                                                    </div>
                                                </div> -->
                                                <div class="mb-3">
                                                    <label class="form-label">Buttons:</label>
                                                    <div class="column-container">

                                                        <% (section.threeColumnInfo?.columns ||
                                                            []).forEach(function(col, idx){ %>
                                                            <div
                                                                class="column-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div
                                                                    class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span
                                                                        class="fw-semibold text-sm">Button
                                                                        #<%= idx + 1 %></span>
                                                                    <span class="badge bg-secondary">Template Button</span>
                                                                </div>
                                                                <!-- <div class="mb-2"><label
                                                                        class="form-label text-sm">Title:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-title"
                                                                        value="<%= col.title %>"
                                                                        placeholder="e.g., Call Out 1">
                                                                </div>
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Description:</label>
                                                                    <textarea
                                                                        class="form-control border border-neutral-200 radius-8 column-description"
                                                                        rows="3"
                                                                        placeholder="Enter description"><%= col.description %></textarea>
                                                                </div> -->
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Button
                                                                        Text:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-btn-text"
                                                                        value="<%= col.buttonText %>"
                                                                        placeholder="e.g., More">
                                                                </div>
                                                                <div><label
                                                                        class="form-label text-sm">Button
                                                                        Link:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-btn-link"
                                                                        value="<%= col.buttonLink %>"
                                                                        placeholder="e.g., /learn-more">
                                                                </div>
                                                            </div>
                                                        <% }) %>


                                                    </div>
                                                    <small class="text-muted">Buttons are defined by the page template</small>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='call-out-cards' ) { %>
                                            <div class="call-out-cards-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Card Carousels:</label>
                                                    <!-- Debug: <%= JSON.stringify(section.callOutCards) %> -->
                                                    <div class="callout-container">
                                                        <%
                                                        const cards = section.callOutCards?.cards || [];
                                                        if (cards.length === 0) { %>
                                                            <p class="text-muted">No cards found. Click "Add Call Out Card" to create one.</p>
                                                        <% }
                                                        cards.forEach(function(card, idx){ %>
                                                            <div class="callout-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span class="fw-semibold text-sm">Card #<%= idx + 1 %></span>
                                                                    <span class="badge bg-secondary">Template Card</span>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Heading: <span class="text-danger-600">*</span></label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 callout-heading"
                                                                        value="<%= card.heading %>" placeholder="e.g., Call Out 1" required>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Paragraph:</label>
                                                                    <textarea class="form-control border border-neutral-200 radius-8 callout-subheading" rows="5"
                                                                        placeholder="Enter subheading"><%= card.subheading || '' %></textarea>
                                                                </div>
                                                                <div>
                                                                    <label class="form-label text-sm">Link:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 callout-link"
                                                                        value="<%= card.link || '' %>" placeholder="e.g., /more">
                                                                </div>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                    <small class="text-muted">Cards are defined by the page template</small>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='tabs-section' ) { %>
                                            <div class="tabs-section-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Tabs:</label>
                                                    <div class="tabs-container">
                                                        <%
                                                        const tabs = section.tabsSection?.tabs || [];
                                                        if (tabs.length === 0) { %>
                                                            <p class="text-muted">No tabs found. Default 8 tabs will be created.</p>
                                                        <% }
                                                        tabs.forEach(function(tab, idx){ %>
                                                            <div class="tab-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span class="fw-semibold text-sm">Tab #<%= idx + 1 %></span>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Title:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-title"
                                                                        value="<%= tab.title || '' %>" placeholder="Tab Title">
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Heading:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-heading"
                                                                        value="<%= tab.heading || '' %>" placeholder="Tab Heading">
                                                                </div>
                                                                <div>
                                                                    <label class="form-label text-sm">Paragraph:</label>
                                                                    <textarea class="form-control border border-neutral-200 radius-8 tab-paragraph" rows="3"
                                                                        placeholder="Tab content"><%= tab.paragraph || '' %></textarea>
                                                                </div>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='left-heading-image-right-text' ) { %>""
                                            <div class="left-heading-image-right-text-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Left Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 lhrt-heading"
                                                        value="<%= section.customFields?.leftHeading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">Upload Left Image</label>
                                                    <div class="upload-image-wrapper">
                                                        <div
                                                            class="uploaded-img-lhrt <%= section.customFields?.image ? '' : 'd-none' %> position-relative w-30 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                                            <img class="uploaded-img-lhrt__preview w-100 h-100 object-fit-cover"
                                                                src="<%= section.customFields?.image || '/images/user.png' %>"
                                                                alt="image">
                                                        </div>
                                                        <label
                                                            class="upload-file-lhrt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                                            <iconify-icon icon="solar:camera-outline"
                                                                class="text-xl text-secondary-light"></iconify-icon>
                                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                                            <input type="file" class="upload-file-lhrt-input" hidden accept="image/*">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Right Text:</label>
                                                    <textarea class="form-control border border-neutral-200 radius-8 lhrt-right-text"
                                                        rows="4"
                                                        placeholder="Text"><%= section.customFields?.rightText || '' %></textarea>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="alert alert-warning">No sections found for this page. Add a new
                                section below.</div>
                        <% } %>
                    </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="page-status-widget">
                                <div>
                                    <label class="form-label" for="pageId">Select Page: <span class="text-danger-600">*</span></label>
                                    <select class="form-control border border-neutral-200 radius-8" id="pageId" name="pageId" required>
                                        <option value="">-- Select a Page --</option>
                                        <% if (typeof pages !=='undefined' && pages.length> 0) { %>
                                            <% pages.forEach(page=> { %>
                                                <option value="<%= page._id %>" <%=content.page && content.page._id.toString()===page._id.toString()
                                                    ? 'selected' : '' %>><%= page.name %>
                                                </option>
                                                <% }) %>
                                                    <% } %>
                                    </select>
                                </div>

                                <div>
                                    <label class="form-label">Status: </label>
                                    <select class="form-control border border-neutral-200 radius-8" id="status" name="status">
                                        <option value="inactive" <%=page.status=='inactive' ? 'selected' : '' %>>Draft</option>
                                        <option value="active" <%=page.status=='active' ? 'selected' : '' %>>Publish</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex publish-btns">
                                <a href="/page-master/edit-page/<%= page._id %>"
                                    class="border border-danger-600 bg-hover-danger-200 text-danger-600 text-md px-56 py-11 radius-8">
                                    Cancel
                                </a>
                                <button type="button" id="updateAndSeoBtn" class="btn btn-outline-primary border border-primary-600 text-md px-56 py-12 radius-8">
                                    Save & Manage SEO
                                </button>
                                <button type="submit" class="btn btn-primary border border-primary-600 text-md px-56 py-12 radius-8">
                                    Save Changes
                                </button>
                            </div>
                        </div>


                    </div>

                    <hr class="my-3">

                    <!-- Sections Container -->

                    <!-- commented out tyoes -->
                    <!--
                    in another file
                     -->


                    <!-- Template-based sections only - no manual section addition -->
                    <div class="alert alert-info text-center">
                        <small><strong>Note:</strong> This page uses a predefined template. To change the section structure, edit the page template in <a href="/page-master/web-page-master">Page Master</a>.</small>
                    </div>

                    <hr class="my-3">

                    <!-- Hidden: Section Block Template -->
                     <!--
                    // commeneted out types
                        /*
                        <option value="image-with-text">Image with Text</option>
                        <option value="image-with-list">Image with List</option>
                        <option value="heading-subheading">Heading with Subheading</option>
                        <option value="left-heading-image-right-text">Left Heading + Image, Right Text</option>
                        <option value="right-heading-image-left-text">Right Heading + Image, Left Text</option>
                        <option value="hero-section">Hero Section (Left Text + Right Image)</option>
                        */ -->
                    <div class="d-none">
                        <div id="originalSection">
                            <div class="section-block border border-neutral-300 radius-8 p-5 mb-4 bg-neutral-50" data-section-id="__ID__">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-lg mb-0">Section #__ID__</h6>
                                    <button type="button" class="btn btn-sm btn-danger-600 remove-section-btn">Remove Section</button>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Section Type: <span class="text-danger-600">*</span></label>
                                    <select class="form-control border border-neutral-200 radius-8 section-type-select" >
                                        <option value="">-- Please Select Section --</option>

                                        <option value="hero-section">Hero Section</option>
                                        <option value="three-column-info">Header Section</option>
                                        <option value="call-out-cards">Call Out Section</option>
                                        <option value="tabs-section">Tabs Section</option>
                                    </select>
                                </div>
                                <div class="image-with-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label">Paragraph:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwt-subheading" placeholder="Subheading"></div>
                                    <div class="mb-3"><label class="form-label">Text:</label><textarea class="form-control border border-neutral-200 radius-8 iwt-text" rows="4" placeholder="Description"></textarea></div>
                                    <div class="form-check mb-3"><input class="form-check-input iwt-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Image</label><div class="upload-image-wrapper"><div class="uploaded-img-iwt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-iwt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-iwt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-iwt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-iwt-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="image-with-list-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwl-heading" placeholder="Heading"></div>
                                    <div class="form-check mb-3"><input class="form-check-input iwl-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label">List Items:</label><div class="iwl-items"></div><button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-iwl-item-btn">Add Item</button></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Image</label><div class="upload-image-wrapper"><div class="uploaded-img-iwl d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-iwl__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-iwl__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-iwl h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-iwl-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="heading-subheading-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 hs-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label">Subheading:</label><input type="text" class="form-control border border-neutral-200 radius-8 hs-subheading" placeholder="Subheading"></div>
                                    <div class="form-check mb-3"><input class="form-check-input hs-center" type="checkbox" checked><label class="form-check-label">Center Align</label></div>
                                </div>
                                <div class="left-heading-image-right-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Left Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 lhrt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Left Image</label><div class="upload-image-wrapper"><div class="uploaded-img-lhrt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-lhrt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-lhrt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-lhrt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-lhrt-input" hidden accept="image/*"></label></div></div>
                                    <div class="mb-3"><label class="form-label">Right Text:</label><textarea class="form-control border border-neutral-200 radius-8 lhrt-right-text" rows="4" placeholder="Text"></textarea></div>
                                </div>
                                <div class="right-heading-image-left-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Right Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 rhlt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Right Image</label><div class="upload-image-wrapper"><div class="uploaded-img-rhlt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-rhlt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-rhlt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-rhlt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-rhlt-input" hidden accept="image/*"></label></div></div>
                                    <div class="mb-3"><label class="form-label">Left Text:</label><textarea class="form-control border border-neutral-200 radius-8 rhlt-left-text" rows="4" placeholder="Text"></textarea></div>
                                </div>
                                <div class="hero-section-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading: <span class="text-danger-600">*</span></label><input type="text" class="form-control border border-neutral-200 radius-8 hero-heading" placeholder="Enter main heading"></div>
                                    <div class="mb-3"><label class="form-label">Paragraph:</label><textarea class="form-control border border-neutral-200 radius-8 hero-paragraph" rows="4" placeholder="Description"></textarea></div>
                                    <div class="mb-3"><label class="form-label">Call To Action Buttons:</label><div class="cta-container"></div><button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-cta-btn">Add CTA Button</button></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Right Image</label><div class="upload-image-wrapper"><div class="uploaded-img-hero d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-hero__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-hero__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-hero h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-hero-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="three-column-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Section Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 tci-heading" placeholder="Main Heading"></div>
                                    <div class="mb-3"><label class="form-label">Section Sub-heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 tci-subheading" placeholder="Sub-heading"></div>
                                    <!-- <div class="form-check mb-3"><input class="form-check-input tci-image-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Section Image</label><div class="upload-image-wrapper"><div class="uploaded-img-tci d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-tci__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-tci__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-tci h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-tci-input" hidden accept="image/*"></label></div></div>  -->
                                    <div class="mb-3">
                                        <label class="form-label">Buttons:</label>
                                        <div class="column-container"></div>
                                        <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-column-btn">Add Button</button>
                                    </div>
                                </div>
                                <div class="call-out-cards-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Call Out Section:</label><div class="callout-container"></div><button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-callout-btn">Add Call Out Card</button><small class="text-muted d-block mt-1">Min: 1 card, Max: 6 cards</small></div>
                                </div>
                                <div class="tabs-section-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Tabs:</label><div class="tabs-container"></div><small class="text-muted d-block mt-1">8 tabs will be created automatically</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>


            </form>
        </div>
    </div>
</div>
</div>

<% script=` <script>

    // Centralized function to toggle the visibility of section fields
    function toggleSectionFields($section) {
        const sectionType = $section.find(".section-type-select").val();

        // Hide all fields first
        $section.find('.image-with-text-fields').hide();
        $section.find('.image-with-list-fields').hide();
        $section.find('.heading-subheading-fields').hide();
        $section.find('.left-heading-image-right-text-fields').hide();
        $section.find('.right-heading-image-left-text-fields').hide();
        $section.find('.hero-section-fields').hide();
        $section.find('.three-column-fields').hide();
        $section.find('.call-out-cards-fields').hide();
        $section.find('.tabs-section-fields').hide();

        // Show only the relevant fields based on section type
        if (sectionType === 'image-with-text') {
            $section.find('.image-with-text-fields').show();
        } else if (sectionType === 'image-with-list') {
            $section.find('.image-with-list-fields').show();
        } else if (sectionType === 'heading-subheading') {
            $section.find('.heading-subheading-fields').show();
        } else if (sectionType === 'left-heading-image-right-text') {
            $section.find('.left-heading-image-right-text-fields').show();
        } else if (sectionType === 'right-heading-image-left-text') {
            $section.find('.right-heading-image-left-text-fields').show();
        } else if (sectionType === 'hero-section') {
            $section.find('.hero-section-fields').show();
        } else if (sectionType === 'three-column-info') {
            $section.find('.three-column-fields').show();
        } else if (sectionType === 'call-out-cards') {
            $section.find('.call-out-cards-fields').show();
        } else if (sectionType === 'tabs-section') {
            $section.find('.tabs-section-fields').show();
            // Auto-create 8 tabs if none exist
            const $tabsContainer = $section.find('.tabs-container');
            if ($tabsContainer.find('.tab-item').length === 0) {
                for (let i = 1; i <= 8; i++) {
                    const tabHtml = \`
                        <div class="tab-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold text-sm">Tab #\${i}</span>
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-sm">Title:</label>
                                <input type="text" class="form-control border border-neutral-200 radius-8 tab-title" placeholder="Tab Title">
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-sm">Heading:</label>
                                <input type="text" class="form-control border border-neutral-200 radius-8 tab-heading" placeholder="Tab Heading">
                            </div>
                            <div>
                                <label class="form-label text-sm">Paragraph:</label>
                                <textarea class="form-control border border-neutral-200 radius-8 tab-paragraph" rows="3" placeholder="Tab content"></textarea>
                            </div>
                        </div>\`;
                    $tabsContainer.append(tabHtml);
                }
            }
        }
    }

    // Template sections have fixed structure - no dynamic item management

    // Generic image upload handler to keep code DRY
    function handleImageUpload(inputSelector, previewSelector, removeSelector, wrapperSelector, folderName) {
        $(document).on("change", inputSelector, function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $wrapper = $(this).closest(wrapperSelector);
                const $preview = $wrapper.find(previewSelector);
                const $remove = $wrapper.find(removeSelector);
                const $input = $(this);

                // Use FileReader for a robust preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $preview.attr("src", event.target.result).show();
                    $remove.show();
                    $input.hide(); // Hide the input label
                };
                reader.readAsDataURL(file);

                // AJAX upload
                const formData = new FormData();
                // append folder first so multer's destination sees it when processing the file
                formData.append("folder", folderName);
                formData.append("file", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            // Store the URL in a data attribute for submission
                            $input.data("server-url", response.url);
                            console.log("server-url", response);

                            showToast("Image uploaded successfully", "success");
                        } else {
                            showToast(response.message || "Image upload failed", "error");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred", "error");
                    }
                });
            }
        });

        // Handle image removal
        $(document).on("click", removeSelector, function () {
            const $wrapper = $(this).closest(wrapperSelector);
            $wrapper.find(previewSelector).attr("src", "").hide();
            $(this).hide();
            $wrapper.find(inputSelector).val("").data("server-url", "").show(); // Clear input and data
        });
    }

    // Template sections are fixed - no dynamic section management needed

    // Main document ready function
    $(document).ready(function () {
        // Initialize existing sections (only real sections inside the container)
        $("#sectionsContainer .section-block").each(function () {
            toggleSectionFields($(this));
        });

        // Template sections are read-only - prevent structure changes
        $("#sectionsContainer").on("change", ".section-type-select", function () {
            showToast('Section types are fixed by the page template. Change the template in Page Master to modify structure.', 'warning');
            // Revert to original value
            const originalType = $(this).closest('.section-block').find('.original-section-type').val();
            $(this).val(originalType);
        });

        // Initialize all image upload handlers
        handleImageUpload(".upload-file-iwt-input", ".uploaded-img-iwt__preview", ".uploaded-img-iwt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-iwl-input", ".uploaded-img-iwl__preview", ".uploaded-img-iwl__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-lhrt-input", ".uploaded-img-lhrt__preview", ".uploaded-img-lhrt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-rhlt-input", ".uploaded-img-rhlt__preview", ".uploaded-img-rhlt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-hero-input", ".uploaded-img-hero__preview", ".uploaded-img-hero__remove", ".upload-image-wrapper", "hero");

        // Three Column Info image handler with proper show/hide logic
        $(document).on("change", ".upload-file-tci-input", function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $section = $(this).closest(".section-block");
                const $wrapper = $(this).closest(".upload-image-wrapper");
                const $input = $(this);

                // Show preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $wrapper.find(".uploaded-img-tci__preview").attr("src", event.target.result);
                    $wrapper.find(".uploaded-img-tci").removeClass("d-none");
                    $wrapper.find(".upload-file-tci").hide();
                };
                reader.readAsDataURL(file);

                // Upload to server
                const formData = new FormData();
                formData.append("folder", "section");
                formData.append("file", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            $input.data("server-url", response.url);
                            showToast("Image uploaded successfully", "success");
                        } else {
                            showToast(response.message || "Image upload failed", "error");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred", "error");
                    }
                });
            }
        });

        // Three Column Info image remove handler
        $(document).on("click", ".uploaded-img-tci__remove", function () {
            const $wrapper = $(this).closest(".upload-image-wrapper");
            $wrapper.find(".uploaded-img-tci__preview").attr("src", "");
            $wrapper.find(".uploaded-img-tci").addClass("d-none");
            $wrapper.find(".upload-file-tci").show();
            $wrapper.find(".upload-file-tci-input").val("").data("server-url", "");
        });

        // Form submission logic
        $("#editContentForm").on("submit", function (e) {
            e.preventDefault();

            const contentId = $("#contentId").val();
            const pageId = $("#pageId").val();
            const status = $("#status").val();

            if (!pageId) {
                showToast("Please select a page.", "warning");
                return;
            }

            const sectionsData = [];
            let isValid = true;

            $("#sectionsContainer .section-block").each(function (index) {
                const $section = $(this);
                // For template-based pages, get from original value if select is disabled
                let sectionType = $section.find(".section-type-select").val();
                if (!sectionType || $section.find(".section-type-select").is(':disabled')) {
                    sectionType = $section.find(".original-section-type").val();
                }

                if (!sectionType) {
                    showToast("Please select a section type for all sections.", "warning");
                    isValid = false;
                    return false; // Break the loop
                }

                const sectionData = {
                    id: $section.data("id"), // Keep track of the section
                    order: index + 1,
                    sectionType: sectionType,
                    customFields: {},
                    heroSection: {},
                    threeColumnInfo: {}
                };

                // Populate data based on section type
                if (sectionType === "image-with-text") {
                    sectionData.customFields.heading = $section.find(".iwt-heading").val();
                    sectionData.customFields.subheading = $section.find(".iwt-subheading").val();
                    sectionData.customFields.richText = $section.find(".iwt-text").val();
                    sectionData.customFields.image = $section.find(".upload-file-iwt-input").data("server-url") || $section.find(".uploaded-img-iwt__preview").attr("src");
                } else if (sectionType === "image-with-list") {
                    sectionData.customFields.heading = $section.find(".iwl-heading").val();
                    sectionData.customFields.items = $section.find(".iwl-item-input").map(function () {
                        return $(this).val();
                    }).get();
                    sectionData.customFields.image = $section.find(".upload-file-iwl-input").data("server-url") || $section.find(".uploaded-img-iwl__preview").attr("src");
                } else if (sectionType === "heading-subheading") {
                    sectionData.customFields.heading = $section.find(".hs-heading").val();
                    sectionData.customFields.subheading = $section.find(".hs-subheading").val();
                    sectionData.customFields.alignCenter = $section.find(".hs-center").is(":checked");
                } else if (sectionType === "hero-section") {
                    const ctas = [];
                    $section.find(".cta-item").each(function () {
                        const text = $(this).find(".cta-text").val();
                        const link = $(this).find(".cta-link").val();
                        const style = $(this).find(".cta-style").val();
                        if (text && link) {
                            ctas.push({ text, link, style });
                        }
                    });
                    sectionData.heroSection.heading = $section.find(".hero-heading").val();
                    sectionData.heroSection.paragraph = $section.find(".hero-paragraph").val();
                    sectionData.heroSection.rightImage = $section.find(".upload-file-hero-input").data("server-url") || $section.find(".uploaded-img-hero__preview").attr("src");
                    sectionData.heroSection.ctas = ctas;
                } else if (sectionType === "left-heading-image-right-text") {
                    // Left heading + image on left, right text
                    sectionData.customFields.leftHeading = $section.find('.lhrt-heading').val();
                    sectionData.customFields.leftImage = $section.find('.upload-file-lhrt-input').data('server-url') || $section.find('.uploaded-img-lhrt__preview').attr('src');
                    sectionData.customFields.rightText = $section.find('.lhrt-right-text').val();
                } else if (sectionType === "right-heading-image-left-text") {
                    // Right heading + image on right, left text
                    sectionData.customFields.rightHeading = $section.find('.rhlt-heading').val();
                    sectionData.customFields.rightImage = $section.find('.upload-file-rhlt-input').data('server-url') || $section.find('.uploaded-img-rhlt__preview').attr('src');
                    sectionData.customFields.leftText = $section.find('.rhlt-left-text').val();
                } else if (sectionType === "three-column-info") {
                    const $tciInput = $section.find(".upload-file-tci-input");
                    const newImageUrl = $tciInput.data("server-url");
                    const existingImageUrl = $tciInput.data("existing-image");
                    const heading = $section.find(".tci-heading").val();
                    const subheading = $section.find(".tci-subheading").val();
                    const imageUrl = newImageUrl || existingImageUrl || "";

                    sectionData.title = heading || "Three Column Info";
                    sectionData.thumbnail = imageUrl;
                    sectionData.threeColumnInfo.heading = heading;
                    sectionData.threeColumnInfo.subheading = subheading;
                    sectionData.threeColumnInfo.imageOnLeft = $section.find(".tci-image-left").is(":checked");
                    sectionData.threeColumnInfo.image = imageUrl;
                    sectionData.threeColumnInfo.columns = $section.find(".column-item").map(function () {
                        return {
                            title: $(this).find(".column-title").val(),
                            description: $(this).find(".column-description").val(),
                            buttonText: $(this).find(".column-btn-text").val(),
                            buttonLink: $(this).find(".column-btn-link").val()
                        };
                    }).get();
                } else if (sectionType === "call-out-cards") {
                    const cards = $section.find(".callout-item").map(function () {
                        return {
                            heading: $(this).find(".callout-heading").val(),
                            subheading: $(this).find(".callout-subheading").val(),
                            link: $(this).find(".callout-link").val()
                        };
                    }).get();

                    if (cards.length === 0) {
                        showToast('Please add at least one call out card', 'warning');
                        isValid = false;
                        return false;
                    }

                    if (cards.length > 6) {
                        showToast('Maximum 6 Call Out Section allowed', 'warning');
                        isValid = false;
                        return false;
                    }

                    // Check if all cards have headings
                    const invalidCard = cards.find(card => !card.heading);
                    if (invalidCard) {
                        showToast('All Call Out Section must have a heading', 'warning');
                        isValid = false;
                        return false;
                    }

                    sectionData.title = cards[0].heading || "Call Out Section";
                    sectionData.callOutCards = { cards: cards };
                } else if (sectionType === "tabs-section") {
                    const tabs = $section.find(".tab-item").map(function () {
                        return {
                            title: $(this).find(".tab-title").val(),
                            heading: $(this).find(".tab-heading").val(),
                            paragraph: $(this).find(".tab-paragraph").val()
                        };
                    }).get();

                    sectionData.title = "Tabs Section";
                    sectionData.tabsSection = { tabs: tabs };
                }

                sectionsData.push(sectionData);
            });

            if (!isValid) return;

            // Consolidate all data into one payload
            const payload = {
                pageId: pageId,
                status: status,
                sections: sectionsData
            };

            // Single AJAX call to update everything
            $.ajax({
                url: \`/api/content/\${contentId}\`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.success) {
                        showToast("Content updated successfully!", "success");
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = "/page-master/web-page-master";
                        }, 1000);
                    } else {
                        showToast(response.message || "An error occurred.", "error");
                    }
                },
                error: function (xhr) {
                    showToast(xhr.responseJSON?.message || "An error occurred.", "error");
                }
            });
        });

        // Handle "Update & Manage SEO" button
        $("#updateAndSeoBtn").on("click", function(e) {
            e.preventDefault();

            // First update the content, then redirect to SEO management
            const contentId = $("#contentId").val();
            const pageId = $("#pageId").val();
            const status = $("#status").val();

            if (!pageId) {
                showToast("Please select a page.", "warning");
                return;
            }

            const sectionsData = [];
            let isValid = true;

            // Same validation and data collection as the main form
            $("#sectionsContainer .section-block").each(function (index) {
                const $section = $(this);
                // For template-based pages, get from original value if select is disabled
                let sectionType = $section.find(".section-type-select").val();
                if (!sectionType || $section.find(".section-type-select").is(':disabled')) {
                    sectionType = $section.find(".original-section-type").val();
                }

                if (!sectionType) {
                    showToast("Please select a section type for all sections.", "warning");
                    isValid = false;
                    return false;
                }

                const sectionData = {
                    id: $section.data("id"),
                    order: index + 1,
                    sectionType: sectionType,
                    customFields: {},
                    heroSection: {},
                    threeColumnInfo: {}
                };

                // Same data population logic as main form (abbreviated for brevity)
                if (sectionType === "hero-section") {
                    const ctas = [];
                    $section.find(".cta-item").each(function () {
                        const text = $(this).find(".cta-text").val();
                        const link = $(this).find(".cta-link").val();
                        const style = $(this).find(".cta-style").val();
                        if (text && link) {
                            ctas.push({ text, link, style });
                        }
                    });
                    sectionData.heroSection.heading = $section.find(".hero-heading").val();
                    sectionData.heroSection.paragraph = $section.find(".hero-paragraph").val();
                    sectionData.heroSection.rightImage = $section.find(".upload-file-hero-input").data("server-url") || $section.find(".uploaded-img-hero__preview").attr("src");
                    sectionData.heroSection.ctas = ctas;
                } else if (sectionType === "three-column-info") {
                    const heading = $section.find(".tci-heading").val();
                    const subheading = $section.find(".tci-subheading").val();
                    sectionData.title = heading || "Three Column Info";
                    sectionData.threeColumnInfo.heading = heading;
                    sectionData.threeColumnInfo.subheading = subheading;
                    sectionData.threeColumnInfo.columns = $section.find(".column-item").map(function () {
                        return {
                            title: $(this).find(".column-title").val(),
                            description: $(this).find(".column-description").val(),
                            buttonText: $(this).find(".column-btn-text").val(),
                            buttonLink: $(this).find(".column-btn-link").val()
                        };
                    }).get();
                } else if (sectionType === "call-out-cards") {
                    const cards = $section.find(".callout-item").map(function () {
                        return {
                            heading: $(this).find(".callout-heading").val(),
                            subheading: $(this).find(".callout-subheading").val(),
                            link: $(this).find(".callout-link").val()
                        };
                    }).get();

                    if (cards.length === 0) {
                        showToast('Please add at least one call out card', 'warning');
                        isValid = false;
                        return false;
                    }

                    const invalidCard = cards.find(card => !card.heading);
                    if (invalidCard) {
                        showToast('All Call Out Section must have a heading', 'warning');
                        isValid = false;
                        return false;
                    }

                    sectionData.title = cards[0].heading || "Call Out Section";
                    sectionData.callOutCards = { cards: cards };
                } else if (sectionType === "tabs-section") {
                    const tabs = $section.find(".tab-item").map(function () {
                        return {
                            title: $(this).find(".tab-title").val(),
                            heading: $(this).find(".tab-heading").val(),
                            paragraph: $(this).find(".tab-paragraph").val()
                        };
                    }).get();

                    sectionData.title = "Tabs Section";
                    sectionData.tabsSection = { tabs: tabs };
                }

                sectionsData.push(sectionData);
            });

            if (!isValid) {
                return;
            }

            // Update content first, then redirect to SEO
            const payload = {
                pageId: pageId,
                status: status,
                sections: sectionsData
            };

            $.ajax({
                url: \`/api/content/\${contentId}\`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.success) {
                        showToast("Content updated successfully! Redirecting to SEO management...", "success");
                        setTimeout(() => {
                            // Check if SEO exists for this page via API, then redirect appropriately
                            $.ajax({
                                url: \`/api/seo/check-page/\${pageId}\`,
                                type: 'GET',
                                success: function(seoResponse) {
                                    if (seoResponse.success && seoResponse.seoExists) {
                                        // SEO exists, go to edit
                                        window.location.href = \`/seo/edit-seo-content/\${seoResponse.seoId}?from=content\`;
                                    } else {
                                        // No SEO, go to add with page pre-selected
                                        window.location.href = \`/seo/add-seo-content?pageId=\${pageId}&from=content\`;
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error("SEO check failed:", error);
                                    // Fallback to SEO management page
                                    window.location.href = '/seo/seo-management';
                                }
                            });
                        }, 1000);
                    } else {
                        showToast(response.message || "An error occurred.", "error");
                    }
                },
                error: function (xhr) {
                    console.error("Content update failed:", xhr.responseJSON?.message || xhr.statusText);
                    showToast(xhr.responseJSON?.message || "An error occurred.", "error");
                }
            });
        });
    });
    $(document).on('input', '.callout-link,.column-btn-link,.cta-link', function() {
        const $input = $(this);
        const query = $input.val().trim();

        if (query.length < 2) {
            $input.next('.autocomplete-list').remove();
            return;
        }

        $.ajax({
            url: '/api/pages/all-pages/search',
            data: { q: query },
            success: function(pages) {
            $input.next('.autocomplete-list').remove();

            if (!pages || pages.length === 0) return;

            const $list = $('<div class="autocomplete-list border bg-white position-absolute w-100 radius-8 shadow-sm mt-1 z-1"></div>');

            pages.forEach(page => {
                const $item = $(\`
                <div class="autocomplete-item p-2 text-sm cursor-pointer hover:bg-neutral-100">
                    $\{page.name} <small class="text-muted">($\{page.slug})</small>
                </div>
                \`);
                const baseUrl = window.location.origin;

                $item.on('click', function() {
                $input.val(page.slug);
                $input.val(\`$\{baseUrl}/$\{page.slug}\`);
                $list.remove();
                });

                $list.append($item);
            });

            $input.after($list);
            },
            error: function(err) {
            console.error('Autocomplete error:', err);
            }
        });
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest('.callout-link, .column-btn-link, .cta-link, .autocomplete-list').length) {
            $('.autocomplete-list').remove();
        }
    });

    // CTA Button Handlers
    $(document).on('click', '.add-cta-btn', function() {
        
        const $container = $(this).siblings('.cta-container');
        const ctaCount = $container.find('.cta-item').length;
        
        if (ctaCount >= 3) {
            $(this).attr("disabled", true);
            showToast('Maximum 3 CTA buttons allowed', 'warning');
            return;
        }
        
        const ctaHtml = \`
            <div class="cta-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold text-sm">CTA Button #\${ctaCount + 1}</span>
                    <button type="button" class="btn btn-sm btn-danger-600 remove-cta-btn">Remove</button>
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Button Text:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 cta-text"
                        placeholder="e.g., Learn More">
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Button Link:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 cta-link"
                        placeholder="e.g., /about">
                </div>
            </div>
        \`;
        
        $container.append(ctaHtml);
        updateCtaNumbers($container);
    });

    $(document).on('click', '.remove-cta-btn', function() {
        const $container = $(this).closest('.cta-container');
        $(this).closest('.cta-item').remove();
        updateCtaNumbers($container);
    });

    function updateCtaNumbers($container) {
        $container.find('.cta-item').each(function(index) {
            $(this).find('.fw-semibold').text(\`CTA Button #\${index + 1}\`);
        });
    }
    </script>
    ` %>