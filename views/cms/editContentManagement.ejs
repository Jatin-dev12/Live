<div class="row gy-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header border-bottom">
                <h6 class="text-xl mb-0">Manage Content > <%= page.name %></h6>
                <input type="hidden" name="pageTemplate" id="pageTemplate" value="<%= page.template %>">
            </div>
            <div class="card-body p-24">
                <form id="editContentForm" class="d-flex flex-column gap-20">
                    <input type="hidden" id="contentId" value="<%= content._id %>">
                    <div class="row">
                        <div class="col-lg-8">
                            <div id="sectionsContainer">
                        <% if (allSections && allSections.length> 0) { %>
                            <% allSections.forEach(function(section, index) { %>
                                <div class="section-block border border-neutral-300 radius-8 p-5 bg-neutral-50 mb-4"
                                    data-id="<%= section._id %>">
                                  
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        
                                        <span class="badge bg-primary-600">Template Section</span>
                                    </div>
                                    <div class="mb-3">
                                        <input type="hidden" class="original-section-type"
                                            value="<%= section.sectionType %>">
                                        <!-- <label class="form-label">Section Type: <span -->
                                                <!-- class="text-danger-600">*</span></label> -->
                                        <select class="form-control border border-neutral-200 radius-8 section-type section-type-select"
                                            disabled>
                                            <option value="" <%= !section.sectionType ? 'selected' : '' %>>-- Please Select Section --</option>

                                            <option value="hero-section" <%= section.sectionType === 'hero-section' ? 'selected' : '' %>>Hero Section</option>
                                            <option value="three-column-info" <%= section.sectionType === 'three-column-info' ? 'selected' : '' %>>Header Section</option>
                                            <option value="call-out-cards" <%= section.sectionType === 'call-out-cards' ? 'selected' : '' %>>Call Out Section</option>
                                            <option value="tabs-section" <%= section.sectionType === 'tabs-section' ? 'selected' : '' %>>Tabs Section</option>
                                            <option value="community-groups" <%= section.sectionType === 'community-groups' ? 'selected' : '' %>>Community Groups</option>
                                        </select>
                                    </div>

                                    <!-- server-side renders active fields; per-block JS removed -->

                                    <!-- Dynamic fields based on section type -->
                                    <div class="section-fields asdf">
                                        <!-- <pre><%= JSON.stringify(section, null, 2) %></pre> -->
                                        <% if (section.sectionType==='image-with-text' ) { %>
                                            <div class="image-with-text-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwt-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Subheading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwt-subheading"
                                                        value="<%= section.customFields?.subheading || '' %>"
                                                        placeholder="Subheading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Text:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 iwt-text"
                                                        rows="4"
                                                        placeholder="Description"><%= section.customFields?.richText || '' %></textarea>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='image-with-list' ) { %>
                                            <div class="image-with-list-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwl-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">List Items:</label>
                                                    <div class="iwl-items">
                                                        <% (section.customFields?.items || []).forEach(function(it){
                                                            %>
                                                            <div
                                                                class="iwl-item d-flex align-items-center gap-2 mb-2">
                                                                <input type="text"
                                                                    class="form-control border border-neutral-200 radius-8 iwl-item-input"
                                                                    value="<%= it %>">
                                                                <button type="button"
                                                                    class="btn btn-sm btn-danger-600 remove-iwl-item"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                                                            </div>
                                                            <% }) %>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='heading-subheading' ) { %>
                                            <div class="heading-subheading-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hs-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Subheading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hs-subheading"
                                                        value="<%= section.customFields?.subheading || '' %>"
                                                        placeholder="Subheading">
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input hs-center" type="checkbox"
                                                        <%=section.customFields?.alignCenter ? 'checked' : ''
                                                        %>>
                                                    <label class="form-check-label">Center Align</label>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='hero-section' ) { %>
                                            <div class="hero-section-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hero-heading"
                                                        value="<%= section.heroSection?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Paragraph:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 hero-paragraph ckeditor-paragraph"
                                                        rows="4"
                                                        placeholder="Paragraph"><%= section.heroSection?.paragraph || '' %></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Call To Action Buttons:</label>
                                                    <!-- Debug CTAs: <%= JSON.stringify(section.heroSection?.ctas) %> -->
                                                    <div class="cta-container">
                                                        <% if (section.heroSection?.ctas && section.heroSection.ctas.length > 0) { %>
                                                            <% section.heroSection.ctas.forEach(function(cta, index) { %>
                                                                <div class="cta-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                                        <span class="fw-semibold text-sm">CTA Button #<%= index + 1 %></span>
                                                                        <button type="button" class="btn btn-sm btn-danger-600 remove-cta-btn"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label class="form-label text-sm">Button Text:</label>
                                                                        <input type="text" class="form-control border border-neutral-200 radius-8 cta-text"
                                                                            value="<%= cta.text || '' %>" placeholder="e.g., Learn More">
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label class="form-label text-sm">Button Link:</label>
                                                                        <input type="text" class="form-control border border-neutral-200 radius-8 cta-link"
                                                                            value="<%= cta.link || '' %>" placeholder="e.g., /about">
                                                                    </div>
                                                                  
                                                                </div>
                                                            <% }) %>
                                                        <% } %>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-cta-btn">Add CTA Button</button>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">Hero Image</label>
                                                    <% if (section.heroSection?.image) { %>
                                                        <div class="mb-2">
                                                            <label class="form-label text-sm">Current Image:</label>
                                                            <div class="existing-image mb-2">
                                                                <img src="<%= section.heroSection.image %>"
                                                                    class="img-thumbnail"
                                                                    style="max-height: 200px; max-width: 100%; object-fit: cover;">
                                                            </div>
                                                        </div>
                                                    <% } %>
                                                    <div class="upload-image-wrapper">
                                                        <div class="uploaded-img-hero d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                                            <button type="button" class="uploaded-img-hero__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                                                <iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon>
                                                            </button>
                                                            <img class="uploaded-img-hero__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image">
                                                        </div>
                                                        <label class="upload-file-hero h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1 cursor-pointer">
                                                            <iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon>
                                                            <span class="fw-semibold text-secondary-light">Upload New Hero Image</span>
                                                            <input type="file" class="upload-file-hero-input" hidden accept="image/*" data-existing-image="<%= section.heroSection?.image || '' %>">
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='three-column-info' ) { %>
                                            <!-- <pre><%= JSON.stringify(section) %></pre> -->
                                            <!-- <pre><%= JSON.stringify(section.threeColumnInfo.heading) %></pre> -->
                                            <div class="three-column-info-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Section Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 tci-heading"
                                                        value="<%= section.threeColumnInfo?.heading || '' %>"
                                                        placeholder="Main Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Section Sub-heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 tci-subheading"
                                                        value="<%= section.threeColumnInfo?.subheading || '' %>"
                                                        placeholder="Sub-heading">
                                                </div>
                                                <!-- <div class="form-check mb-3">
                                                    <input class="form-check-input tci-image-left" type="checkbox"
                                                        <%=section.threeColumnInfo?.imageOnLeft ? 'checked' : '' %>>
                                                    <label class="form-check-label">Image on Left</label>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">Upload Section Image</label>
                                                    <div class="upload-image-wrapper">
                                                        <% if (section.threeColumnInfo?.image) { %>
                                                            <div class="mb-3">
                                                                <label class="form-label">Current Image:</label>
                                                                <div class="existing-image">
                                                                    <img src="<%= section.threeColumnInfo.image %>"
                                                                        class="img-thumbnail"
                                                                        style="max-height: 200px;">
                                                                </div>
                                                            </div>
                                                        <% } %>
                                                        <div
                                                            class="uploaded-img-tci d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                                            <button type="button" class="uploaded-img-tci__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                                                <iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon>
                                                            </button>
                                                            <img class="uploaded-img-tci__preview w-100 h-100 object-fit-cover"
                                                                src="/images/user.png"
                                                                alt="image">
                                                        </div>
                                                        <label
                                                            class="upload-file-tci h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                                            <iconify-icon icon="solar:camera-outline"
                                                                class="text-xl text-secondary-light"></iconify-icon>
                                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                                            <input type="file" class="upload-file-tci-input" hidden accept="image/*" data-existing-image="<%= section.threeColumnInfo?.image || '' %>">
                                                        </label>
                                                    </div>
                                                </div> -->
                                                <div class="mb-3">
                                                    <label class="form-label">Buttons:</label>
                                                    <div class="column-container">

                                                        <% (section.threeColumnInfo?.columns ||
                                                            []).forEach(function(col, idx){ %>
                                                            <div
                                                                class="column-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div
                                                                    class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span
                                                                        class="fw-semibold text-sm">Button
                                                                        #<%= idx + 1 %></span>
                                                                    <span class="badge bg-secondary">Template Button</span>
                                                                </div>
                                                                <!-- <div class="mb-2"><label
                                                                        class="form-label text-sm">Title:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-title"
                                                                        value="<%= col.title %>"
                                                                        placeholder="e.g., Call Out 1">
                                                                </div>
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Description:</label>
                                                                    <textarea
                                                                        class="form-control border border-neutral-200 radius-8 column-description"
                                                                        rows="3"
                                                                        placeholder="Enter description"><%= col.description %></textarea>
                                                                </div> -->
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Button
                                                                        Text:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-btn-text"
                                                                        value="<%= col.buttonText %>"
                                                                        placeholder="e.g., More">
                                                                </div>
                                                                <div><label
                                                                        class="form-label text-sm">Button
                                                                        Link:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-btn-link"
                                                                        value="<%= col.buttonLink %>"
                                                                        placeholder="e.g., /learn-more">
                                                                </div>
                                                            </div>
                                                        <% }) %>


                                                    </div>
                                                    <small class="text-muted">Buttons are defined by the page template</small>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='call-out-cards' ) { %>
                                            <div class="call-out-cards-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Card Carousels:</label>
                                                    <!-- Debug: <%= JSON.stringify(section.callOutCards) %> -->
                                                    <div class="callout-container">
                                                        <%
                                                        const cards = section.callOutCards?.cards || [];
                                                        if (cards.length === 0) { %>
                                                            <p class="text-muted">No cards found. Click "Add Call Out Card" to create one.</p>
                                                        <% }
                                                        cards.forEach(function(card, idx){ %>
                                                            <div class="callout-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <span class="fw-semibold text-sm">Card #<%= idx + 1 %></span>
                                                                        <span class="badge bg-secondary">Template Card</span>
                                                                    </div>
                                                                    <% if(page.template != 'legislation'){ %>
                                                                    <button type="button" class="btn btn-sm btn-danger-600 remove-callout-btn">
                                                                        <iconify-icon icon="material-symbols:delete-outline"></iconify-icon>
                                                                    </button>
                                                                    <% } %>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Heading: <span class="text-danger-600">*</span></label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 callout-heading"
                                                                        value="<%= card.heading %>" placeholder="e.g., Call Out 1" required>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Paragraph:</label>
                                                                    <textarea class="form-control border border-neutral-200 radius-8 callout-subheading" rows="5"
                                                                        placeholder="Enter subheading"><%= card.subheading || '' %></textarea>
                                                                </div>
                                                                <div>
                                                                    <label class="form-label text-sm">Link:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 callout-link"
                                                                        value="<%= card.link || '' %>" placeholder="e.g., /more">
                                                                </div>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                    <% if(page.template != 'legislation'){ %>
                                                    
                                                    <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-callout-btn">
                                                        Add Call Out Card
                                                    </button>
                                                    <small class="text-muted d-block mt-1">Max: 6 cards</small>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='tabs-section' ) { %>
                                            <div class="tabs-section-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Tabs:</label>
                                                    <div class="tabs-container">
                                                        <%
                                                        const tabs = section.tabsSection?.tabs || [];
                                                        if (tabs.length === 0) { %>
                                                            <p class="text-muted">No tabs found. Click "Add Tab" to create one.</p>
                                                        <% }
                                                        tabs.forEach(function(tab, idx){ %>
                                                            <div class="tab-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span class="fw-semibold text-sm">Tab #<%= idx + 1 %></span>
                                                                    <button type="button" class="btn btn-sm btn-danger-600 remove-tab-btn"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Title:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-title"
                                                                        value="<%= tab.title || '' %>" placeholder="Tab Title">
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Heading:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-heading"
                                                                        value="<%= tab.heading || '' %>" placeholder="Tab Heading">
                                                                </div>
                                                                <div>
                                                                    <label class="form-label text-sm">Paragraph:</label>
                                                                    <textarea class="form-control border border-neutral-200 radius-8 tab-paragraph" rows="3"
                                                                        placeholder="Tab content"><%= tab.paragraph || '' %></textarea>
                                                                </div>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-tab-btn">Add Tab</button>
                                                    <small class="text-muted d-block mt-1">You can add or remove tabs as needed</small>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='community-groups' ) { %>
                                            <div class="community-groups-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Section Heading:</label>
                                                    <input type="text" class="form-control border border-neutral-200 radius-8 cg-heading"
                                                        value="<%= section.communityGroups?.heading || '' %>" placeholder="Community Groups">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Section Subheading:</label>
                                                    <input type="text" class="form-control border border-neutral-200 radius-8 cg-subheading"
                                                        value="<%= section.communityGroups?.subheading || '' %>" placeholder="Explore our community groups">
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">Display Order:</label>
                                                    <select class="form-control border border-neutral-200 radius-8 cg-display-order">
                                                        <option value="manual" <%= (section.communityGroups?.displayOrder || 'manual') === 'manual' ? 'selected' : '' %>>Manual Order</option>
                                                        <option value="alphabetical" <%= section.communityGroups?.displayOrder === 'alphabetical' ? 'selected' : '' %>>Alphabetical</option>
                                                        <option value="date" <%= section.communityGroups?.displayOrder === 'date' ? 'selected' : '' %>>Date Created</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Selected Pages:</label>
                                                    <div class="community-pages-container">
                                                        <div id="available-pages" class="mb-3">
                                                            <label class="form-label text-sm">Available Pages:</label>
                                                            <div class="available-pages-list border border-neutral-200 radius-8 p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                                                <p class="text-muted text-sm">Loading pages...</p>
                                                            </div>
                                                        </div>
                                                        <div id="selected-pages" class="mb-3">
                                                            <label class="form-label text-sm">Selected Pages (drag to reorder):</label>
                                                            <div class="selected-pages-list border border-neutral-200 radius-8 p-3 sortable-container" style="min-height: 100px;
                                                                <% if (section.communityGroups?.selectedPages && section.communityGroups.selectedPages.length > 0) { %>
                                                                    <% section.communityGroups.selectedPages.forEach(function(selectedPage, idx) { %>
                                                                        <div class="selected-page-item border border-neutral-300 radius-4 p-2 mb-2 bg-white d-flex justify-content-between align-items-center" data-page-id="<%= selectedPage.page._id %>" data-order="<%= selectedPage.order %>">
                                                                            <span class="page-name"><%= selectedPage.page.name %></span>
                                                                            <button type="button" class="btn btn-sm btn-danger remove-page-btn">Remove</button>
                                                                        </div>
                                                                    <% }) %>
                                                                <% } else { %>
                                                                    <p class="text-muted text-sm">No pages selected. Click on available pages to add them.</p>
                                                                <% } %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">Select pages to display in this community groups section</small>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='left-heading-image-right-text' ) { %>
                                            <div class="left-heading-image-right-text-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Left Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 lhrt-heading"
                                                        value="<%= section.customFields?.leftHeading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">Upload Left Image</label>
                                                    <div class="upload-image-wrapper">
                                                        <div
                                                            class="uploaded-img-lhrt <%= section.customFields?.image ? '' : 'd-none' %> position-relative w-30 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                                            <img class="uploaded-img-lhrt__preview w-100 h-100 object-fit-cover"
                                                                src="<%= section.customFields?.image || '/images/user.png' %>"
                                                                alt="image">
                                                        </div>
                                                        <label
                                                            class="upload-file-lhrt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                                            <iconify-icon icon="solar:camera-outline"
                                                                class="text-xl text-secondary-light"></iconify-icon>
                                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                                            <input type="file" class="upload-file-lhrt-input" hidden accept="image/*">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Right Text:</label>
                                                    <textarea class="form-control border border-neutral-200 radius-8 lhrt-right-text"
                                                        rows="4"
                                                        placeholder="Text"><%= section.customFields?.rightText || '' %></textarea>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="alert alert-warning">No sections found for this page. Add a new
                                section below.</div>
                        <% } %>
                    </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="page-status-widget">
                                <!-- <div>
                                    <label class="form-label" for="pageId">Select Page: <span class="text-danger-600">*</span></label>
                                    <select class="form-control border border-neutral-200 radius-8" id="pageId" name="pageId" required disabled>
                                        <option value="">-- Select a Page --</option>
                                        <% if (typeof pages !=='undefined' && pages.length> 0) { %>
                                            <% pages.forEach(page=> { %>
                                                <option value="<%= page._id %>" <%=content.page && content.page._id.toString()===page._id.toString()
                                                    ? 'selected' : '' %>><%= page.name %>
                                                </option>
                                                <% }) %>
                                                    <% } %>
                                    </select>
                                </div> -->
                                <input type="hidden" name="pageId" id="pageId" value="<%= page._id %>">

                                <div>
                                    <label class="form-label">Status: </label>
                                    <select class="form-control border border-neutral-200 radius-8" id="status" name="status">
                                        <option value="inactive" <%=page.status=='inactive' ? 'selected' : '' %>>Draft</option>
                                        <option value="active" <%=page.status=='active' ? 'selected' : '' %>>Publish</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex publish-btns">
                                <a href="/page-master/edit-page/<%= page._id %>"
                                    class="border border-danger-600 bg-hover-danger-200 text-danger-600 text-md px-56 py-11 radius-8">
                                    Back
                                </a>
                                <button type="button" id="updateAndSeoBtn" class="btn btn-outline-primary border border-primary-600 text-md px-56 py-12 radius-8">
                                    Save & Manage SEO
                                </button>
                                <button type="submit" class="btn btn-primary border border-primary-600 text-md px-56 py-12 radius-8">
                                    Save Changes
                                </button>
                            </div>
                        </div>


                    </div>

                    <hr class="my-3">

                    <!-- Sections Container -->

                    <!-- commented out tyoes -->
                    <!--
                    in another file
                     -->


                    <!-- Template-based sections only - no manual section addition -->
                    <div class="alert alert-info text-center">
                        <small><strong>Note:</strong> This page uses a predefined template. To change the section structure, edit the page template in <a href="/page-master/web-page-master">Page Master</a>.</small>
                    </div>

                    <hr class="my-3">

                    <!-- Hidden: Section Block Template -->
                     <!--
                    // commeneted out types
                        /*
                        <option value="image-with-text">Image with Text</option>
                        <option value="image-with-list">Image with List</option>
                        <option value="heading-subheading">Heading with Subheading</option>
                        <option value="left-heading-image-right-text">Left Heading + Image, Right Text</option>
                        <option value="right-heading-image-left-text">Right Heading + Image, Left Text</option>
                        <option value="hero-section">Hero Section (Left Text + Right Image)</option>
                        */ -->
                    <div class="d-none">
                        <div id="originalSection">
                            <div class="section-block border border-neutral-300 radius-8 p-5 mb-4 bg-neutral-50" data-section-id="__ID__">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-lg mb-0">Section #__ID__</h6>
                                    <button type="button" class="btn btn-sm btn-danger-600 remove-section-btn">Remove Section</button>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Section Type: <span class="text-danger-600">*</span></label>
                                    <select class="form-control border border-neutral-200 radius-8 section-type-select" >
                                        <option value="">-- Please Select Section --</option>

                                        <option value="hero-section">Hero Section</option>
                                        <option value="three-column-info">Header Section</option>
                                        <option value="call-out-cards">Call Out Section</option>
                                        <option value="tabs-section">Tabs Section</option>
                                    </select>
                                </div>
                                <div class="image-with-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label">Paragraph:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwt-subheading" placeholder="Subheading"></div>
                                    <div class="mb-3"><label class="form-label">Text:</label><textarea class="form-control border border-neutral-200 radius-8 iwt-text" rows="4" placeholder="Description"></textarea></div>
                                    <div class="form-check mb-3"><input class="form-check-input iwt-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Image</label><div class="upload-image-wrapper"><div class="uploaded-img-iwt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-iwt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-iwt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-iwt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-iwt-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="image-with-list-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwl-heading" placeholder="Heading"></div>
                                    <div class="form-check mb-3"><input class="form-check-input iwl-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label">List Items:</label><div class="iwl-items"></div><button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-iwl-item-btn">Add Item</button></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Image</label><div class="upload-image-wrapper"><div class="uploaded-img-iwl d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-iwl__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-iwl__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-iwl h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-iwl-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="heading-subheading-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 hs-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label">Subheading:</label><input type="text" class="form-control border border-neutral-200 radius-8 hs-subheading" placeholder="Subheading"></div>
                                    <div class="form-check mb-3"><input class="form-check-input hs-center" type="checkbox" checked><label class="form-check-label">Center Align</label></div>
                                </div>
                                <div class="left-heading-image-right-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Left Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 lhrt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Left Image</label><div class="upload-image-wrapper"><div class="uploaded-img-lhrt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-lhrt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-lhrt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-lhrt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-lhrt-input" hidden accept="image/*"></label></div></div>
                                    <div class="mb-3"><label class="form-label">Right Text:</label><textarea class="form-control border border-neutral-200 radius-8 lhrt-right-text" rows="4" placeholder="Text"></textarea></div>
                                </div>
                                <div class="right-heading-image-left-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Right Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 rhlt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Right Image</label><div class="upload-image-wrapper"><div class="uploaded-img-rhlt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-rhlt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-rhlt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-rhlt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-rhlt-input" hidden accept="image/*"></label></div></div>
                                    <div class="mb-3"><label class="form-label">Left Text:</label><textarea class="form-control border border-neutral-200 radius-8 rhlt-left-text" rows="4" placeholder="Text"></textarea></div>
                                </div>
                                <div class="hero-section-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading: <span class="text-danger-600">*</span></label><input type="text" class="form-control border border-neutral-200 radius-8 hero-heading" placeholder="Enter main heading"></div>
                                    <div class="mb-3"><label class="form-label">Paragraph:</label><textarea class="form-control border border-neutral-200 radius-8 hero-paragraph" rows="4" placeholder="Description"></textarea></div>
                                    <div class="mb-3"><label class="form-label">Call To Action Buttons:</label><div class="cta-container"></div><button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-cta-btn">Add CTA Button</button></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Right Image</label><div class="upload-image-wrapper"><div class="uploaded-img-hero d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-hero__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-hero__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-hero h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-hero-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="three-column-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Section Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 tci-heading" placeholder="Main Heading"></div>
                                    <div class="mb-3"><label class="form-label">Section Sub-heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 tci-subheading" placeholder="Sub-heading"></div>
                                    <!-- <div class="form-check mb-3"><input class="form-check-input tci-image-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Section Image</label><div class="upload-image-wrapper"><div class="uploaded-img-tci d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-tci__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-tci__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-tci h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-tci-input" hidden accept="image/*"></label></div></div>  -->
                                    <div class="mb-3">
                                        <label class="form-label">Buttons:</label>
                                        <div class="column-container"></div>
                                        <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-column-btn">Add Button</button>
                                    </div>
                                </div>
                                <div class="call-out-cards-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Call Out Section:</label><div class="callout-container"></div><button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-callout-btn">Add Call Out Card</button><small class="text-muted d-block mt-1">Min: 1 card, Max: 6 cards</small></div>
                                </div>
                                <div class="tabs-section-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Tabs:</label><div class="tabs-container"></div><small class="text-muted d-block mt-1">8 tabs will be created automatically</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>


            </form>
        </div>
    </div>
</div>
</div>

<style>
/* Community Groups Sortable Styles */
.sortable-container .selected-page-item {
    cursor: move;
    transition: all 0.2s ease;
}

.sortable-container .selected-page-item:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.sortable-ghost {
    opacity: 0.4;
    background-color: #e9ecef !important;
}

.sortable-chosen {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
}

.sortable-drag {
    background-color: #ffffff !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: rotate(5deg);
}

.selected-page-item::before {
    content: "";
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 12px;
    line-height: 1;
}

.selected-page-item {
    position: relative;
    padding-left: 25px !important;
}

/* CKEditor 5 List Styles Fix */
.ck-content ol {
    list-style-type: decimal !important;
    padding-left: 40px !important;
    margin-left: 0 !important;
}

.ck-content ul {
    list-style-type: disc !important;
    padding-left: 40px !important;
    margin-left: 0 !important;
}

.ck-content ol li,
.ck-content ul li {
    display: list-item !important;
    margin-left: 0 !important;
}

.ck-content ol li::marker {
    display: inline-block !important;
}

.ck-content ul li::marker {
    display: inline-block !important;
}

/* CKEditor 5 Image Styles Fix */
.ck-content img {
    max-width: 100% !important;
    height: auto !important;
    display: block !important;
}

.ck-content figure.image {
    display: table !important;
    clear: both !important;
    text-align: center !important;
    margin: 1em auto !important;
}

.ck-content figure.image img {
    display: block !important;
    margin: 0 auto !important;
    max-width: 100% !important;
    min-width: 50px !important;
}

.ck-content figure.image.image-style-side {
    float: right !important;
    margin-left: 1.5em !important;
    max-width: 50% !important;
}

.ck-content figure.image.image-style-align-left {
    float: left !important;
    margin-right: 1.5em !important;
}

.ck-content figure.image.image-style-align-right {
    float: right !important;
    margin-left: 1.5em !important;
}

/* Ensure images load properly */
.ck-editor__editable img {
    max-width: 100% !important;
    height: auto !important;
}

.ck.ck-editor__editable img {
    max-width: 100% !important;
    height: auto !important;
}
</style>

<script src="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.umd.js"></script>
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.css" />

<% script=` <script>
    // CKEditor 5 instances storage
    let editorInstances = {};
    
    // Custom upload adapter for CKEditor
    class MyUploadAdapter {
        constructor(loader) {
            this.loader = loader;
        }

        upload() {
            return this.loader.file.then(file => new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folder', 'content');

                $.ajax({
                    url: '/api/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(result) {
                        console.log('Upload success:', result);
                        if (result.success) {
                            // Make sure the URL is correct
                            let imageUrl = result.url;
                            
                            // If URL doesn't start with /, add it
                            if (!imageUrl.startsWith('/') && !imageUrl.startsWith('http')) {
                                imageUrl = '/' + imageUrl;
                            }
                            
                            console.log('Final image URL:', imageUrl);
                            
                            resolve({
                                default: imageUrl
                            });
                        } else {
                            reject(result.message || 'Upload failed');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Upload error:', error);
                        reject(error);
                    }
                });
            }));
        }

        abort() {
            // Handle abort
        }
    }

    function MyCustomUploadAdapterPlugin(editor) {
        editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
            return new MyUploadAdapter(loader);
        };
    }

    // Initialize CKEditor 5
    function initCKEditor() {
        const { 
            ClassicEditor, 
            Essentials, 
            Bold, 
            Italic, 
            Underline, 
            Paragraph, 
            List, 
            Link, 
            Heading,
            Image,
            ImageCaption,
            ImageResize,
            ImageStyle,
            ImageToolbar,
            ImageUpload,
            FileRepository
        } = window.CKEDITOR;
        
        // Find all textareas with ckeditor-paragraph class
        document.querySelectorAll('.ckeditor-paragraph').forEach(function(textarea) {
            // Generate unique ID if not exists
            if (!textarea.id) {
                textarea.id = 'editor_' + Math.random().toString(36).substr(2, 9);
            }
            
            // Check if already initialized
            if (editorInstances[textarea.id]) {
                return;
            }
            
            // Initialize CKEditor 5
            ClassicEditor
                .create(textarea, {
                    plugins: [ 
                        Essentials, 
                        Bold, 
                        Italic, 
                        Underline, 
                        Paragraph, 
                        List, 
                        Link, 
                        Heading,
                        Image,
                        ImageCaption,
                        ImageResize,
                        ImageStyle,
                        ImageToolbar,
                        ImageUpload,
                        FileRepository
                    ],
                    extraPlugins: [MyCustomUploadAdapterPlugin],
                    toolbar: {
                        items: [
                            'heading',
                            '|',
                            'bold', 'italic', 'underline',
                            '|',
                            'bulletedList', 'numberedList',
                            '|',
                            'link', 'uploadImage',
                            '|',
                            'undo', 'redo'
                        ]
                    },
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                        ]
                    },
                    list: {
                        properties: {
                            styles: true,
                            startIndex: true,
                            reversed: true
                        }
                    },
                    image: {
                        toolbar: [
                            'imageStyle:inline',
                            'imageStyle:block',
                            'imageStyle:side',
                            '|',
                            'toggleImageCaption',
                            'imageTextAlternative',
                            '|',
                            'resizeImage'
                        ],
                        resizeOptions: [
                            {
                                name: 'resizeImage:original',
                                label: 'Original',
                                value: null
                            },
                            {
                                name: 'resizeImage:25',
                                label: '25%',
                                value: '25'
                            },
                            {
                                name: 'resizeImage:50',
                                label: '50%',
                                value: '50'
                            },
                            {
                                name: 'resizeImage:75',
                                label: '75%',
                                value: '75'
                            }
                        ]
                    }
                })
                .then(editor => {
                    editorInstances[textarea.id] = editor;
                })
                .catch(error => {
                    console.error('CKEditor initialization error:', error);
                });
        });
    }
    
    // Wait for page to load
    window.addEventListener('load', function() {
        if (typeof window.CKEDITOR !== 'undefined') {
            setTimeout(initCKEditor, 500);
        }
    });

    // Centralized function to toggle the visibility of section fields
    function toggleSectionFields($section) {
        const sectionType = $section.find(".section-type-select").val();

        // Hide all fields first
        $section.find('.image-with-text-fields').hide();
        $section.find('.image-with-list-fields').hide();
        $section.find('.heading-subheading-fields').hide();
        $section.find('.left-heading-image-right-text-fields').hide();
        $section.find('.right-heading-image-left-text-fields').hide();
        $section.find('.hero-section-fields').hide();
        $section.find('.three-column-fields').hide();
        $section.find('.call-out-cards-fields').hide();
        $section.find('.tabs-section-fields').hide();

        // Show only the relevant fields based on section type
        if (sectionType === 'image-with-text') {
            $section.find('.image-with-text-fields').show();
        } else if (sectionType === 'image-with-list') {
            $section.find('.image-with-list-fields').show();
        } else if (sectionType === 'heading-subheading') {
            $section.find('.heading-subheading-fields').show();
        } else if (sectionType === 'left-heading-image-right-text') {
            $section.find('.left-heading-image-right-text-fields').show();
        } else if (sectionType === 'right-heading-image-left-text') {
            $section.find('.right-heading-image-left-text-fields').show();
        } else if (sectionType === 'hero-section') {
            $section.find('.hero-section-fields').show();
            // Reinitialize CKEditor for this section after it becomes visible
            setTimeout(initCKEditor, 300);
        } else if (sectionType === 'three-column-info') {
            $section.find('.three-column-fields').show();
        } else if (sectionType === 'call-out-cards') {
            $section.find('.call-out-cards-fields').show();
        } else if (sectionType === 'tabs-section') {
            $section.find('.tabs-section-fields').show();
            // Auto-create 8 tabs if none exist
            const $tabsContainer = $section.find('.tabs-container');
            if ($tabsContainer.find('.tab-item').length === 0) {
                for (let i = 1; i <= 8; i++) {
                    const tabHtml = \`
                        <div class="tab-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold text-sm">Tab #\${i}</span>
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-sm">Title:</label>
                                <input type="text" class="form-control border border-neutral-200 radius-8 tab-title" placeholder="Tab Title">
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-sm">Heading:</label>
                                <input type="text" class="form-control border border-neutral-200 radius-8 tab-heading" placeholder="Tab Heading">
                            </div>
                            <div>
                                <label class="form-label text-sm">Paragraph:</label>
                                <textarea class="form-control border border-neutral-200 radius-8 tab-paragraph" rows="3" placeholder="Tab content"></textarea>
                            </div>
                        </div>\`;
                    $tabsContainer.append(tabHtml);
                }
            }
        }
    }

    // Template sections have fixed structure - no dynamic item management

    // Generic image upload handler to keep code DRY
    function handleImageUpload(inputSelector, previewSelector, removeSelector, wrapperSelector, folderName) {
        $(document).on("change", inputSelector, function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $wrapper = $(this).closest(wrapperSelector);
                const $preview = $wrapper.find(previewSelector);
                const $remove = $wrapper.find(removeSelector);
                const $input = $(this);

                // Use FileReader for a robust preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $preview.attr("src", event.target.result).show();
                    $remove.show();
                    $input.hide(); // Hide the input label
                };
                reader.readAsDataURL(file);

                // AJAX upload
                const formData = new FormData();
                // append folder first so multer's destination sees it when processing the file
                formData.append("folder", folderName);
                formData.append("file", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            // Store the URL in a data attribute for submission
                            $input.data("server-url", response.url);
                            console.log("server-url", response);

                            showToast("Image uploaded successfully", "success");
                        } else {
                            showToast(response.message || "Image upload failed", "error");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred", "error");
                    }
                });
            }
        });

        // Handle image removal
        $(document).on("click", removeSelector, function () {
            const $wrapper = $(this).closest(wrapperSelector);
            $wrapper.find(previewSelector).attr("src", "").hide();
            $(this).hide();
            $wrapper.find(inputSelector).val("").data("server-url", "").show(); // Clear input and data
        });
    }

    // Template sections are fixed - no dynamic section management needed

    // Main document ready function
    $(document).ready(function () {
        // Initialize existing sections (only real sections inside the container)
        $("#sectionsContainer .section-block").each(function () {
            toggleSectionFields($(this));
        });
        
        // Initialize CKEditor after sections are visible
        setTimeout(initCKEditor, 1000);

        // Template sections are read-only - prevent structure changes
        $("#sectionsContainer").on("change", ".section-type-select", function () {
            showToast('Section types are fixed by the page template. Change the template in Page Master to modify structure.', 'warning');
            // Revert to original value
            const originalType = $(this).closest('.section-block').find('.original-section-type').val();
            $(this).val(originalType);
        });

        // Initialize all image upload handlers
        handleImageUpload(".upload-file-iwt-input", ".uploaded-img-iwt__preview", ".uploaded-img-iwt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-iwl-input", ".uploaded-img-iwl__preview", ".uploaded-img-iwl__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-lhrt-input", ".uploaded-img-lhrt__preview", ".uploaded-img-lhrt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-rhlt-input", ".uploaded-img-rhlt__preview", ".uploaded-img-rhlt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-hero-input", ".uploaded-img-hero__preview", ".uploaded-img-hero__remove", ".upload-image-wrapper", "hero");

        // Hero Section image handler with proper show/hide logic
        $(document).on("change", ".upload-file-hero-input", function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $section = $(this).closest(".section-block");
                const $wrapper = $(this).closest(".upload-image-wrapper");
                const $input = $(this);

                // Show preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $wrapper.find(".uploaded-img-hero__preview").attr("src", event.target.result);
                    $wrapper.find(".uploaded-img-hero").removeClass("d-none");
                    $wrapper.find(".upload-file-hero").hide();
                };
                reader.readAsDataURL(file);

                // Upload to server
                const formData = new FormData();
                formData.append("folder", "hero");
                formData.append("file", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            $input.data("server-url", response.url);
                            showToast("Hero image uploaded successfully", "success");
                        } else {
                            showToast(response.message || "Image upload failed", "error");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred", "error");
                    }
                });
            }
        });

        // Hero Section image remove handler
        $(document).on("click", ".uploaded-img-hero__remove", function () {
            const $wrapper = $(this).closest(".upload-image-wrapper");
            $wrapper.find(".uploaded-img-hero__preview").attr("src", "");
            $wrapper.find(".uploaded-img-hero").addClass("d-none");
            $wrapper.find(".upload-file-hero").show();
            $wrapper.find(".upload-file-hero-input").val("").data("server-url", "");
        });

        // Three Column Info image handler with proper show/hide logic
        $(document).on("change", ".upload-file-tci-input", function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $section = $(this).closest(".section-block");
                const $wrapper = $(this).closest(".upload-image-wrapper");
                const $input = $(this);

                // Show preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $wrapper.find(".uploaded-img-tci__preview").attr("src", event.target.result);
                    $wrapper.find(".uploaded-img-tci").removeClass("d-none");
                    $wrapper.find(".upload-file-tci").hide();
                };
                reader.readAsDataURL(file);

                // Upload to server
                const formData = new FormData();
                formData.append("folder", "section");
                formData.append("file", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            $input.data("server-url", response.url);
                            showToast("Image uploaded successfully", "success");
                        } else {
                            showToast(response.message || "Image upload failed", "error");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred", "error");
                    }
                });
            }
        });

        // Three Column Info image remove handler
        $(document).on("click", ".uploaded-img-tci__remove", function () {
            const $wrapper = $(this).closest(".upload-image-wrapper");
            $wrapper.find(".uploaded-img-tci__preview").attr("src", "");
            $wrapper.find(".uploaded-img-tci").addClass("d-none");
            $wrapper.find(".upload-file-tci").show();
            $wrapper.find(".upload-file-tci-input").val("").data("server-url", "");
        });

        // Form submission logic
        $("#editContentForm").on("submit", function (e) {
            const saveBtn = $('#editContentForm button[type="submit"]')[0];
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
            e.preventDefault();

            const contentId = $("#contentId").val();
            const pageId = $("#pageId").val();
            const status = $("#status").val();

            if (!pageId) {
                showToast("Please select a page.", "warning");
                return;
            }

            const sectionsData = [];
            let isValid = true;

            $("#sectionsContainer .section-block").each(function (index) {
                const $section = $(this);
                // For template-based pages, get from original value if select is disabled
                let sectionType = $section.find(".section-type-select").val();
                if (!sectionType || $section.find(".section-type-select").is(':disabled')) {
                    sectionType = $section.find(".original-section-type").val();
                }

                if (!sectionType) {
                    showToast("Please select a section type for all sections.", "warning");
                    isValid = false;
                    return false; // Break the loop
                }

                const sectionData = {
                    id: $section.data("id"), // Keep track of the section
                    order: index + 1,
                    sectionType: sectionType,
                    customFields: {},
                    heroSection: {},
                    threeColumnInfo: {}
                };

                // Populate data based on section type
                if (sectionType === "image-with-text") {
                    sectionData.customFields.heading = $section.find(".iwt-heading").val();
                    sectionData.customFields.subheading = $section.find(".iwt-subheading").val();
                    sectionData.customFields.richText = $section.find(".iwt-text").val();
                    sectionData.customFields.image = $section.find(".upload-file-iwt-input").data("server-url") || $section.find(".uploaded-img-iwt__preview").attr("src");
                } else if (sectionType === "image-with-list") {
                    sectionData.customFields.heading = $section.find(".iwl-heading").val();
                    sectionData.customFields.items = $section.find(".iwl-item-input").map(function () {
                        return $(this).val();
                    }).get();
                    sectionData.customFields.image = $section.find(".upload-file-iwl-input").data("server-url") || $section.find(".uploaded-img-iwl__preview").attr("src");
                } else if (sectionType === "heading-subheading") {
                    sectionData.customFields.heading = $section.find(".hs-heading").val();
                    sectionData.customFields.subheading = $section.find(".hs-subheading").val();
                    sectionData.customFields.alignCenter = $section.find(".hs-center").is(":checked");
                } else if (sectionType === "hero-section") {
                    const ctas = [];
                    $section.find(".cta-item").each(function () {
                        const text = $(this).find(".cta-text").val();
                        const link = $(this).find(".cta-link").val();
                        const style = $(this).find(".cta-style").val() || 'primary';
                        if (text && link) {
                            ctas.push({ text, link, style });
                        }
                    });
                    sectionData.heroSection.heading = $section.find(".hero-heading").val();
                    // Get CKEditor 5 content
                    const paragraphEditor = $section.find(".hero-paragraph");
                    const editorId = paragraphEditor.attr('id');
                    sectionData.heroSection.paragraph = editorInstances[editorId] ? editorInstances[editorId].getData() : paragraphEditor.val();
                    sectionData.heroSection.image = $section.find(".upload-file-hero-input").data("server-url") || $section.find(".uploaded-img-hero__preview").attr("src");
                    sectionData.heroSection.ctas = ctas;
                } else if (sectionType === "left-heading-image-right-text") {
                    // Left heading + image on left, right text
                    sectionData.customFields.leftHeading = $section.find('.lhrt-heading').val();
                    sectionData.customFields.leftImage = $section.find('.upload-file-lhrt-input').data('server-url') || $section.find('.uploaded-img-lhrt__preview').attr('src');
                    sectionData.customFields.rightText = $section.find('.lhrt-right-text').val();
                } else if (sectionType === "right-heading-image-left-text") {
                    // Right heading + image on right, left text
                    sectionData.customFields.rightHeading = $section.find('.rhlt-heading').val();
                    sectionData.customFields.rightImage = $section.find('.upload-file-rhlt-input').data('server-url') || $section.find('.uploaded-img-rhlt__preview').attr('src');
                    sectionData.customFields.leftText = $section.find('.rhlt-left-text').val();
                } else if (sectionType === "three-column-info") {
                    const $tciInput = $section.find(".upload-file-tci-input");
                    const newImageUrl = $tciInput.data("server-url");
                    const existingImageUrl = $tciInput.data("existing-image");
                    const heading = $section.find(".tci-heading").val();
                    const subheading = $section.find(".tci-subheading").val();
                    const imageUrl = newImageUrl || existingImageUrl || "";

                    sectionData.title = heading || "Three Column Info";
                    sectionData.thumbnail = imageUrl;
                    sectionData.threeColumnInfo.heading = heading;
                    sectionData.threeColumnInfo.subheading = subheading;
                    sectionData.threeColumnInfo.imageOnLeft = $section.find(".tci-image-left").is(":checked");
                    sectionData.threeColumnInfo.image = imageUrl;
                    sectionData.threeColumnInfo.columns = $section.find(".column-item").map(function () {
                        return {
                            title: $(this).find(".column-title").val(),
                            description: $(this).find(".column-description").val(),
                            buttonText: $(this).find(".column-btn-text").val(),
                            buttonLink: $(this).find(".column-btn-link").val()
                        };
                    }).get();
                } else if (sectionType === "call-out-cards") {
                    const cards = $section.find(".callout-item").map(function () {
                        return {
                            heading: $(this).find(".callout-heading").val(),
                            subheading: $(this).find(".callout-subheading").val(),
                            link: $(this).find(".callout-link").val()
                        };
                    }).get();

                    // Allow 0 cards - no minimum requirement

                    if (cards.length > 6) {
                        showToast('Maximum 6 Call Out Section allowed', 'warning');
                        isValid = false;
                        return false;
                    }

                    // Check if all cards have headings (only if cards exist)
                    if (cards.length > 0) {
                        const invalidCard = cards.find(card => !card.heading);
                        if (invalidCard) {
                            showToast('All Call Out Section must have a heading', 'warning');
                            isValid = false;
                            return false;
                        }
                    }

                    sectionData.title = cards.length > 0 ? (cards[0].heading || "Call Out Section") : "Call Out Section";
                    sectionData.callOutCards = { cards: cards };
                } else if (sectionType === "tabs-section") {
                    const tabs = $section.find(".tab-item").map(function () {
                        return {
                            title: $(this).find(".tab-title").val(),
                            heading: $(this).find(".tab-heading").val(),
                            paragraph: $(this).find(".tab-paragraph").val()
                        };
                    }).get();

                    sectionData.title = "Tabs Section";
                    sectionData.tabsSection = { tabs: tabs };
                } else if (sectionType === "community-groups") {
                    const heading = $section.find(".cg-heading").val();
                    const subheading = $section.find(".cg-subheading").val();
                    const category = "community"; // Default to community category
                    const displayOrder = $section.find(".cg-display-order").val();
                    
                    // Get selected pages
                    const selectedPages = [];
                    $section.find(".selected-page-item").each(function(index) {
                        const pageId = $(this).data("page-id");
                        const order = $(this).data("order") || index;
                        if (pageId) {
                            selectedPages.push({
                                page: pageId,
                                order: order
                            });
                        }
                    });
                    
                    sectionData.title = heading || "Community Groups";
                    sectionData.communityGroups = {
                        heading: heading,
                        subheading: subheading,
                        category: category,
                        displayOrder: displayOrder,
                        selectedPages: selectedPages
                    };
                }

                sectionsData.push(sectionData);
            });

            if (!isValid) return;

            // Consolidate all data into one payload
            const payload = {
                pageId: pageId,
                status: status,
                sections: sectionsData
            };

            // Single AJAX call to update everything
            $.ajax({
                url: \`/api/content/\${contentId}\`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.success) {
                        showToast("Content updated successfully!", "success");
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = "/page-master/web-page-master";
                        }, 1000);
                    } else {
                        showToast(response.message || "An error occurred.", "error");
                    }
                },
                error: function (xhr) {
                    showToast(xhr.responseJSON?.message || "An error occurred.", "error");
                }
            });
        });

        // Handle "Update & Manage SEO" button
        $("#updateAndSeoBtn").on("click", function(e) {
            e.preventDefault();

            // First update the content, then redirect to SEO management
            const contentId = $("#contentId").val();
            const pageId = $("#pageId").val();
            const status = $("#status").val();

            if (!pageId) {
                showToast("Please select a page.", "warning");
                return;
            }

            const sectionsData = [];
            let isValid = true;

            // Same validation and data collection as the main form
            $("#sectionsContainer .section-block").each(function (index) {
                const $section = $(this);
                // For template-based pages, get from original value if select is disabled
                let sectionType = $section.find(".section-type-select").val();
                if (!sectionType || $section.find(".section-type-select").is(':disabled')) {
                    sectionType = $section.find(".original-section-type").val();
                }

                if (!sectionType) {
                    showToast("Please select a section type for all sections.", "warning");
                    isValid = false;
                    return false;
                }

                const sectionData = {
                    id: $section.data("id"),
                    order: index + 1,
                    sectionType: sectionType,
                    customFields: {},
                    heroSection: {},
                    threeColumnInfo: {}
                };

                // Same data population logic as main form (abbreviated for brevity)
                if (sectionType === "hero-section") {
                    const ctas = [];
                    $section.find(".cta-item").each(function () {
                        const text = $(this).find(".cta-text").val();
                        const link = $(this).find(".cta-link").val();
                        const style = $(this).find(".cta-style").val() || 'primary';
                        if (text && link) {
                            ctas.push({ text, link, style });
                        }
                    });
                    sectionData.heroSection.heading = $section.find(".hero-heading").val();
                    // Get CKEditor 5 content
                    const paragraphEditor2 = $section.find(".hero-paragraph");
                    const editorId2 = paragraphEditor2.attr('id');
                    sectionData.heroSection.paragraph = editorInstances[editorId2] ? editorInstances[editorId2].getData() : paragraphEditor2.val();
                    sectionData.heroSection.image = $section.find(".upload-file-hero-input").data("server-url") || $section.find(".uploaded-img-hero__preview").attr("src");
                    sectionData.heroSection.ctas = ctas;
                } else if (sectionType === "three-column-info") {
                    const heading = $section.find(".tci-heading").val();
                    const subheading = $section.find(".tci-subheading").val();
                    sectionData.title = heading || "Three Column Info";
                    sectionData.threeColumnInfo.heading = heading;
                    sectionData.threeColumnInfo.subheading = subheading;
                    sectionData.threeColumnInfo.columns = $section.find(".column-item").map(function () {
                        return {
                            title: $(this).find(".column-title").val(),
                            description: $(this).find(".column-description").val(),
                            buttonText: $(this).find(".column-btn-text").val(),
                            buttonLink: $(this).find(".column-btn-link").val()
                        };
                    }).get();
                } else if (sectionType === "call-out-cards") {
                    const cards = $section.find(".callout-item").map(function () {
                        return {
                            heading: $(this).find(".callout-heading").val(),
                            subheading: $(this).find(".callout-subheading").val(),
                            link: $(this).find(".callout-link").val()
                        };
                    }).get();

                    // Allow 0 cards - no minimum requirement

                    // Check if all cards have headings (only if cards exist)
                    if (cards.length > 0) {
                        const invalidCard = cards.find(card => !card.heading);
                        if (invalidCard) {
                            showToast('All Call Out Section must have a heading', 'warning');
                            isValid = false;
                            return false;
                        }
                    }

                    sectionData.title = cards.length > 0 ? (cards[0].heading || "Call Out Section") : "Call Out Section";
                    sectionData.callOutCards = { cards: cards };
                } else if (sectionType === "tabs-section") {
                    const tabs = $section.find(".tab-item").map(function () {
                        return {
                            title: $(this).find(".tab-title").val(),
                            heading: $(this).find(".tab-heading").val(),
                            paragraph: $(this).find(".tab-paragraph").val()
                        };
                    }).get();

                    sectionData.title = "Tabs Section";
                    sectionData.tabsSection = { tabs: tabs };
                }

                sectionsData.push(sectionData);
            });

            if (!isValid) {
                return;
            }

            // Update content first, then redirect to SEO
            const payload = {
                pageId: pageId,
                status: status,
                sections: sectionsData
            };

            $.ajax({
                url: \`/api/content/\${contentId}\`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.success) {
                        showToast("Content updated successfully! Redirecting to SEO management...", "success");
                        setTimeout(() => {
                            // Check if SEO exists for this page via API, then redirect appropriately
                            $.ajax({
                                url: \`/api/seo/check-page/\${pageId}\`,
                                type: 'GET',
                                success: function(seoResponse) {
                                    if (seoResponse.success && seoResponse.seoExists) {
                                        // SEO exists, go to edit
                                        window.location.href = \`/seo/edit-seo-content/\${seoResponse.seoId}?from=content\`;
                                    } else {
                                        // No SEO, go to add with page pre-selected
                                        window.location.href = \`/seo/add-seo-content?pageId=\${pageId}&from=content\`;
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error("SEO check failed:", error);
                                    // Fallback to SEO management page
                                    window.location.href = '/seo/seo-management';
                                }
                            });
                        }, 1000);
                    } else {
                        showToast(response.message || "An error occurred.", "error");
                    }
                },
                error: function (xhr) {
                    console.error("Content update failed:", xhr.responseJSON?.message || xhr.statusText);
                    showToast(xhr.responseJSON?.message || "An error occurred.", "error");
                }
            });
        });
    });
    $(document).on('input', '.callout-link,.column-btn-link,.cta-link', function() {
        const $input = $(this);
        const query = $input.val().trim();

        if (query.length < 2) {
            $input.next('.autocomplete-list').remove();
            return;
        }

        $.ajax({
            url: '/api/pages/all-pages/search',
            data: { q: query },
            success: function(pages) {
            $input.next('.autocomplete-list').remove();

            if (!pages || pages.length === 0) return;

            const $list = $('<div class="autocomplete-list border bg-white position-absolute w-100 radius-8 shadow-sm mt-1 z-1"></div>');

            pages.forEach(page => {
                const $item = $(\`
                <div class="autocomplete-item p-2 text-sm cursor-pointer hover:bg-neutral-100">
                    $\{page.name} <small class="text-muted">($\{page.slug})</small>
                </div>
                \`);
                const baseUrl = window.location.origin;

                $item.on('click', function() {
                $input.val(page.slug);
                $input.val(\`$\{baseUrl}/$\{page.slug}\`);
                $list.remove();
                });

                $list.append($item);
            });

            $input.after($list);
            },
            error: function(err) {
            console.error('Autocomplete error:', err);
            }
        });
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest('.callout-link, .column-btn-link, .cta-link, .autocomplete-list').length) {
            $('.autocomplete-list').remove();
        }
    });

    // CTA Button Handlers
    $(document).on('click', '.add-cta-btn', function() {
        
        const $container = $(this).siblings('.cta-container');
        const ctaCount = $container.find('.cta-item').length;
        
        if (ctaCount >= 3) {
            $(this).attr("disabled", true);
            showToast('Maximum 3 CTA buttons allowed', 'warning');
            return;
        }
        
        const ctaHtml = \`
            <div class="cta-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold text-sm">CTA Button #\${ctaCount + 1}</span>
                    <button type="button" class="btn btn-sm btn-danger-600 remove-cta-btn"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Button Text:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 cta-text"
                        placeholder="e.g., Learn More">
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Button Link:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 cta-link"
                        placeholder="e.g., /about">
                </div>
            </div>
        \`;
        
        $container.append(ctaHtml);
        updateCtaNumbers($container);
    });

    $(document).on('click', '.remove-cta-btn', function() {
        const $container = $(this).closest('.cta-container');
        $(this).closest('.cta-item').remove();
        updateCtaNumbers($container);
    });

    function updateCtaNumbers($container) {
        $container.find('.cta-item').each(function(index) {
            $(this).find('.fw-semibold').text(\`CTA Button #\${index + 1}\`);
        });
    }

    // Tab Handlers
    $(document).on('click', '.add-tab-btn', function() {
        const $container = $(this).siblings('.tabs-container');
        const tabCount = $container.find('.tab-item').length;
        
        if (tabCount >= 8) {
            $(this).attr("disabled", true);
            showToast('Maximum 8 tabs allowed', 'warning');
            return;
        }
        
        const tabHtml = \`
            <div class="tab-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold text-sm">Tab #\${tabCount + 1}</span>
                    <button type="button" class="btn btn-sm btn-danger-600 remove-tab-btn"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Title:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-title"
                        placeholder="Tab Title">
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Heading:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-heading"
                        placeholder="Tab Heading">
                </div>
                <div>
                    <label class="form-label text-sm">Paragraph:</label>
                    <textarea class="form-control border border-neutral-200 radius-8 tab-paragraph" rows="3"
                        placeholder="Tab content"></textarea>
                </div>
            </div>
        \`;
        
        $container.append(tabHtml);
        updateTabNumbers($container);
        
        // Hide "No tabs found" message if it exists
        $container.find('.text-muted').hide();
    });

    $(document).on('click', '.remove-tab-btn', function() {
        const $container = $(this).closest('.tabs-container');
        const $tabItem = $(this).closest('.tab-item');
        
        // Don't allow removing if it's the last tab
        if ($container.find('.tab-item').length <= 1) {
            showToast('At least one tab is required', 'warning');
            return;
        }
        
        $tabItem.remove();
        updateTabNumbers($container);
        
        // Show "No tabs found" message if no tabs left
        if ($container.find('.tab-item').length === 0) {
            $container.append('<p class="text-muted">No tabs found. Click "Add Tab" to create one.</p>');
        }
    });

    function updateTabNumbers($container) {
        $container.find('.tab-item').each(function(index) {
            $(this).find('.fw-semibold').text(\`Tab #\${index + 1}\`);
        });
    }

    // Community Groups Handlers - Category filter removed, defaulting to community

    function loadAvailablePages(category, $section) {
        const $availableList = $section.find('.available-pages-list');
        $availableList.html('<p class="text-muted text-sm">Loading pages...</p>');
        
        $.ajax({
            url: '/api/pages/by-category/' + category,
            type: 'GET',
            success: function(response) {
                if (response.success && response.data.length > 0) {
                    let html = '';
                    response.data.forEach(page => {
                        html += \`
                            <div class="available-page-item border border-neutral-300 radius-4 p-2 mb-2 bg-white d-flex justify-content-between align-items-center cursor-pointer" data-page-id="\${page._id}">
                                <span class="page-name">\${page.name}</span>
                                <button type="button" class="btn btn-sm btn-primary add-page-btn">Add</button>
                            </div>
                        \`;
                    });
                    $availableList.html(html);
                } else {
                    $availableList.html('<p class="text-muted text-sm">No pages found with this category. Create pages with "' + category + '" category first.</p>');
                }
            },
            error: function() {
                $availableList.html('<p class="text-danger text-sm">Error loading pages. Please try again.</p>');
            }
        });
    }

    $(document).on('click', '.add-page-btn', function() {
        const $pageItem = $(this).closest('.available-page-item');
        const pageId = $pageItem.data('page-id');
        const pageName = $pageItem.find('.page-name').text();
        const $section = $(this).closest('.community-groups-fields');
        const $selectedList = $section.find('.selected-pages-list');
        
        // Check if page is already selected
        if ($selectedList.find(\`[data-page-id="\${pageId}"]\`).length > 0) {
            showToast('Page is already selected', 'warning');
            return;
        }
        
        // Add to selected list
        const selectedHtml = \`
            <div class="selected-page-item border border-neutral-300 radius-4 p-2 mb-2 bg-white d-flex justify-content-between align-items-center" data-page-id="\${pageId}" data-order="0">
                <span class="page-name">\${pageName}</span>
                <button type="button" class="btn btn-sm btn-danger remove-page-btn">Remove</button>
            </div>
        \`;
        
        // Remove "No pages selected" message if it exists
        $selectedList.find('.text-muted').remove();
        $selectedList.append(selectedHtml);
        
        // Hide the page from available list
        $pageItem.hide();
        
        updatePageOrders($selectedList);
        
        // Reinitialize sortable after adding new item
        initializeCommunityGroupsSortable();
    });

    $(document).on('click', '.remove-page-btn', function() {
        const $pageItem = $(this).closest('.selected-page-item');
        const pageId = $pageItem.data('page-id');
        const $section = $(this).closest('.community-groups-fields');
        
        // Show the page back in available list
        $section.find(\`.available-page-item[data-page-id="\${pageId}"]\`).show();
        
        // Remove from selected list
        $pageItem.remove();
        
        const $selectedList = $section.find('.selected-pages-list');
        if ($selectedList.find('.selected-page-item').length === 0) {
            $selectedList.html('<p class="text-muted text-sm">No pages selected. Click on available pages to add them.</p>');
        }
        
        updatePageOrders($selectedList);
        
        // Reinitialize sortable after removing item
        initializeCommunityGroupsSortable();
    });

    function updatePageOrders($selectedList) {
        $selectedList.find('.selected-page-item').each(function(index) {
            $(this).attr('data-order', index);
        });
    }

    // Initialize community groups on page load
    $(document).ready(function() {
        $('.community-groups-fields').each(function() {
            // Default to community category since filter is removed
            loadAvailablePages('community', $(this));
        });
        
        // Initialize sortable for community groups
        initializeCommunityGroupsSortable();
    });
    
    // Initialize sortable functionality for community groups
    function initializeCommunityGroupsSortable() {
        $('.selected-pages-list').each(function() {
            if (this.sortable) {
                this.sortable.destroy();
            }
            
            this.sortable = new Sortable(this, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    updatePageOrders($(evt.to));
                }
            });
        });
    }
    var pageTemplate = $("#pageTemplate").val();
    if(pageTemplate == 'legislation'){
        $(".add-callout-btn").hide();
    }
    // Call Out Card Handlers
    $(document).on('click', '.add-callout-btn', function() {
        const $container = $(this).siblings('.callout-container');
        const calloutCount = $container.find('.callout-item').length;

        if(pageTemplate == 'legislation'){
            $(this).attr("disabled", true);
            return;
        }
        // Max 6 cards
        if (calloutCount >= 6) {
            $(this).attr("disabled", true);
            showToast('Maximum 6 Call Out Cards allowed', 'warning');
            return;
        }

        const cardNumber = calloutCount + 1;
        const calloutHtml = \`
        <div class="callout-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center gap-2">
                    <span class="fw-semibold text-sm">Card #\${cardNumber}</span>
                    <span class="badge bg-secondary">Template Card</span>
                </div>
                <button type="button" class="btn btn-sm btn-danger-600 remove-callout-btn">
                    <iconify-icon icon="material-symbols:delete-outline"></iconify-icon>
                </button>
            </div>
            <div class="mb-2">
                <label class="form-label text-sm">Heading: <span class="text-danger-600">*</span></label>
                <input type="text" class="form-control border border-neutral-200 radius-8 callout-heading" placeholder="Call Out Card \${cardNumber}" required>
            </div>
            <div class="mb-2">
                <label class="form-label text-sm">Paragraph:</label>
                <textarea class="form-control border border-neutral-200 radius-8 callout-subheading" rows="5" placeholder="Enter description here"></textarea>
            </div>
            <div>
                <label class="form-label text-sm">Link:</label>
                <input type="text" class="form-control border border-neutral-200 radius-8 callout-link" placeholder="e.g., /more">
            </div>
        </div>
        \`;
        $container.append(calloutHtml);
        updateCalloutNumbers($container);
    });

    $(document).on('click', '.remove-callout-btn', function() {
        const $container = $(this).closest('.callout-container');
        $(this).closest('.callout-item').remove();
        updateCalloutNumbers($container);
    });

    function updateCalloutNumbers($container) {
        $container.find('.callout-item').each(function(index) {
            $(this).find('.fw-semibold').text(\`Card #\${index + 1}\`);
        });
    }
    </script>
    ` %>