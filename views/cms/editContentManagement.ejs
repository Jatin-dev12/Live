<div class="row gy-4">
    <!-- jQuery CDN for all $ usage below -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header border-bottom">
                <h6 class="text-xl mb-0">Edit Content Section</h6>
            </div>
            <div class="card-body p-24">
                <form id="editContentForm" class="d-flex flex-column gap-20">
                    <input type="hidden" id="contentId" value="<%= content._id %>">

                    <div>
                        <label class="form-label" for="pageId">Select Page: <span
                                class="text-danger-600">*</span></label>
                        <select class="form-control border border-neutral-200 radius-8" id="pageId" name="pageId"
                            required>
                            <option value="">-- Select a Page --</option>
                            <% if (typeof pages !=='undefined' && pages.length> 0) { %>
                                <% pages.forEach(page=> { %>
                                    <option value="<%= page._id %>" <%=content.page &&
                                        content.page._id.toString()===page._id.toString() ? 'selected' : '' %>><%=
                                            page.name %>
                                    </option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">Status: </label>
                        <select class="form-control border border-neutral-200 radius-8" id="status" name="status">
                            <option value="active" <%=content.status==='active' ? 'selected' : '' %>>Active</option>
                            <option value="inactive" <%=content.status==='inactive' ? 'selected' : '' %>>Inactive
                            </option>
                        </select>
                    </div>

                    <hr class="my-3">

                    <!-- Style to ensure fields stay visible -->
                    <!-- <style>
                        /* Hide all section field containers by default */
                        div[class$="-fields"]:not(.active) {
                            display: none !important;
                        }

                        /* Show section field containers when they have the active class */
                        div[class$="-fields"].active {
                            display: block !important;
                        }

                        /* Also handle special case IDs */
                        #heroSectionFields:not(.active),
                        #threeColumnFields:not(.active) {
                            display: none !important;
                        }

                        #heroSectionFields.active,
                        #threeColumnFields.active {
                            display: block !important;
                        }
                    </style> -->

                    <script>
                        // Only use jQuery-based initialization to avoid conflicts
                    </script>

                    <!-- Sections Container -->
                    <div id="sectionsContainer">
                        <% if (allSections && allSections.length> 0) { %>
                            <% allSections.forEach(function(section, index) { %>
                                <div class="section-block border border-neutral-300 radius-8 p-4 bg-neutral-50 mb-4"
                                    data-id="<%= section._id %>">
                                    <h6 class="text-lg mb-3">Section <%= index + 1 %>
                                    </h6>
                                    <div class="mb-3">
                                        <input type="hidden" class="original-section-type"
                                            value="<%= section.sectionType %>">
                                        <label class="form-label">Section Type: <span
                                                class="text-danger-600">*</span></label>
                                        <select class="form-control border border-neutral-200 radius-8 section-type section-type-select"
                                            required>
                                            <option value="" <%= !section.sectionType ? 'selected' : '' %>>-- Please Select Section --</option>
                                            <option value="image-with-text" <%= section.sectionType === 'image-with-text' ? 'selected' : '' %>>Image with Text</option>
                                            <option value="image-with-list" <%= section.sectionType === 'image-with-list' ? 'selected' : '' %>>Image with List</option>
                                            <option value="heading-subheading" <%= section.sectionType === 'heading-subheading' ? 'selected' : '' %>>Heading with Subheading</option>
                                            <option value="left-heading-image-right-text" <%= section.sectionType === 'left-heading-image-right-text' ? 'selected' : '' %>>Left Heading + Image, Right Text</option>
                                            <option value="right-heading-image-left-text" <%= section.sectionType === 'right-heading-image-left-text' ? 'selected' : '' %>>Right Heading + Image, Left Text</option>
                                            <option value="hero-section" <%= section.sectionType === 'hero-section' ? 'selected' : '' %>>Hero Section (Left Text + Right Image)</option>
                                            <option value="three-column-info" <%= section.sectionType === 'three-column-info' ? 'selected' : '' %>>Three Column Info Cards</option>
                                        </select>
                                    </div>

                                    <!-- server-side renders active fields; per-block JS removed -->

                                    <!-- Dynamic fields based on section type -->
                                    <div class="section-fields asdf">
                                        <pre><%= JSON.stringify(section, null, 2) %></pre>
                                        <% if (section.sectionType==='image-with-text' ) { %>
                                            <div class="image-with-text-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwt-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Subheading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwt-subheading"
                                                        value="<%= section.customFields?.subheading || '' %>"
                                                        placeholder="Subheading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Text:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 iwt-text"
                                                        rows="4"
                                                        placeholder="Description"><%= section.customFields?.richText || '' %></textarea>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='image-with-list' ) { %>
                                            <div class="image-with-list-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwl-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">List Items:</label>
                                                    <div class="iwl-items">
                                                        <% (section.customFields?.items || []).forEach(function(it){
                                                            %>
                                                            <div
                                                                class="iwl-item d-flex align-items-center gap-2 mb-2">
                                                                <input type="text"
                                                                    class="form-control border border-neutral-200 radius-8 iwl-item-input"
                                                                    value="<%= it %>">
                                                                <button type="button"
                                                                    class="btn btn-sm btn-danger-600 remove-iwl-item">Remove</button>
                                                            </div>
                                                            <% }) %>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='heading-subheading' ) { %>
                                            <div class="heading-subheading-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hs-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Subheading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hs-subheading"
                                                        value="<%= section.customFields?.subheading || '' %>"
                                                        placeholder="Subheading">
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input hs-center" type="checkbox"
                                                        <%=section.customFields?.alignCenter ? 'checked' : ''
                                                        %>>
                                                    <label class="form-check-label">Center Align</label>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='hero-section' ) { %>
                                            <div class="hero-section-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hero-heading"
                                                        value="<%= section.heroSection?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Paragraph:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 hero-paragraph"
                                                        rows="4"
                                                        placeholder="Paragraph"><%= section.heroSection?.paragraph || '' %></textarea>
                                                </div>
                                                <% if (section.heroSection?.rightImage) { %>
                                                    <div class="mb-3">
                                                        <label class="form-label">Current Image:</label>
                                                        <div class="existing-image">
                                                            <img src="<%= section.heroSection.rightImage %>"
                                                                class="img-thumbnail"
                                                                style="max-height: 200px;">
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        <% } else if (section.sectionType==='three-column-info' ) { %>
                                            <div class="three-column-info-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Info Cards:</label>
                                                    <div class="column-container">
                                                        <% (section.threeColumnInfo?.columns ||
                                                            []).forEach(function(col, idx){ %>
                                                            <div
                                                                class="column-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div
                                                                    class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span
                                                                        class="fw-semibold text-sm">Card
                                                                        #<%= idx + 1 %></span>
                                                                    <button type="button"
                                                                        class="btn btn-sm btn-danger-600 remove-column-btn"><iconify-icon
                                                                            icon="mdi:delete"></iconify-icon></button>
                                                                </div>
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Title:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-title"
                                                                        value="<%= col.title %>"
                                                                        placeholder="e.g., Call Out 1">
                                                                </div>
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Description:</label>
                                                                    <textarea
                                                                        class="form-control border border-neutral-200 radius-8 column-description"
                                                                        rows="3"
                                                                        placeholder="Enter description"><%= col.description %></textarea>
                                                                </div>
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Button
                                                                        Text:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-btn-text"
                                                                        value="<%= col.buttonText %>"
                                                                        placeholder="e.g., More">
                                                                </div>
                                                                <div><label
                                                                        class="form-label text-sm">Button
                                                                        Link:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-btn-link"
                                                                        value="<%= col.buttonLink %>"
                                                                        placeholder="e.g., /learn-more">
                                                                </div>
                                                            </div>
                                                            <% }) %>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='left-heading-image-right-text' ) { %>
                                            <div class="left-heading-image-right-text-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Left Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 lhrt-heading"
                                                        value="<%= section.customFields?.leftHeading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">Upload Left Image</label>
                                                    <div class="upload-image-wrapper">
                                                        <div
                                                            class="uploaded-img-lhrt <%= section.customFields?.image ? '' : 'd-none' %> position-relative w-50 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                                            <img class="uploaded-img-lhrt__preview w-100 h-100 object-fit-cover"
                                                                src="<%= section.customFields?.image || '/images/user.png' %>"
                                                                alt="image">
                                                        </div>
                                                        <label
                                                            class="upload-file-lhrt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                                            <iconify-icon icon="solar:camera-outline"
                                                                class="text-xl text-secondary-light"></iconify-icon>
                                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                                            <input type="file" class="upload-file-lhrt-input" hidden accept="image/*">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Right Text:</label>
                                                    <textarea class="form-control border border-neutral-200 radius-8 lhrt-right-text"
                                                        rows="4"
                                                        placeholder="Text"><%= section.customFields?.rightText || '' %></textarea>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="alert alert-warning">No sections found for this page. Add a new
                                section below.</div>
                        <% } %>
                    </div>

                    <!-- Add Section Button -->
                    <div class="text-center mb-3" id="addSectionBtnContainer">
                        <button type="button" class="btn btn-outline-primary-600 radius-8" id="addSectionBtn">

                            Add Section
                        </button>
                    </div>

                    <hr class="my-3">

                    <!-- Hidden: Original Section Block Template -->
                    <div class="d-none">
                        <!-- template (not a real .section-block so it won't be counted) -->
                        <div class="section-template border border-neutral-300 radius-8 p-4 bg-neutral-50 mb-4"
                            id="originalSection"
                            data-section-id="">
                            <h6 class="text-lg mb-3">Section Content</h6>

                            <!-- Initial section data -->
                            <script>
                                window.INITIAL_SECTIONS = JSON.parse('<%- JSON.stringify(allSections || []) %>');
                            </script>

                            <div class="mb-3">
                                <label class="form-label">Section Type: <span class="text-danger-600">*</span></label>
                                        <select class="form-control border border-neutral-200 radius-8 section-type section-type-select" required>
                                    <option value="image-with-text">Image with Text</option>
                                    <option value="image-with-list">Image with List</option>
                                    <option value="heading-subheading">Heading with Subheading</option>
                                    <option value="left-heading-image-right-text">Left Heading + Image, Right Text
                                    </option>
                                    <option value="right-heading-image-left-text">Right Heading + Image, Left Text
                                    </option>
                                    <option value="hero-section">Hero Section (Left Text + Right Image)</option>
                                    <option value="three-column-info">Three Column Info Cards</option>
                                </select>
                            </div>

                            <!-- template helper script removed (initialization handled globally) -->

                            <!-- Image with Text Fields -->
                            <div
                                class="image-with-text-fields <%= content.sectionType === 'image-with-text' ? 'active' : '' %>">
                                <div class="mb-3">
                                    <label class="form-label">Heading:</label>
                                    <input type="text"
                                        class="form-control border border-neutral-200 radius-8 iwt-heading"
                                        value="<%= content.customFields?.heading || '' %>" placeholder="Heading">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subheading:</label>
                                    <input type="text"
                                        class="form-control border border-neutral-200 radius-8 iwt-subheading"
                                        value="<%= content.customFields?.subheading || '' %>" placeholder="Subheading">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Text:</label>
                                    <textarea class="form-control border border-neutral-200 radius-8 iwt-text" rows="4"
                                        placeholder="Description"><%= content.customFields?.richText || '' %></textarea>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input iwt-left" type="checkbox" id="iwt-left-existing"
                                        <%=content.customFields?.imageOnLeft !==false ? 'checked' : '' %>>
                                    <label class="form-check-label" for="iwt-left-existing">Image on Left</label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-neutral-900">Upload Image</label>
                                    <div class="upload-image-wrapper">
                                        <div
                                            class="uploaded-img-iwt <%= content.customFields?.image ? '' : 'd-none' %> position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                            <button type="button"
                                                class="uploaded-img-iwt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                                <iconify-icon icon="radix-icons:cross-2"
                                                    class="text-2xl text-white"></iconify-icon>
                                            </button>
                                            <img class="uploaded-img-iwt__preview w-100 h-100 object-fit-cover"
                                                src="<%= content.customFields?.image || '/images/user.png' %>"
                                                alt="image">
                                        </div>
                                        <label
                                            class="upload-file-iwt <%= content.customFields?.image ? 'd-none' : '' %> h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                            <iconify-icon icon="solar:camera-outline"
                                                class="text-xl text-secondary-light"></iconify-icon>
                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                            <input type="file" class="upload-file-iwt-input" hidden accept="image/*">
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Image with List Fields -->
                            <div
                                class="image-with-list-fields <%= content.sectionType === 'image-with-list' ? 'active' : '' %>">
                                <div class="mb-3">
                                    <label class="form-label">Heading:</label>
                                    <input type="text"
                                        class="form-control border border-neutral-200 radius-8 iwl-heading"
                                        value="<%= content.customFields?.heading || '' %>" placeholder="Heading">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input iwl-left" type="checkbox" id="iwl-left-existing"
                                        <%=content.customFields?.imageOnLeft !==false ? 'checked' : '' %>>
                                    <label class="form-check-label" for="iwl-left-existing">Image on Left</label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">List Items:</label>
                                    <div class="iwl-items">
                                        <% (content.customFields?.items || []).forEach(function(it){ %>
                                            <div class="iwl-item d-flex align-items-center gap-2 mb-2">
                                                <input type="text"
                                                    class="form-control border border-neutral-200 radius-8 iwl-item-input"
                                                    value="<%= it %>">
                                                <button type="button"
                                                    class="btn btn-sm btn-danger-600 remove-iwl-item">Remove</button>
                                            </div>
                                            <% }) %>
                                    </div>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-iwl-item-btn">Add
                                        Item</button>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-neutral-900">Upload Image</label>
                                    <div class="upload-image-wrapper">
                                        <div
                                            class="uploaded-img-iwl <%= content.customFields?.image ? '' : 'd-none' %> position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                            <button type="button"
                                                class="uploaded-img-iwl__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                                <iconify-icon icon="radix-icons:cross-2"
                                                    class="text-2xl text-white"></iconify-icon>
                                            </button>
                                            <img class="uploaded-img-iwl__preview w-100 h-100 object-fit-cover"
                                                src="<%= content.customFields?.image || '/images/user.png' %>"
                                                alt="image">
                                        </div>
                                        <label
                                            class="upload-file-iwl <%= content.customFields?.image ? 'd-none' : '' %> h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                            <iconify-icon icon="solar:camera-outline"
                                                class="text-xl text-secondary-light"></iconify-icon>
                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                            <input type="file" class="upload-file-iwl-input" hidden accept="image/*">
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Heading + Subheading Fields -->
                            <div
                                class="heading-subheading-fields <%= content.sectionType === 'heading-subheading' ? 'active' : '' %>">
                                <div class="mb-3">
                                    <label class="form-label">Heading:</label>
                                    <input type="text"
                                        class="form-control border border-neutral-200 radius-8 hs-heading"
                                        value="<%= content.customFields?.heading || '' %>" placeholder="Heading">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subheading:</label>
                                    <input type="text"
                                        class="form-control border border-neutral-200 radius-8 hs-subheading"
                                        value="<%= content.customFields?.subheading || '' %>" placeholder="Subheading">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input hs-center" type="checkbox" id="hs-center-existing"
                                        <%=content.customFields?.alignCenter !==false ? 'checked' : '' %>>
                                    <label class="form-check-label" for="hs-center-existing">Center Align</label>
                                </div>
                            </div>

                            <!-- Left Heading + Image, Right Text Fields -->
                            <div
                                class="left-heading-image-right-text-fields <%= content.sectionType === 'left-heading-image-right-text' ? 'active' : '' %>">
                                <div class="mb-3">
                                    <label class="form-label">Left Heading:</label>
                                    <input type="text"
                                        class="form-control border border-neutral-200 radius-8 lhrt-heading"
                                        value="<%= content.customFields?.leftHeading || '' %>" placeholder="Heading">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-neutral-900">Upload Left Image</label>
                                    <div class="upload-image-wrapper">
                                        <div
                                            class="uploaded-img-lhrt <%= content.customFields?.leftImage ? '' : 'd-none' %> position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                            <button type="button"
                                                class="uploaded-img-lhrt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                                <iconify-icon icon="radix-icons:cross-2"
                                                    class="text-2xl text-white"></iconify-icon>
                                            </button>
                                            <img class="uploaded-img-lhrt__preview w-100 h-100 object-fit-cover"
                                                src="<%= content.customFields?.leftImage || '/images/user.png' %>"
                                                alt="image">
                                        </div>
                                        <label
                                            class="upload-file-lhrt <%= content.customFields?.leftImage ? 'd-none' : '' %> h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                            <iconify-icon icon="solar:camera-outline"
                                                class="text-xl text-secondary-light"></iconify-icon>
                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                            <input type="file" class="upload-file-lhrt-input" hidden accept="image/*">
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Right Text:</label>
                                    <textarea class="form-control border border-neutral-200 radius-8 lhrt-right-text"
                                        rows="4"
                                        placeholder="Text"><%= content.customFields?.rightText || '' %></textarea>
                                </div>
                            </div>

                            <!-- Right Heading + Image, Left Text Fields -->
                            <div
                                class="right-heading-image-left-text-fields <%= content.sectionType === 'right-heading-image-left-text' ? 'active' : '' %>">
                                <div class="mb-3">
                                    <label class="form-label">Right Heading:</label>
                                    <input type="text"
                                        class="form-control border border-neutral-200 radius-8 rhlt-heading"
                                        value="<%= content.customFields?.rightHeading || '' %>" placeholder="Heading">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-neutral-900">Upload Right Image</label>
                                    <div class="upload-image-wrapper">
                                        <div
                                            class="uploaded-img-rhlt <%= content.customFields?.rightImage ? '' : 'd-none' %> position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                            <button type="button"
                                                class="uploaded-img-rhlt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                                <iconify-icon icon="radix-icons:cross-2"
                                                    class="text-2xl text-white"></iconify-icon>
                                            </button>
                                            <img class="uploaded-img-rhlt__preview w-100 h-100 object-fit-cover"
                                                src="<%= content.customFields?.rightImage || '/images/user.png' %>"
                                                alt="image">
                                        </div>
                                        <label
                                            class="upload-file-rhlt <%= content.customFields?.rightImage ? 'd-none' : '' %> h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                            <iconify-icon icon="solar:camera-outline"
                                                class="text-xl text-secondary-light"></iconify-icon>
                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                            <input type="file" class="upload-file-rhlt-input" hidden accept="image/*">
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Left Text:</label>
                                    <textarea class="form-control border border-neutral-200 radius-8 rhlt-left-text"
                                        rows="4"
                                        placeholder="Text"><%= content.customFields?.leftText || '' %></textarea>
                                </div>
                            </div>

                            

                            <div class="mb-3">
                                <label class="form-label fw-bold text-neutral-900">Upload Hero Image</label>
                                <div class="upload-image-wrapper">
                                    <div
                                        class="uploaded-img-hero <%= content.heroSection && content.heroSection.rightImage ? '' : 'd-none' %> position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                        <button type="button"
                                            class="uploaded-img-hero__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                            <iconify-icon icon="radix-icons:cross-2"
                                                class="text-2xl text-white"></iconify-icon>
                                        </button>
                                        <img id="uploaded-img-hero__preview" class="w-100 h-100 object-fit-cover"
                                            src="<%= content.heroSection && content.heroSection.rightImage ? content.heroSection.rightImage : '/images/user.png' %>"
                                            alt="image">
                                    </div>
                                    <label
                                        class="upload-file-hero <%= content.heroSection && content.heroSection.rightImage ? 'd-none' : '' %> h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"
                                        for="upload-file-hero">
                                        <iconify-icon icon="solar:camera-outline"
                                            class="text-xl text-secondary-light"></iconify-icon>
                                        <span class="fw-semibold text-secondary-light">Upload Hero Image</span>
                                        <input id="upload-file-hero" type="file" hidden accept="image/*">
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Three Column Info Fields -->
                        <div id="threeColumnFields"
                            class="three-column-info-fields <%= content.sectionType === 'three-column-info' ? 'active' : '' %>">
                            <div class="mb-3">
                                <label class="form-label">Info Cards:</label>
                                <div id="columnContainer">
                                    <% if (content.threeColumnInfo && content.threeColumnInfo.columns &&
                                        content.threeColumnInfo.columns.length> 0) { %>
                                        <% content.threeColumnInfo.columns.forEach(function(column, index) { %>
                                            <div
                                                class="column-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="fw-semibold text-sm">Card #<%= index + 1 %></span>
                                                    <button type="button"
                                                        class="btn btn-sm btn-danger-600 remove-column-btn">
                                                        <iconify-icon icon="mdi:delete"></iconify-icon>
                                                    </button>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label text-sm">Title:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 column-title"
                                                        value="<%= column.title %>" placeholder="e.g., Call Out 1">
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label text-sm">Description:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 column-description"
                                                        rows="3"
                                                        placeholder="Enter description"><%= column.description %></textarea>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label text-sm">Button Text:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 column-btn-text"
                                                        value="<%= column.buttonText %>" placeholder="e.g., More">
                                                </div>
                                                <div>
                                                    <label class="form-label text-sm">Button Link:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 column-btn-link"
                                                        value="<%= column.buttonLink %>"
                                                        placeholder="e.g., /learn-more">
                                                </div>
                                            </div>
                                            <% }) %>
                                                <% } %>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2"
                                    id="addColumnBtn">
                                    Add Info Card
                                </button>
                            </div>
                        </div>
                    </div>
            </div>

            <div class="d-flex align-items-center justify-content-center gap-3">
                <a href="/cms/content-management"
                    class="border border-danger-600 bg-hover-danger-200 text-danger-600 text-md px-56 py-11 radius-8">
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary border border-primary-600 text-md px-56 py-12 radius-8">
                    Update All Sections
                </button>
            </div>
            </form>
        </div>
    </div>
</div>
</div>

<script>
    // Immediately-invoked function expression to avoid polluting the global scope
    (function ($) {
        // Strict mode for cleaner code
        "use strict";

        // Store existing sections from the server in a structured way
        const EXISTING_SECTIONS = <%- JSON.stringify(allSections || []) %>;

        // Centralized function to toggle the visibility of section fields
        function toggleSectionFields($section) {
            const sectionType = $section.find(".section-type-select").val();
            // Hide all fields first for a clean slate
            $section.find("[class$='-fields']").hide();
            // Show only the relevant fields based on section type
            if (sectionType) {
                $section.find(`.${sectionType}-fields`).show();
            }
        }

        // Function to add a new "Image with List" item
        function addIwlItem($container) {
            const newItem = `
                <div class="iwl-item d-flex align-items-center gap-2 mb-2">
                    <input type="text" class="form-control border border-neutral-200 radius-8 iwl-item-input" placeholder="New Item">
                    <button type="button" class="btn btn-sm btn-danger-600 remove-iwl-item">Remove</button>
                </div>`;
            $container.append(newItem);
        }

        // Generic image upload handler to keep code DRY
        function handleImageUpload(inputSelector, previewSelector, removeSelector, wrapperSelector, folderName) {
            $(document).on("change", inputSelector, function (e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const $wrapper = $(this).closest(wrapperSelector);
                    const $preview = $wrapper.find(previewSelector);
                    const $remove = $wrapper.find(removeSelector);
                    const $input = $(this);

                    // Use FileReader for a robust preview
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        $preview.attr("src", event.target.result).show();
                        $remove.show();
                        $input.hide(); // Hide the input label
                    };
                    reader.readAsDataURL(file);

                    // AJAX upload
                    const formData = new FormData();
                    // append folder first so multer's destination sees it when processing the file
                    formData.append("folder", folderName);
                    formData.append("file", file);

                    $.ajax({
                        url: "/api/upload",
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response.success) {
                                // Store the URL in a data attribute for submission
                                $input.data("server-url", response.url);
                                console.log("server-url", response);
                                
                                showToast("Image uploaded successfully", "success");
                            } else {
                                showToast(response.message || "Image upload failed", "error");
                            }
                        },
                        error: function (xhr) {
                            showToast(xhr.responseJSON?.message || "An error occurred", "error");
                        }
                    });
                }
            });

            // Handle image removal
            $(document).on("click", removeSelector, function () {
                const $wrapper = $(this).closest(wrapperSelector);
                $wrapper.find(previewSelector).attr("src", "").hide();
                $(this).hide();
                $wrapper.find(inputSelector).val("").data("server-url", "").show(); // Clear input and data
            });
        }

        // Function to add a new section to the DOM
        function addNewSection() {
            const sectionId = `new-section-${Date.now()}`; // Unique ID for the new section
            const currentCount = $("#sectionsContainer .section-block").length;
            const heading = `Section #${currentCount + 1}`;

            // Clone the hidden template, convert to a real .section-block and clear values
            const $tpl = $("#originalSection").clone();
            $tpl.removeAttr('id').removeClass('d-none').addClass('section-block').attr('data-id', sectionId);
            $tpl.find('h6').text(heading);

            // Clear inputs/textareas and reset selects
            $tpl.find('input[type="text"], textarea').val('');
            $tpl.find('select.section-type, select.section-type-select, select.section-type-select').val('');
            $tpl.find('.section-fields > div').removeClass('active');

            // Reset image previews and upload controls inside the template
            $tpl.find('[class^="uploaded-img-"]').each(function() {
                $(this).addClass('d-none');
            });
            $tpl.find('[class^="upload-file-"]').each(function() {
                $(this).removeClass('d-none');
            });
            $tpl.find('input[type="file"]').val('');

            // Append cleaned-up section to container
            $("#sectionsContainer").append($tpl);
        }

        // Main document ready function
        $(document).ready(function () {
            // Initialize existing sections (only real sections inside the container)
            $("#sectionsContainer .section-block").each(function () {
                toggleSectionFields($(this));
            });

            // Event delegation for dynamic elements
            $("#sectionsContainer")
                .on("change", ".section-type-select", function () {
                    toggleSectionFields($(this).closest(".section-block"));
                })
                .on("click", ".remove-section-btn", function () {
                    $(this).closest(".section-block").remove();
                })
                .on("click", ".add-iwl-item-btn", function () {
                    addIwlItem($(this).siblings(".iwl-items"));
                })
                .on("click", ".remove-iwl-item", function () {
                    $(this).parent().remove();
                });

            // "Add Section" button
            $("#addSectionBtn").on("click", addNewSection);

            // Initialize all image upload handlers
            handleImageUpload(".upload-file-iwt-input", ".uploaded-img-iwt__preview", ".uploaded-img-iwt__remove", ".upload-image-wrapper", "section");
            handleImageUpload(".upload-file-iwl-input", ".uploaded-img-iwl__preview", ".uploaded-img-iwl__remove", ".upload-image-wrapper", "section");
            handleImageUpload(".upload-file-lhrt-input", ".uploaded-img-lhrt__preview", ".uploaded-img-lhrt__remove", ".upload-image-wrapper", "section");
            handleImageUpload(".upload-file-rhlt-input", ".uploaded-img-rhlt__preview", ".uploaded-img-rhlt__remove", ".upload-image-wrapper", "section");
            handleImageUpload(".upload-file-hero-input", ".uploaded-img-hero__preview", ".uploaded-img-hero__remove", ".upload-image-wrapper", "hero");

            // Form submission logic
            $("#editContentForm").on("submit", function (e) {
                e.preventDefault();

                const contentId = $("#contentId").val();
                const pageId = $("#pageId").val();
                const status = $("#status").val();

                if (!pageId) {
                    showToast("Please select a page.", "warning");
                    return;
                }

                const sectionsData = [];
                let isValid = true;

                $("#sectionsContainer .section-block").each(function (index) {
                    const $section = $(this);
                    const sectionType = $section.find(".section-type-select").val();

                    if (!sectionType) {
                        showToast("Please select a section type for all sections.", "warning");
                        isValid = false;
                        return false; // Break the loop
                    }

                    const sectionData = {
                        id: $section.data("id"), // Keep track of the section
                        order: index + 1,
                        sectionType: sectionType,
                        customFields: {},
                        heroSection: {},
                        threeColumnInfo: {}
                    };

                    // Populate data based on section type
                    if (sectionType === "image-with-text") {
                        sectionData.customFields.heading = $section.find(".iwt-heading").val();
                        sectionData.customFields.subheading = $section.find(".iwt-subheading").val();
                        sectionData.customFields.richText = $section.find(".iwt-text").val();
                        sectionData.customFields.image = $section.find(".upload-file-iwt-input").data("server-url") || $section.find(".uploaded-img-iwt__preview").attr("src");
                    } else if (sectionType === "image-with-list") {
                        sectionData.customFields.heading = $section.find(".iwl-heading").val();
                        sectionData.customFields.items = $section.find(".iwl-item-input").map(function () {
                            return $(this).val();
                        }).get();
                        sectionData.customFields.image = $section.find(".upload-file-iwl-input").data("server-url") || $section.find(".uploaded-img-iwl__preview").attr("src");
                    } else if (sectionType === "heading-subheading") {
                        sectionData.customFields.heading = $section.find(".hs-heading").val();
                        sectionData.customFields.subheading = $section.find(".hs-subheading").val();
                        sectionData.customFields.alignCenter = $section.find(".hs-center").is(":checked");
                    } else if (sectionType === "hero-section") {
                        sectionData.heroSection.heading = $section.find(".hero-heading").val();
                        sectionData.heroSection.paragraph = $section.find(".hero-paragraph").val();
                        sectionData.heroSection.rightImage = $section.find(".upload-file-hero-input").data("server-url") || $section.find(".uploaded-img-hero__preview").attr("src");
                    } else if (sectionType === "left-heading-image-right-text") {
                        // Left heading + image on left, right text
                        sectionData.customFields.leftHeading = $section.find('.lhrt-heading').val();
                        sectionData.customFields.leftImage = $section.find('.upload-file-lhrt-input').data('server-url') || $section.find('.uploaded-img-lhrt__preview').attr('src');
                        sectionData.customFields.rightText = $section.find('.lhrt-right-text').val();
                    } else if (sectionType === "right-heading-image-left-text") {
                        // Right heading + image on right, left text
                        sectionData.customFields.rightHeading = $section.find('.rhlt-heading').val();
                        sectionData.customFields.rightImage = $section.find('.upload-file-rhlt-input').data('server-url') || $section.find('.uploaded-img-rhlt__preview').attr('src');
                        sectionData.customFields.leftText = $section.find('.rhlt-left-text').val();
                    } else if (sectionType === "three-column-info") {
                        sectionData.threeColumnInfo.columns = $section.find(".column-item").map(function () {
                            return {
                                title: $(this).find(".column-title").val(),
                                description: $(this).find(".column-description").val(),
                                buttonText: $(this).find(".column-btn-text").val(),
                                buttonLink: $(this).find(".column-btn-link").val()
                            };
                        }).get();
                    }

                    sectionsData.push(sectionData);
                });

                if (!isValid) return;

                // Consolidate all data into one payload
                const payload = {
                    pageId: pageId,
                    status: status,
                    sections: sectionsData
                };

                // Single AJAX call to update everything
                $.ajax({
                    url: `/api/content/${contentId}`,
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function (response) {
                        if (response.success) {
                            showToast("Content updated successfully!", "success");
                            // Redirect after a short delay
                            setTimeout(() => {
                                window.location.href = "/cms/content-management";
                            }, 1000);
                        } else {
                            showToast(response.message || "An error occurred.", "error");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred.", "error");
                    }
                });
            });
        });
    })(jQuery);
</script>