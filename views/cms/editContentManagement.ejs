<div class="row gy-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header border-bottom">
                <h6 class="text-xl mb-0">Manage Content > <%= page.name %></h6>
                <input type="hidden" name="pageTemplate" id="pageTemplate" value="<%= page.template %>">
            </div>
            <div class="card-body p-24">
                <form id="editContentForm" class="d-flex flex-column gap-20">
                    <input type="hidden" id="contentId" value="<%= content._id %>">
                    <input type="hidden" name="frontendUrl" id="frontendUrl" value="<%= frontendUrl %>">
                    <div class="row">
                        <div class="col-lg-8">
                            <div id="sectionsContainer">
                        <% if (allSections && allSections.length> 0) { %>
                            <% allSections.forEach(function(section, index) { %>
                                <div class="section-block border border-neutral-300 radius-8 p-5 bg-neutral-50 mb-3" data-id="<%= section._id %>">
                                  
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="badge custom-badge badge-primary">Template Section</span>
                                    </div>
                                    <div class="mb-3">
                                        <input type="hidden" class="original-section-type"
                                            value="<%= section.sectionType %>">
                                        <!-- <label class="form-label">Section Type: <span -->
                                                <!-- class="text-danger-600">*</span></label> -->
                                        <select class="form-control border border-neutral-200 radius-8 section-type section-type-select"
                                            disabled>
                                            <option value="" <%= !section.sectionType ? 'selected' : '' %>>-- Please Select Section --</option>

                                            <option value="hero-section" <%= section.sectionType === 'hero-section' ? 'selected' : '' %>>Hero Section</option>
                                            <option value="three-column-info" <%= section.sectionType === 'three-column-info' ? 'selected' : '' %>>Header Section</option>
                                            <option value="call-out-cards" <%= section.sectionType === 'call-out-cards' ? 'selected' : '' %>>Call Out Section</option>
                                            <option value="tabs-section" <%= section.sectionType === 'tabs-section' ? 'selected' : '' %>>Tabs Section</option>
                                            <option value="community-groups" <%= section.sectionType === 'community-groups' ? 'selected' : '' %>>Community Groups</option>
                                            <option value="contact-section" <%= section.sectionType === 'contact-section' ? 'selected' : '' %>>Contact Section</option>
                                        </select>
                                    </div>

                                    <!-- server-side renders active fields; per-block JS removed -->

                                    <!-- Dynamic fields based on section type -->
                                    <div class="section-fields asdf">
                                        <!-- <pre><%# JSON.stringify(section, null, 2) %></pre> -->
                                        <% if (section.sectionType==='image-with-text' ) { %>
                                            <div class="image-with-text-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwt-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Subheading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwt-subheading"
                                                        value="<%= section.customFields?.subheading || '' %>"
                                                        placeholder="Subheading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Text:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 iwt-text"
                                                        rows="4"
                                                        placeholder="Description"><%= section.customFields?.richText || '' %></textarea>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='image-with-list' ) { %>
                                            <div class="image-with-list-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 iwl-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">List Items:</label>
                                                    <div class="iwl-items">
                                                        <% (section.customFields?.items || []).forEach(function(it){
                                                            %>
                                                            <div
                                                                class="iwl-item d-flex align-items-center gap-2 mb-2">
                                                                <input type="text"
                                                                    class="form-control border border-neutral-200 radius-8 iwl-item-input"
                                                                    value="<%= it %>">
                                                                <button type="button"
                                                                    class="btn btn-sm btn-danger-600 remove-iwl-item"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                                                            </div>
                                                            <% }) %>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='heading-subheading' ) { %>
                                            <div class="heading-subheading-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hs-heading"
                                                        value="<%= section.customFields?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Subheading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hs-subheading"
                                                        value="<%= section.customFields?.subheading || '' %>"
                                                        placeholder="Subheading">
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input hs-center" type="checkbox"
                                                        <%=section.customFields?.alignCenter ? 'checked' : ''
                                                        %>>
                                                    <label class="form-check-label">Center Align</label>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='hero-section' ) { %>
                                            <div class="hero-section-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 hero-heading"
                                                        value="<%= section.heroSection?.heading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Paragraph:</label>
                                                    <textarea
                                                        class="form-control border border-neutral-200 radius-8 hero-paragraph ckeditor-paragraph"
                                                        rows="4"
                                                        placeholder="Paragraph"><%= section.heroSection?.paragraph || '' %></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Call To Action Buttons:</label>
                                                    <!-- Debug CTAs: <%= JSON.stringify(section.heroSection?.ctas) %> -->
                                                    <div class="cta-container">
                                                        <% if (section.heroSection?.ctas && section.heroSection.ctas.length > 0) { %>
                                                            <% section.heroSection.ctas.forEach(function(cta, index) { %>
                                                                <div class="cta-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                                        <span class="fw-semibold text-sm">CTA Button #<%= index + 1 %></span>
                                                                        <button type="button" class="btn btn-sm btn-danger-600 remove-cta-btn"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label class="form-label text-sm">Button Text:</label>
                                                                        <input type="text" class="form-control border border-neutral-200 radius-8 cta-text"
                                                                            value="<%= cta.text || '' %>" placeholder="e.g., Learn More">
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label class="form-label text-sm">Button Link:</label>
                                                                        <input type="text" class="form-control border border-neutral-200 radius-8 cta-link"
                                                                            value="<%= cta.link || '' %>" placeholder="e.g., /about">
                                                                    </div>
                                                                  
                                                                </div>
                                                            <% }) %>
                                                        <% } %>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-primary mt-3 add-cta-btn">Add CTA Button</button>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">AD Image</label>
                                                    <p class="text-muted small mb-3">Select an advertisement to display</p>
                                                    
                                                    <!-- AD Image Dropdown with Preview -->
                                                    <select class="form-control border border-neutral-200 radius-8 ad-image-select" 
                                                            name="adImage" data-id="<%= section.heroSection?.ad?.id %>"
                                                            data-current-value="<%= section.heroSection?.ad ? JSON.stringify(section.heroSection.ad).replace(/"/g, '&quot;') : '' %>">
                                                        <option value="">-- Select Advertisement --</option>
                                                    </select>

                                                    <!-- AD Preview -->
                                                    <div class="ad-preview-container mt-3" style="display: none;">
                                                        <div class="card">
                                                            <div class="card-body p-3">
                                                                <div class="d-flex align-items-center gap-3">
                                                                    <img class="ad-preview-image" src="" alt="AD Preview" style="width: 80px; height: 60px; object-fit: cover; border-radius: 4px;">
                                                                    <div class="ad-preview-details">
                                                                        <h6 class="ad-preview-title mb-1"></h6>
                                                                        <p class="ad-preview-description text-muted small mb-0"></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <input type="hidden" 
                                                           class="ad-image-input" 
                                                           name="adImage" 
                                                           value="<%= section.heroSection?.ad ? JSON.stringify(section.heroSection.ad).replace(/"/g, '&quot;') : '' %>">
                                                    
                                                    <!-- Debug button to check ad data -->
                                                    <!-- <button type="button" class="btn btn-sm btn-info mt-2 debug-ad-btn">Debug Ad Data</button> -->
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='three-column-info' ) { %>
                                            <!-- <pre><%# JSON.stringify(section) %></pre> -->
                                            <!-- <pre><%# JSON.stringify(section.threeColumnInfo.heading) %></pre> -->
                                            <div class="three-column-info-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Section Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 tci-heading"
                                                        value="<%= section.threeColumnInfo?.heading || '' %>"
                                                        placeholder="Main Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Section Sub-heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 tci-subheading"
                                                        value="<%= section.threeColumnInfo?.subheading || '' %>"
                                                        placeholder="Sub-heading">
                                                </div>
                                                <!-- <div class="form-check mb-3">
                                                    <input class="form-check-input tci-image-left" type="checkbox"
                                                        <%=section.threeColumnInfo?.imageOnLeft ? 'checked' : '' %>>
                                                    <label class="form-check-label">Image on Left</label>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">Upload Section Image</label>
                                                    <div class="upload-image-wrapper">
                                                        <% if (section.threeColumnInfo?.image) { %>
                                                            <div class="mb-3">
                                                                <label class="form-label">Current Image:</label>
                                                                <div class="existing-image">
                                                                    <img src="<%= section.threeColumnInfo.image %>"
                                                                        class="img-thumbnail"
                                                                        style="max-height: 200px;">
                                                                </div>
                                                            </div>
                                                        <% } %>
                                                        <div
                                                            class="uploaded-img-tci d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                                            <button type="button" class="uploaded-img-tci__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle">
                                                                <iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon>
                                                            </button>
                                                            <img class="uploaded-img-tci__preview w-100 h-100 object-fit-cover"
                                                                src="/images/user.png"
                                                                alt="image">
                                                        </div>
                                                        <label
                                                            class="upload-file-tci h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                                            <iconify-icon icon="solar:camera-outline"
                                                                class="text-xl text-secondary-light"></iconify-icon>
                                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                                            <input type="file" class="upload-file-tci-input" hidden accept="image/*" data-existing-image="<%= section.threeColumnInfo?.image || '' %>">
                                                        </label>
                                                    </div>
                                                </div> -->
                                                <div class="mb-3">
                                                    <label class="form-label">Buttons:</label>
                                                    <div class="column-container">

                                                        <% (section.threeColumnInfo?.columns ||
                                                            []).forEach(function(col, idx){ %>
                                                            <div
                                                                class="column-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div
                                                                    class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span
                                                                        class="fw-semibold text-sm">Button
                                                                        #<%= idx + 1 %></span>
                                                                    <span class="badge bg-secondary">Template Button</span>
                                                                </div>
                                                                <!-- <div class="mb-2"><label
                                                                        class="form-label text-sm">Title:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-title"
                                                                        value="<%= col.title %>"
                                                                        placeholder="e.g., Call Out 1">
                                                                </div>
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Description:</label>
                                                                    <textarea
                                                                        class="form-control border border-neutral-200 radius-8 column-description"
                                                                        rows="3"
                                                                        placeholder="Enter description"><%= col.description %></textarea>
                                                                </div> -->
                                                                <div class="mb-2"><label
                                                                        class="form-label text-sm">Button
                                                                        Text:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-btn-text"
                                                                        value="<%= col.buttonText %>"
                                                                        placeholder="e.g., More">
                                                                </div>
                                                                <div><label
                                                                        class="form-label text-sm">Button
                                                                        Link:</label>
                                                                    <input type="text"
                                                                        class="form-control border border-neutral-200 radius-8 column-btn-link"
                                                                        value="<%= col.buttonLink %>"
                                                                        placeholder="e.g., /learn-more">
                                                                </div>
                                                            </div>
                                                        <% }) %>


                                                    </div>
                                                    <small class="text-muted">Buttons are defined by the page template</small>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='call-out-cards' ) { %>
                                            <div class="call-out-cards-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Card Carousels:</label>
                                                    <!-- Debug: <%= JSON.stringify(section.callOutCards) %> -->
                                                    <div class="callout-container">
                                                        <%
                                                        const cards = section.callOutCards?.cards || [];
                                                        if (cards.length === 0) { %>
                                                            <p class="text-muted">No cards found. Click "Add Call Out Card" to create one.</p>
                                                        <% }
                                                        cards.forEach(function(card, idx){ %>
                                                            <div class="callout-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <span class="fw-semibold text-sm">Card #<%= idx + 1 %></span>
                                                                        <span class="badge custom-badge bg-secondary">Template Card</span>
                                                                    </div>
                                                                    <% if(page.template != 'legislation'){ %>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-callout-btn">
                                                                        <iconify-icon icon="material-symbols:delete-outline"></iconify-icon>
                                                                    </button>
                                                                    <% } %>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Heading: <span class="text-danger-600">*</span></label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 callout-heading"
                                                                        value="<%= card.heading %>" placeholder="e.g., Call Out 1">
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Paragraph:</label>
                                                                    <textarea class="form-control border border-neutral-200 radius-8 callout-subheading ckeditor-paragraph" rows="5"
                                                                        placeholder="Enter subheading"><%= card.subheading || '' %></textarea>
                                                                </div>
                                                                <div>
                                                                    <label class="form-label text-sm">Link:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 callout-link"
                                                                        value="<%= card.link || '' %>" placeholder="e.g., /more">
                                                                </div>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                    <% if(page.template != 'legislation'){ %>
                                                    
                                                                                           <button type="button" class="btn btn-sm btn-primary  mt-3 add-callout-btn">
                                                        Add Call Out Card
                                                    </button>
                                                    <small class="text-muted d-block mt-3">Max: 6 cards</small>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='tabs-section' ) { %>
                                            <div class="tabs-section-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Tabs:</label>
                                                    <div class="tabs-container">
                                                        <%
                                                        const tabs = section.tabsSection?.tabs || [];
                                                        if (tabs.length === 0) { %>
                                                            <p class="text-muted">No tabs found. Click "Add Tab" to create one.</p>
                                                        <% }
                                                        tabs.forEach(function(tab, idx){ %>
                                                            <div class="tab-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <span class="fw-semibold text-sm">Tab #<%= idx + 1 %></span>
                                                                    <button type="button" class="btn btn-sm btn-danger-600 remove-tab-btn"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Title:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-title"
                                                                        value="<%= tab.title || '' %>" placeholder="Tab Title">
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label text-sm">Heading:</label>
                                                                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-heading"
                                                                        value="<%= tab.heading || '' %>" placeholder="Tab Heading">
                                                                </div>
                                                                <div>
                                                                    <label class="form-label text-sm">Paragraph:</label>
                                                                    <textarea class="form-control border border-neutral-200 radius-8 tab-paragraph ckeditor-paragraph" rows="3"
                                                                        placeholder="Tab content"><%= tab.paragraph || '' %></textarea>
                                                                </div>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-tab-btn">Add Tab</button>
                                                    <small class="text-muted d-block mt-3">You can add or remove tabs as needed</small>
                                                </div>
                                            </div>
                                        <% } else if (section.sectionType==='community-groups' ) { %>
                                            <div class="community-groups-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Section Heading:</label>
                                                    <input type="text" class="form-control border border-neutral-200 radius-8 cg-heading"
                                                        value="<%= section.communityGroups?.heading || '' %>" placeholder="Community Groups">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Section Subheading:</label>
                                                    <input type="text" class="form-control border border-neutral-200 radius-8 cg-subheading"
                                                        value="<%= section.communityGroups?.subheading || '' %>" placeholder="Explore our community groups">
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">Display Order:</label>
                                                    <select class="form-control border border-neutral-200 radius-8 cg-display-order">
                                                        <option value="manual" <%= (section.communityGroups?.displayOrder || 'manual') === 'manual' ? 'selected' : '' %>>Manual Order</option>
                                                        <option value="alphabetical" <%= section.communityGroups?.displayOrder === 'alphabetical' ? 'selected' : '' %>>Alphabetical</option>
                                                        <option value="date" <%= section.communityGroups?.displayOrder === 'date' ? 'selected' : '' %>>Date Created</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Selected Pages:</label>
                                                    <div class="community-pages-container">
                                                        <div id="available-pages" class="mb-3">
                                                            <label class="form-label text-sm">Available Pages:</label>
                                                            <div class="available-pages-list border border-neutral-200 radius-8 p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                                                <p class="text-muted text-sm">Loading pages...</p>
                                                            </div>
                                                        </div>
                                                        <div id="selected-pages" class="mb-3">
                                                            <label class="form-label text-sm">Selected Pages (drag to reorder):</label>
                                                            <div class="selected-pages-list border border-neutral-200 radius-8 p-3 sortable-container" style="min-height: 100px;">
                                                                <% if (section.communityGroups?.selectedPages && section.communityGroups.selectedPages.length > 0) { %>
                                                                    <% section.communityGroups.selectedPages.forEach(function(selectedPage, idx) { %>
                                                                        <div class="selected-page-item border border-neutral-300 radius-4 p-2 mb-2 bg-white d-flex justify-content-between align-items-center" data-page-id="<%= selectedPage.page._id %>" data-order="<%= selectedPage.order %>">
                                                                            <span class="page-name"><%= selectedPage.page.name %></span>
                                                                            <button type="button" class="btn btn-sm btn-danger remove-page-btn">Remove</button>
                                                                        </div>
                                                                    <% }) %>
                                                                <% } else { %>
                                                                    <p class="text-muted text-sm">No pages selected. Click on available pages to add them.</p>
                                                                <% } %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">Select pages to display in this community groups section</small>
                                                </div>
                                            </div>
                                            <% } else if (section.sectionType==='contact-section' ) { %>
                                                <div class="contact-section-fields active">
                                                    <div class="mb-3">
                                                        <label class="form-label">Section Heading:</label>
                                                        <input type="text" class="form-control border border-neutral-200 radius-8 cs-heading"
                                                            value="<%= section.contactSection?.heading || '' %>" placeholder="Heading">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Section Subheading:</label>
                                                        <input type="text" class="form-control border border-neutral-200 radius-8 cs-subheading"
                                                            value="<%= section.contactSection?.subheading || '' %>" placeholder="Subheading">
                                                    </div>

                                                    <div class="mb-3 border-top pt-3">
                                                        <label class="form-label fw-semibold">Email Block</label>
                                                        <div class="mb-2">
                                                            <input type="text" class="form-control border border-neutral-200 radius-8 cs-email-heading"
                                                                value="<%= section.contactSection?.email?.heading || '' %>" placeholder="Email Heading">
                                                        </div>
                                                        <div class="mb-2">
                                                            <input type="text" class="form-control border border-neutral-200 radius-8 cs-email-subheading"
                                                                value="<%= section.contactSection?.email?.subheading || '' %>" placeholder="Email Subheading">
                                                        </div>
                                                        <div class="mb-2">
                                                            <input type="email" class="form-control border border-neutral-200 radius-8 cs-email-address"
                                                                value="<%= section.contactSection?.email?.address || '' %>" placeholder="address@domain.org">
                                                        </div>
                                                    </div>

                                                    <div class="mb-3 border-top pt-3">
                                                        <label class="form-label fw-semibold">Call Block</label>
                                                        <div class="mb-2">
                                                            <input type="text" class="form-control border border-neutral-200 radius-8 cs-call-heading"
                                                                value="<%= section.contactSection?.call?.heading || '' %>" placeholder="Call Heading">
                                                        </div>
                                                        <div class="mb-2">
                                                            <input type="text" class="form-control border border-neutral-200 radius-8 cs-call-subheading"
                                                                value="<%= section.contactSection?.call?.subheading || '' %>" placeholder="Call Subheading">
                                                        </div>
                                                        <div class="mb-2">
                                                            <input type="text" class="form-control border border-neutral-200 radius-8 cs-call-phone"
                                                                value="<%= section.contactSection?.call?.phone || '' %>" placeholder="+1 (555) 123-4567">
                                                        </div>
                                                    </div>

                                                    <div class="mb-3 border-top pt-3">
                                                        <label class="form-label fw-semibold">General Contact Form</label>
                                                        <div class="mb-2">
                                                            <input type="text" class="form-control border border-neutral-200 radius-8 cs-form-heading"
                                                                value="<%= section.contactSection?.generalContactForm?.heading || '' %>" placeholder="Form Heading">
                                                        </div>
                                                        <div class="mb-2">
                                                            <input type="text" class="form-control border border-neutral-200 radius-8 cs-form-subheading"
                                                                value="<%= section.contactSection?.generalContactForm?.subheading || '' %>" placeholder="Form Subheading">
                                                        </div>
                                                        <div class="mb-2">
                                                            <input type="text" class="form-control border border-neutral-200 radius-8 cs-form-link"
                                                                value="<%= section.contactSection?.generalContactForm?.openFormLink || '' %>" placeholder="/forms/contact">
                                                        </div>
                                                    </div>

                                                    <div class="mb-3 border-top pt-3">
                                                        <label class="form-label fw-semibold">Helpful Links</label>
                                                        <div class="cs-helpful-links-list">
                                                            <% (section.contactSection?.helpfulLinks || []).forEach(function(link, idx){ %>
                                                                <div class="d-flex align-items-center gap-2 mb-2 cs-helpful-item">
                                                                    <input type="text" class="form-control cs-helpful-text" value="<%= link.text %>" placeholder="Button text">
                                                                    <input type="text" class="form-control cs-helpful-link" value="<%= link.link %>" placeholder="/path or https://...">
                                                                    <button type="button" class="btn btn-sm btn-danger-600 remove-helpful-link"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                                                                </div>
                                                            <% }) %>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-primary mt-2 add-helpful-link-btn">Add Helpful Link</button>
                                                    </div>
                                                </div>
                                        <% } else if (section.sectionType==='left-heading-image-right-text' ) { %>
                                            <div class="left-heading-image-right-text-fields active">
                                                <div class="mb-3">
                                                    <label class="form-label">Left Heading:</label>
                                                    <input type="text"
                                                        class="form-control border border-neutral-200 radius-8 lhrt-heading"
                                                        value="<%= section.customFields?.leftHeading || '' %>"
                                                        placeholder="Heading">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold text-neutral-900">Upload Left Image</label>
                                                    <div class="upload-image-wrapper mt-5">
                                                        <div
                                                            class="uploaded-img-lhrt <%= section.customFields?.image ? '' : 'd-none' %> position-relative w-30 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50">
                                                            <img class="uploaded-img-lhrt__preview w-100 h-100 object-fit-cover"
                                                                src="<%= section.customFields?.image || '/images/user.png' %>"
                                                                alt="image">
                                                        </div>
                                                        <label
                                                            class="upload-file-lhrt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1">
                                                            <iconify-icon icon="solar:camera-outline"
                                                                class="text-xl text-secondary-light"></iconify-icon>
                                                            <span class="fw-semibold text-secondary-light">Upload Image</span>
                                                            <input type="file" class="upload-file-lhrt-input" hidden accept="image/*">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Right Text:</label>
                                                    <textarea class="form-control border border-neutral-200 radius-8 lhrt-right-text"
                                                        rows="4"
                                                        placeholder="Text"><%= section.customFields?.rightText || '' %></textarea>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="alert alert-warning">No sections found for this page. Add a new
                                section below.</div>
                        <% } %>
                    </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="page-status-widget">
                                <!-- <div>
                                    <label class="form-label" for="pageId">Select Page: <span class="text-danger-600">*</span></label>
                                    <select class="form-control border border-neutral-200 radius-8" id="pageId" name="pageId" disabled>
                                        <option value="">-- Select a Page --</option>
                                        <% if (typeof pages !=='undefined' && pages.length> 0) { %>
                                            <% pages.forEach(page=> { %>
                                                <option value="<%= page._id %>" <%=content.page && content.page._id.toString()===page._id.toString()
                                                    ? 'selected' : '' %>><%= page.name %>
                                                </option>
                                                <% }) %>
                                                    <% } %>
                                    </select>
                                </div> -->
                                <input type="hidden" name="pageId" id="pageId" value="<%= page._id %>">

                                <div>
                                    <label class="form-label">Status: </label>
                                    <% if (page.path === '/') { %>
                                          <select class="form-select form-select-sm" id="status" name="status" disabled title="Home page must remain published">
                                            <option value="active" selected>Publish</option>
                                        </select>
                                    <% } else { %>
                                        <select class="form-select form-select-sm" id="status" name="status">
                                            <option value="inactive" <%=page.status=='inactive' ? 'selected' : '' %>>Draft</option>
                                            <option value="active" <%=page.status=='active' ? 'selected' : '' %>>Publish</option>
                                        </select>
                                    <% } %>
                                </div>
                            </div>

                            <!-- Thumbnail Selection for Pages with Category -->
                            <% if (page.category && page.category.trim() !== '') { %>
                            <div class="page-thumbnail-widget mt-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Page Thumbnail</h6>
                                        <small class="text-muted">Select a thumbnail image for this page</small>
                                    </div>
                                    <div class="card-body">
                                        <!-- Current Thumbnail Preview -->
                                        <% if (page.thumbnail) { %>
                                        <div class="current-thumbnail-preview mb-3">
                                            <!-- <label class="form-label text-sm">Current Thumbnail:</label> -->
                                            <div class="thumbnail-preview-container">
                                                <img src="<%= page.thumbnail %>" 
                                                     alt="Current Thumbnail" 
                                                     class="img-thumbnail current-thumbnail-img" 
                                                     style="max-width: 150px; max-height: 100px; object-fit: cover;">
                                            </div>
                                        </div>
                                        <% } %>

                                        <!-- Thumbnail Selection Button -->
                                        <button type="button" 
                                                class="btn btn-outline-primary btn-sm w-100 select-thumbnail-btn"
                                                data-current-thumbnail="<%= page.thumbnail || '' %>">
                                            <iconify-icon icon="solar:gallery-outline" class="me-2"></iconify-icon>
                                            <%= page.thumbnail ? 'Change Thumbnail' : 'Select Thumbnail' %>
                                        </button>

                                        <!-- Hidden input to store selected thumbnail URL -->
                                        <input type="hidden" 
                                               name="pageThumbnail" 
                                               id="pageThumbnail" 
                                               value="<%= page.thumbnail || '' %>">

                                        <!-- Remove Thumbnail Button -->
                                        <% if (page.thumbnail) { %>
                                        <button type="button" 
                                                class="btn btn-outline-danger btn-sm w-100 mt-2 remove-thumbnail-btn">
                                            <iconify-icon icon="solar:trash-bin-minimalistic-outline" class="me-2"></iconify-icon>
                                            Remove Thumbnail
                                        </button>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                            <div class="d-flex publish-btns mt-3">
                                <a href="/page-master/edit-page/<%= page._id %>"
                                    class="btn btn-sm btn-outline-secondary">
                                    Back
                                </a>
                               <button type="button" id="updateAndSeoBtn" class="btn btn-sm btn-outline-primary">
                                    Edit SEO Details
                                </button>
                                <button type="submit" class="btn btn-sm btn-primary">
                                    Save 
                                </button>
                               
                            </div>
                        </div>


                    </div>

                    <!-- <hr class="my-3"> -->

                    <!-- Sections Container -->

                    <!-- commented out tyoes -->
                    <!--
                    in another file
                     -->


                    <!-- Template-based sections only - no manual section addition -->
                    <!-- <div class="alert alert-info text-center">
                        <small><strong>Note:</strong> This page uses a predefined template. To change the section structure, edit the page template in <a href="/page-master/web-page-master">Page Master</a>.</small>
                    </div> -->

                    <!-- <hr class="my-3"> -->

                    <!-- Hidden: Section Block Template -->
                     <!--
                    // commeneted out types
                        /*
                        <option value="image-with-text">Image with Text</option>
                        <option value="image-with-list">Image with List</option>
                        <option value="heading-subheading">Heading with Subheading</option>
                        <option value="left-heading-image-right-text">Left Heading + Image, Right Text</option>
                        <option value="right-heading-image-left-text">Right Heading + Image, Left Text</option>
                        <option value="hero-section">Hero Section (Left Text + Right Image)</option>
                        */ -->
                    <div class="d-none">
                        <div id="originalSection">
                            <div class="section-block border border-neutral-300 radius-8 p-5 mb-4 bg-neutral-50" data-section-id="__ID__">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-lg mb-0">Section #__ID__</h6>
                                    <button type="button" class="btn btn-sm btn-danger-600 remove-section-btn">Remove Section</button>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Section Type: <span class="text-danger-600">*</span></label>
                                    <select class="form-control border border-neutral-200 radius-8 section-type-select" >
                                        <option value="">-- Please Select Section --</option>

                                        <option value="hero-section">Hero Section</option>
                                        <option value="three-column-info">Header Section</option>
                                        <option value="call-out-cards">Call Out Section</option>
                                        <option value="tabs-section">Tabs Section</option>
                                        <option value="contact-section">Contact Section</option>
                                    </select>
                                </div>
                               <div class="image-with-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label">Paragraph:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwt-subheading" placeholder="Subheading"></div>
                                    <div class="mb-3"><label class="form-label">Text:</label><textarea class="form-control border border-neutral-200 radius-8 iwt-text" rows="4" placeholder="Description"></textarea></div>
                                    <div class="form-check mb-3"><input class="form-check-input iwt-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Image</label><div class="upload-image-wrapper mt-5"><div class="uploaded-img-iwt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-iwt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-iwt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-iwt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-iwt-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="image-with-list-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 iwl-heading" placeholder="Heading"></div>
                                    <div class="form-check mb-3"><input class="form-check-input iwl-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label">List Items:</label><div class="iwl-items"></div><button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-iwl-item-btn">Add Item</button></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Image</label><div class="upload-image-wrapper mt-5"><div class="uploaded-img-iwl d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-iwl__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-iwl__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-iwl h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-iwl-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="heading-subheading-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 hs-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label">Subheading:</label><input type="text" class="form-control border border-neutral-200 radius-8 hs-subheading" placeholder="Subheading"></div>
                                    <div class="form-check mb-3"><input class="form-check-input hs-center" type="checkbox" checked><label class="form-check-label">Center Align</label></div>
                                </div>
                                <div class="left-heading-image-right-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Left Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 lhrt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Left Image</label><div class="upload-image-wrapper mt-5"><div class="uploaded-img-lhrt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-lhrt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-lhrt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-lhrt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-lhrt-input" hidden accept="image/*"></label></div></div>
                                    <div class="mb-3"><label class="form-label">Right Text:</label><textarea class="form-control border border-neutral-200 radius-8 lhrt-right-text" rows="4" placeholder="Text"></textarea></div>
                                </div>
                                <div class="right-heading-image-left-text-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Right Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 rhlt-heading" placeholder="Heading"></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Right Image</label><div class="upload-image-wrapper mt-5"><div class="uploaded-img-rhlt d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-rhlt__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-rhlt__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-rhlt h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-rhlt-input" hidden accept="image/*"></label></div></div>
                                    <div class="mb-3"><label class="form-label">Left Text:</label><textarea class="form-control border border-neutral-200 radius-8 rhlt-left-text" rows="4" placeholder="Text"></textarea></div>
                                </div>
                                <div class="hero-section-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Heading: <span class="text-danger-600">*</span></label><input type="text" class="form-control border border-neutral-200 radius-8 hero-heading" placeholder="Enter main heading"></div>
                                    <div class="mb-3"><label class="form-label">Paragraph:</label><textarea class="form-control border border-neutral-200 radius-8 hero-paragraph" rows="4" placeholder="Description"></textarea></div>
                                    <div class="mb-3"><label class="form-label">Call To Action Buttons:</label><div class="cta-container"></div><button type="button" class="btn btn-sm btn-primary  mt-3 add-cta-btn">Add CTA Button</button></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Right Image</label><div class="upload-image-wrapper mt-5"><div class="uploaded-img-hero d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-hero__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-hero__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-hero h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-hero-input" hidden accept="image/*"></label></div></div>
                                </div>
                                <div class="three-column-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Section Heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 tci-heading" placeholder="Main Heading"></div>
                                    <div class="mb-3"><label class="form-label">Section Sub-heading:</label><input type="text" class="form-control border border-neutral-200 radius-8 tci-subheading" placeholder="Sub-heading"></div>
                                    <!-- <div class="form-check mb-3"><input class="form-check-input tci-image-left" type="checkbox" checked><label class="form-check-label">Image on Left</label></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-neutral-900">Upload Section Image</label><div class="upload-image-wrapper"><div class="uploaded-img-tci d-none position-relative h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50"><button type="button" class="uploaded-img-tci__remove position-absolute top-0 end-0 z-1 text-2xxl line-height-1 me-8 mt-8 d-flex bg-danger-600 w-40-px h-40-px justify-content-center align-items-center rounded-circle"><iconify-icon icon="radix-icons:cross-2" class="text-2xl text-white"></iconify-icon></button><img class="uploaded-img-tci__preview w-100 h-100 object-fit-cover" src="/images/user.png" alt="image"></div><label class="upload-file-tci h-200-px w-100 border input-form-light radius-8 overflow-hidden border-dashed bg-neutral-50 bg-hover-neutral-200 d-flex align-items-center flex-column justify-content-center gap-1"><iconify-icon icon="solar:camera-outline" class="text-xl text-secondary-light"></iconify-icon><span class="fw-semibold text-secondary-light">Upload Image</span><input type="file" class="upload-file-tci-input" hidden accept="image/*"></label></div></div>  -->
                                    <div class="mb-3">
                                        <label class="form-label">Buttons:</label>
                                        <div class="column-container"></div>
                                        <button type="button" class="btn btn-sm btn-outline-primary-600 radius-8 mt-2 add-column-btn">Add Button</button>
                                    </div>
                                </div>
                                <div class="call-out-cards-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Call Out Section:</label><div class="callout-container"></div><button type="button" class="btn btn-sm btn-primary  mt-3 add-callout-btn">Add Call Out Card</button><small class="text-muted d-block mt-3">Min: 1 card, Max: 6 cards</small></div>
                                </div>
                                <div class="tabs-section-fields" style="display: none;">
                                    <div class="mb-3"><label class="form-label">Tabs:</label><div class="tabs-container"></div><small class="text-muted d-block mt-3">8 tabs will be created automatically</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>


            </form>
        </div>
    </div>
</div>
</div>

<style>
/* Community Groups Sortable Styles */
.sortable-container .selected-page-item {
    cursor: move;
    transition: all 0.2s ease;
}

.sortable-container .selected-page-item:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.sortable-ghost {
    opacity: 0.4;
    background-color: #e9ecef !important;
}

.sortable-chosen {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
}

.sortable-drag {
    background-color: #ffffff !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: rotate(5deg);
}

.selected-page-item::before {
    content: "";
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 12px;
    line-height: 1;
}

.selected-page-item {
    position: relative;
    padding-left: 25px !important;
}

/* CKEditor 5 List Styles Fix */
.ck-content ol {
    list-style-type: decimal !important;
    padding-left: 40px !important;
    margin-left: 0 !important;
}

.ck-content ul {
    list-style-type: disc !important;
    padding-left: 40px !important;
    margin-left: 0 !important;
}

.ck-content ol li,
.ck-content ul li {
    display: list-item !important;
    margin-left: 0 !important;
}

.ck-content ol li::marker {
    display: inline-block !important;
}

.ck-content ul li::marker {
    display: inline-block !important;
}

/* CKEditor 5 Text Formatting Styles */
.ck-content em,
.ck-content i {
    font-style: italic !important;
}

.ck-content u {
    text-decoration: underline !important;
}

.ck-content strong,
.ck-content b {
    font-weight: bold !important;
}

.ck-content a {
    color: #0066cc !important;
    text-decoration: underline !important;
}

.ck-content a:hover {
    color: #004499 !important;
    text-decoration: underline !important;
}

/* CKEditor 5 Image Styles Fix */
.ck-content img {
    max-width: 100% !important;
    height: auto !important;
    display: block !important;
}

.ck-content figure.image {
    display: table !important;
    clear: both !important;
    text-align: center !important;
    margin: 1em auto !important;
}

.ck-content figure.image img {
    display: block !important;
    margin: 0 auto !important;
    max-width: 100% !important;
    min-width: 50px !important;
}

.ck-content figure.image.image-style-side {
    float: right !important;
    margin-left: 1.5em !important;
    max-width: 50% !important;
}

.ck-content figure.image.image-style-align-left {
    float: left !important;
    margin-right: 1.5em !important;
}

.ck-content figure.image.image-style-align-right {
    float: right !important;
    margin-left: 1.5em !important;
}

/* Ensure images load properly */
.ck-editor__editable img {
    max-width: 100% !important;
    height: auto !important;
}

.ck.ck-editor__editable img {
    max-width: 100% !important;
    height: auto !important;
}

/* Media Library Button Styles */
/* .media-library-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.media-library-btn:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
} */

/* WordPress-style Image Size Classes */
.ck-content .wp-image {
    height: auto;
    max-width: 100%;
}

.ck-content .size-thumbnail {
    max-width: 150px;
    max-height: 150px;
}

.ck-content .size-medium {
    max-width: 300px;
    max-height: 300px;
}

.ck-content .size-medium_large {
    max-width: 768px;
    height: auto;
}

.ck-content .size-large {
    max-width: 1024px;
    max-height: 1024px;
}

.ck-content .size-full {
    max-width: 100%;
    height: auto;
}

/* Image Size Selection Modal Styles */
.image-size-options .form-check-label {
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.image-size-options .form-check-label:hover {
    background-color: #f8f9fa;
}

.image-size-options .form-check-input:checked + .form-check-label {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.size-preview-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.selected-images-preview {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
}
</style>

<script src="https://cdn.ckeditor.com/ckeditor5/43.3.1/superbuild/ckeditor.js"></script>
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.css" />

<!-- Alternative CKEditor build with more plugins -->
<script>
// Fallback to CKEditor 4 if CKEditor 5 plugins are not available
window.ckEditorFallback = function() {
    // console.log('Loading CKEditor 4 as fallback...');
    const script = document.createElement('script');
    script.src = 'https://cdn.ckeditor.com/4.22.1/full/ckeditor.js';
    document.head.appendChild(script);
    
    script.onload = function() {
        // console.log('CKEditor 4 loaded as fallback');
        initCKEditor4();
    };
};
</script>

<!-- Pass ads and media data to JavaScript -->
<script>
    window.adsData = <%-JSON.stringify(ads || [])%>;
    window.mediaData = <%-JSON.stringify(media || [])%>;
    
    // Debug: Show what section data is being passed
    console.log(' Server-side section data loaded');
</script>

<% script=`<script>
    // CKEditor 5 instances storage
    let editorInstances = {};
    
    // Toast notification function (same as ads management)
    function showToast(message, type) {
        // Remove any existing toasts first
        var existingToasts = document.querySelectorAll('.custom-toast');
        existingToasts.forEach(function (toast) { toast.remove(); });

        // Create toast element
        var toast = document.createElement('div');
        var alertType = type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info';
        toast.className = 'alert alert-' + alertType + ' position-fixed shadow-lg custom-toast';
        toast.style.cssText = 'top: 80px; right: 20px; z-index: 999999; min-width: 400px; max-width: 600px; border-radius: 12px; font-size: 16px; padding: 20px; border: 2px solid;';

        // Set border color based on type
        if (type === 'success') {
            toast.style.borderColor = '#28a745';
            toast.style.backgroundColor = '#d4edda';
            toast.style.color = '#155724';
        } else if (type === 'error') {
            toast.style.borderColor = '#dc3545';
            toast.style.backgroundColor = '#f8d7da';
            toast.style.color = '#721c24';
        }

        var iconEmoji = type === 'error' ? '' : type === 'success' ? '' : '';
        toast.innerHTML = '<div class="d-flex align-items-center">' +
            '<span style="font-size: 24px; margin-right: 12px;">' + iconEmoji + '</span>' +
            '<span style="font-weight: 600; flex-grow: 1;">' + message + '</span>' +
            '<button type="button" style="background: none; border: none; font-size: 20px; cursor: pointer; margin-left: 10px;" onclick="this.parentElement.parentElement.remove()"></button>' +
            '</div>';

        document.body.appendChild(toast);

        // Add entrance animation
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'transform 0.3s ease-out';
        setTimeout(function () {
            toast.style.transform = 'translateX(0)';
        }, 10);

        // Auto remove after duration based on type
        var duration = type === 'success' ? 4000 : 6000;
        setTimeout(function () {
            if (toast.parentElement) {
                toast.style.transform = 'translateX(100%)';
                setTimeout(function () { toast.remove(); }, 300);
            }
        }, duration);
    }

    // Media Picker functionality for image uploads (same as ads management)
    
    // Helper function to create media picker for image uploads
    function createImageMediaPicker(targetClass, previewClass, hiddenInputClass) {
        return new MediaPicker({
            allowedTypes: ['image'],
            title: 'Select or Upload Image',
            buttonText: 'Select Image',
            multiple: false,
            onSelect: function(selectedMedia) {
                console.log('Image selected:', selectedMedia);
                
                // Update preview
                const previewElement = document.querySelector(previewClass);
                if (previewElement) {
                    previewElement.src = selectedMedia.src;
                    previewElement.closest('.uploaded-img-' + targetClass.replace('upload-file-', '').replace('-input', '')).classList.remove('d-none');
                }
                
                // Update hidden input if exists
                const hiddenInput = document.querySelector(hiddenInputClass);
                if (hiddenInput) {
                    hiddenInput.value = selectedMedia.src;
                }
                
                showToast('Image selected successfully', 'success');
            }
        });
    }
    
    // Initialize media pickers for all image upload sections
    $(document).ready(function() {
        // Replace file input clicks with media picker
        $(document).on('click', '.upload-file-tci', function(e) {
            e.preventDefault();
            const mediaPicker = createImageMediaPicker('upload-file-tci', '.uploaded-img-tci__preview', 'input[name="tci-image"]');
            mediaPicker.open();
        });
        
        $(document).on('click', '.upload-file-lhrt', function(e) {
            e.preventDefault();
            const mediaPicker = createImageMediaPicker('upload-file-lhrt', '.uploaded-img-lhrt__preview', 'input[name="lhrt-image"]');
            mediaPicker.open();
        });
        
        $(document).on('click', '.upload-file-iwt', function(e) {
            e.preventDefault();
            const mediaPicker = createImageMediaPicker('upload-file-iwt', '.uploaded-img-iwt__preview', 'input[name="iwt-image"]');
            mediaPicker.open();
        });
        
        $(document).on('click', '.upload-file-iwl', function(e) {
            e.preventDefault();
            const mediaPicker = createImageMediaPicker('upload-file-iwl', '.uploaded-img-iwl__preview', 'input[name="iwl-image"]');
            mediaPicker.open();
        });
        
        $(document).on('click', '.upload-file-rhlt', function(e) {
            e.preventDefault();
            const mediaPicker = createImageMediaPicker('upload-file-rhlt', '.uploaded-img-rhlt__preview', 'input[name="rhlt-image"]');
            mediaPicker.open();
        });
        
        $(document).on('click', '.upload-file-hero', function(e) {
            e.preventDefault();
            const mediaPicker = createImageMediaPicker('upload-file-hero', '.uploaded-img-hero__preview', 'input[name="hero-image"]');
            mediaPicker.open();
        });
        
        // Handle remove image buttons
        $(document).on('click', '[class*="uploaded-img-"][class*="__remove"]', function() {
            const uploadedContainer = $(this).closest('[class*="uploaded-img-"]');
            const className = uploadedContainer.attr('class').match(/uploaded-img-(\w+)/)[1];
            
            uploadedContainer.addClass('d-none');
            
            // Clear hidden input if exists
            const hiddenInput = document.querySelector(\`input[name="\${className}-image"]\`);
            if (hiddenInput) {
                hiddenInput.value = '';
            }
            
            showToast('Image removed', 'info');
        });
    });

    // WordPress-style image size options
    const imageSizeOptions = {
        'thumbnail': { width: 150, height: 150, label: 'Thumbnail (150x150)' },
        'medium': { width: 300, height: 300, label: 'Medium (300x300)' },
        'medium_large': { width: 768, height: 0, label: 'Medium Large (768px width)' },
        'large': { width: 1024, height: 1024, label: 'Large (1024x1024)' },
        'full': { width: 0, height: 0, label: 'Full Size (Original)' }
    };

    // Function to generate image with size styling
    function getImageWithSizeStyle(originalUrl, sizeKey, alt, mediaId) {
        const size = imageSizeOptions[sizeKey];
        
        if (sizeKey === 'full' || !size) {
            return '<img src="' + originalUrl + '" alt="' + alt + '" class="wp-image-' + mediaId + '" />';
        }
        
        let style = '';
        let className = 'wp-image-' + mediaId + ' size-' + sizeKey;
        
        // Add size constraints
        if (size.width > 0 && size.height > 0) {
            style = 'max-width: ' + size.width + 'px; max-height: ' + size.height + 'px; width: auto; height: auto;';
        } else if (size.width > 0) {
            style = 'max-width: ' + size.width + 'px; width: auto; height: auto;';
        } else if (size.height > 0) {
            style = 'max-height: ' + size.height + 'px; width: auto; height: auto;';
        }
        
        return '<img src="' + originalUrl + '" alt="' + alt + '" class="' + className + '" style="' + style + '" />';
    }

    // Function to show WordPress-style image size selection modal
    function showImageSizeModal(selectedImages, callback) {
        const modalId = 'imageSizeModal_' + Math.random().toString(36).substr(2, 9);
        
        // Build selected images HTML
        let selectedImagesHtml = '';
        selectedImages.forEach(function(img) {
            selectedImagesHtml += '<div class="d-flex align-items-center mb-2 p-2 border rounded">' +
                '<img src="' + img.src + '" class="img-thumbnail me-2" style="width: 50px; height: 50px; object-fit: cover;">' +
                '<div class="flex-grow-1">' +
                '<div class="fw-medium text-truncate">' + img.name + '</div>' +
                '<small class="text-muted">' + (img.title || '') + '</small>' +
                '</div>' +
                '</div>';
        });
        
        // Build size options HTML
        let sizeOptionsHtml = '';
        Object.entries(imageSizeOptions).forEach(function([key, size]) {
            const checked = key === 'medium' ? 'checked' : '';
            const dimensions = size.width > 0 || size.height > 0 ? 
                (size.width || 'auto') + '  ' + (size.height || 'auto') : 
                'Original dimensions';
            
            sizeOptionsHtml += '<div class="form-check mb-2">' +
                '<input class="form-check-input" type="radio" name="imageSize" id="size_' + key + '" value="' + key + '" ' + checked + '>' +
                '<label class="form-check-label d-flex justify-content-between align-items-center" for="size_' + key + '">' +
                '<span>' + size.label + '</span>' +
                '<small class="text-muted">' + dimensions + '</small>' +
                '</label>' +
                '</div>';
        });
        
        const modalHTML = '<div class="modal fade" id="' + modalId + '" tabindex="-1" aria-hidden="true">' +
            '<div class="modal-dialog modal-lg">' +
            '<div class="modal-content">' +
            '<div class="modal-header">' +
            '<h5 class="modal-title">Insert Images - Choose Size</h5>' +
            '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
            '</div>' +
            '<div class="modal-body">' +
            '<div class="row">' +
            '<div class="col-md-6">' +
            '<h6 class="mb-3">Selected Images (' + selectedImages.length + ')</h6>' +
            '<div class="selected-images-preview" style="max-height: 300px; overflow-y: auto;">' +
            selectedImagesHtml +
            '</div>' +
            '</div>' +
            '<div class="col-md-6">' +
            '<h6 class="mb-3">Image Size Options</h6>' +
            '<div class="image-size-options">' +
            sizeOptionsHtml +
            '</div>' +
            '<div class="mt-4">' +
            '<h6 class="mb-2">Preview</h6>' +
            '<div class="size-preview-container border rounded p-3 text-center" style="min-height: 150px; background-color: #f8f9fa;">' +
            '<img id="sizePreviewImage" src="' + selectedImages[0].src + '" class="img-fluid" style="max-width: 200px; max-height: 150px; object-fit: contain;">' +
            '<div class="mt-2">' +
            '<small class="text-muted" id="sizePreviewText">Medium (300x300)</small>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="mt-4">' +
            '<div class="form-check">' +
            '<input class="form-check-input" type="checkbox" id="linkToFullSize" checked>' +
            '<label class="form-check-label" for="linkToFullSize">' +
            'Link to full-size image' +
            '</label>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="modal-footer">' +
            '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
            '<button type="button" class="btn btn-primary" id="insertImagesBtn">Insert Images</button>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';
        
        // Remove existing modal if any
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = document.getElementById(modalId);
        const bsModal = new bootstrap.Modal(modal);
        
        // Handle size selection change
        modal.querySelectorAll('input[name="imageSize"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const selectedSize = this.value;
                const sizeInfo = imageSizeOptions[selectedSize];
                const previewImg = modal.querySelector('#sizePreviewImage');
                const previewText = modal.querySelector('#sizePreviewText');
                
                // Update preview image (keep original URL but update styling)
                previewImg.src = selectedImages[0].src;
                
                // Update preview text
                previewText.textContent = sizeInfo.label;
                
                // Update preview image style based on size
                if (selectedSize === 'thumbnail') {
                    previewImg.style.maxWidth = '150px';
                    previewImg.style.maxHeight = '150px';
                } else if (selectedSize === 'medium') {
                    previewImg.style.maxWidth = '200px';
                    previewImg.style.maxHeight = '200px';
                } else {
                    previewImg.style.maxWidth = '200px';
                    previewImg.style.maxHeight = '150px';
                }
            });
        });
        
        // Handle insert button click
        modal.querySelector('#insertImagesBtn').addEventListener('click', function() {
            const selectedSize = modal.querySelector('input[name="imageSize"]:checked').value;
            const linkToFullSize = modal.querySelector('#linkToFullSize').checked;
            
            callback(selectedImages, selectedSize, linkToFullSize);
            bsModal.hide();
        });
        
        // Clean up modal when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            modal.remove();
        });
        
        // Show modal
        bsModal.show();
    }

    // Function to add media library button next to CKEditor instances
    function addMediaLibraryButton(editorElement, editorInstance) {
        // Check if button already exists
        if (editorElement.parentNode.querySelector('.media-library-btn')) {
            return;
        }
        
        // Create media library button
        const mediaBtn = document.createElement('button');
        mediaBtn.type = 'button';
        mediaBtn.className = 'btn btn-sm btn-outline-primary media-library-btn mb-3';
        mediaBtn.innerHTML = '<i class="bi bi-images me-1"></i>Add Images';
        
        // Add click handler
        mediaBtn.addEventListener('click', function() {
            // Create media picker instance
            const mediaPicker = new MediaPicker({
                multiple: true,
                allowedTypes: ['image'],
                title: 'Select Images from Media Library',
                buttonText: 'Continue',
                onSelect: (selectedMedia) => {
                    const images = Array.isArray(selectedMedia) ? selectedMedia : [selectedMedia];
                    
                    // Show WordPress-style size selection modal
                    showImageSizeModal(images, function(selectedImages, sizeKey, linkToFullSize) {
                        // Insert selected images with chosen size into CKEditor
                        selectedImages.forEach(media => {
                            let imageUrl = media.src;
                            
                            // Ensure URL starts with / for absolute path
                            if (!imageUrl.startsWith('/') && !imageUrl.startsWith('http')) {
                                imageUrl = '/' + imageUrl;
                            }
                            
                            // Get the full original URL
                            const fullOriginalUrl = window.location.origin + imageUrl;
                            
                            // Generate image HTML with size styling
                            const imgTag = getImageWithSizeStyle(fullOriginalUrl, sizeKey, media.alt || media.name || '', media.id || '');
                            
                            // Prepare image HTML with optional link to full size
                            let imgHtml;
                            if (linkToFullSize && sizeKey !== 'full') {
                                imgHtml = '<a href="' + fullOriginalUrl + '" target="_blank">' + imgTag + '</a>';
                            } else {
                                imgHtml = imgTag;
                            }
                            
                            // Insert image into editor
                            if (editorInstance && editorInstance.model) {
                                // CKEditor 5 - insert as HTML
                                editorInstance.model.change(writer => {
                                    const viewFragment = editorInstance.data.processor.toView(imgHtml);
                                    const modelFragment = editorInstance.data.toModel(viewFragment);
                                    editorInstance.model.insertContent(modelFragment, editorInstance.model.document.selection);
                                });
                            } else if (window.CKEDITOR && window.CKEDITOR.instances && window.CKEDITOR.instances[editorElement.id]) {
                                // CKEditor 4 fallback
                                const ckEditor4 = window.CKEDITOR.instances[editorElement.id];
                                ckEditor4.insertHtml(imgHtml);
                            } else {
                                // Fallback: insert at cursor position in textarea
                                const cursorPos = editorElement.selectionStart;
                                const textBefore = editorElement.value.substring(0, cursorPos);
                                const textAfter = editorElement.value.substring(cursorPos);
                                editorElement.value = textBefore + imgHtml + textAfter;
                                editorElement.focus();
                                editorElement.setSelectionRange(cursorPos + imgHtml.length, cursorPos + imgHtml.length);
                            }
                        });
                    });
                }
            });
            
            // Open the media picker
            mediaPicker.open();
        });
        
        // Insert button after the editor
        const editorContainer = editorElement.closest('.ck-editor') || editorElement.parentNode;
        editorContainer.parentNode.insertBefore(mediaBtn, editorContainer.nextSibling);
    }

    // Initialize CKEditor 5
    function initCKEditor() {
        if (typeof window.CKEDITOR === 'undefined') {
            // console.error('CKEditor not loaded');
            return;
        }
        
        // Try to get all plugins, but handle missing ones gracefully
        const CKEDITOR = window.CKEDITOR;
        if (!CKEDITOR) {
            console.error('CKEditor not available');
            return;
        }
        
        const {
            ClassicEditor,
            Essentials,
            Bold,
            Italic,
            Underline,
            Paragraph,
            List,
            Link,
            Heading,
            Image,
            ImageCaption,
            ImageResize,
            ImageStyle,
            ImageToolbar,
            ImageUpload,
            FileRepository,
            Table,
            TableToolbar,
            TableProperties,
            TableCellProperties,
            SourceEditing
        } = CKEDITOR;
        
        // Check which plugins are actually available
        const availablePlugins = {
            ClassicEditor: !!ClassicEditor,
            Essentials: !!Essentials,
            Bold: !!Bold,
            Italic: !!Italic,
            Underline: !!Underline,
            Paragraph: !!Paragraph,
            List: !!List,
            Link: !!Link,
            Heading: !!Heading,
            Image: !!Image,
            ImageUpload: !!ImageUpload,
            Table: !!Table,
            TableToolbar: !!TableToolbar,
            TableProperties: !!TableProperties,
            TableCellProperties: !!TableCellProperties,
            SourceEditing: !!SourceEditing
        };
        
        // console.log('Available CKEditor plugins:', availablePlugins);
        
        // Find all textareas with ckeditor-paragraph class
        document.querySelectorAll('.ckeditor-paragraph').forEach(function(textarea) {
            // Generate unique ID if not exists
            if (!textarea.id) {
                textarea.id = 'editor_' + Math.random().toString(36).substr(2, 9);
            }
            
            // Check if already initialized
            if (editorInstances[textarea.id]) {
                return;
            }
            
            // Build dynamic configuration based on available plugins
            const plugins = [Essentials, Paragraph];
            const toolbarItems = [];
            
            // Add plugins and toolbar items only if available
            if (Heading) {
                plugins.push(Heading);
                toolbarItems.push('heading', '|');
            }
            
            if (Bold) {
                plugins.push(Bold);
                toolbarItems.push('bold');
            }
            
            if (Italic) {
                plugins.push(Italic);
                toolbarItems.push('italic');
            }
            
            if (Underline) {
                plugins.push(Underline);
                toolbarItems.push('underline');
            }
            
            if (Bold || Italic || Underline) {
                toolbarItems.push('|');
            }
            
            if (List) {
                plugins.push(List);
                toolbarItems.push('bulletedList', 'numberedList', '|');
            }
            
            if (Link) {
                plugins.push(Link);
                toolbarItems.push('link');
            }
            
            // Add Table functionality
            if (Table && TableToolbar) {
                plugins.push(Table, TableToolbar);
                if (TableProperties) plugins.push(TableProperties);
                if (TableCellProperties) plugins.push(TableCellProperties);
                toolbarItems.push('|', 'insertTable');
            }
            
            // Add Image display plugins (without upload functionality)
            if (Image) {
                plugins.push(Image, ImageCaption, ImageResize, ImageStyle, ImageToolbar);
                // Note: No uploadImage button - users must use media library
            }
            
            // Add HTML source code view
            if (SourceEditing) {
                plugins.push(SourceEditing);
                toolbarItems.push('|', 'sourceEditing');
            }
            
            toolbarItems.push('|', 'undo', 'redo');
            
            console.log('Using plugins:', plugins.map(p => p.pluginName || p.name || 'Unknown'));
            console.log('Using toolbar items:', toolbarItems);
            
            const editorConfig = {
                plugins: plugins,
                toolbar: {
                    items: toolbarItems
                },
                // Disable drag and drop file uploads - force users to use media library
                simpleUpload: {
                    uploadUrl: null
                },
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                        ]
                    },
                    list: {
                        properties: {
                            styles: true,
                            startIndex: true,
                            reversed: true
                        }
                    },
                    image: {
                        toolbar: [
                            'imageStyle:inline',
                            'imageStyle:block',
                            'imageStyle:side',
                            '|',
                            'toggleImageCaption',
                            'imageTextAlternative',
                            '|',
                            'resizeImage'
                        ],
                        resizeOptions: [
                            {
                                name: 'resizeImage:original',
                                label: 'Original',
                                value: null
                            },
                            {
                                name: 'resizeImage:25',
                                label: '25%',
                                value: '25'
                            },
                            {
                                name: 'resizeImage:50',
                                label: '50%',
                                value: '50'
                            },
                            {
                                name: 'resizeImage:75',
                                label: '75%',
                                value: '75'
                            }
                        ]
                    },
                    table: {
                        contentToolbar: [
                            'tableColumn',
                            'tableRow',
                            'mergeTableCells',
                            'tableCellProperties',
                            'tableProperties'
                        ]
                    }
            };
            
            // No upload adapter - users must use media library for images
            
            // Initialize CKEditor 5
            ClassicEditor
                .create(textarea, editorConfig)
                .then(editor => {
                    console.log('CKEditor initialized successfully for:', textarea.id);
                    console.log('Available commands:', Object.keys(editor.commands._commands));
                    editorInstances[textarea.id] = editor;
                    
                    // Add media library button
                    addMediaLibraryButton(textarea, editor);
                })
                .catch(error => {
                    console.error('CKEditor initialization error:', error);
                    console.error('Error details:', error.message);
                    
                    // Try with minimal configuration if full config fails
                    console.log('Retrying with minimal configuration...');
                    ClassicEditor
                        .create(textarea, {
                            plugins: [Essentials, Paragraph].concat(Bold ? [Bold] : []),
                            toolbar: {
                                items: Bold ? ['bold'] : []
                            }
                        })
                        .then(editor => {
                            console.log('Minimal CKEditor initialized for:', textarea.id);
                            editorInstances[textarea.id] = editor;
                            
                            // Add media library button
                            addMediaLibraryButton(textarea, editor);
                        })
                        .catch(minimalError => {
                            console.error('Even minimal CKEditor failed:', minimalError);
                            // Fall back to CKEditor 4
                            initCKEditor4ForTextarea(textarea);
                        });
                });
        });
    }
    
    // CKEditor 4 fallback functions
    function initCKEditor4ForTextarea(textarea) {
        // console.log('Initializing CKEditor 4 for:', textarea.id);
        
        if (typeof CKEDITOR !== 'undefined' && CKEDITOR.replace) {
            // Suppress the version warning
            CKEDITOR.config.versionCheck = false;
            
            const editor = CKEDITOR.replace(textarea.id, {
                toolbar: [
                    { name: 'styles', items: ['Format', 'FontSize'] },
                    { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline'] },
                    { name: 'paragraph', items: ['NumberedList', 'BulletedList'] },
                    { name: 'links', items: ['Link', 'Unlink'] },
                    { name: 'insert', items: ['Table'] },
                    { name: 'tools', items: ['Source'] }
                    // Note: Image button removed - users must use media library
                ],
                format_tags: 'p;h1;h2;h3;h4;h5;h6',
                fontSize_sizes: '8/8px;9/9px;10/10px;11/11px;12/12px;14/14px;16/16px;18/18px;20/20px;22/22px;24/24px;26/26px;28/28px;36/36px;48/48px;72/72px',
                fontSize_defaultLabel: '14px',
                height: 150,
                removeButtons: '',
                allowedContent: true,
                versionCheck: false,
                // Disable file uploads - force users to use media library
                filebrowserUploadUrl: null,
                filebrowserImageUploadUrl: null
            });
            
            editorInstances[textarea.id] = {
                getData: () => editor.getData(),
                setData: (data) => editor.setData(data),
                destroy: () => editor.destroy()
            };
            
            // console.log('CKEditor 4 initialized successfully for:', textarea.id);
            
            // Add media library button for CKEditor 4
            addMediaLibraryButton(textarea, null);
        } else {
            console.error('CKEditor 4 not available');
        }
    }
    
    function initCKEditor4() {
        // console.log('Initializing all CKEditor 4 instances...');
        document.querySelectorAll('.ckeditor-paragraph').forEach(function(textarea) {
            if (!textarea.id) {
                textarea.id = 'editor_' + Math.random().toString(36).substr(2, 9);
            }
            initCKEditor4ForTextarea(textarea);
        });
    }

    // Wait for page to load
    window.addEventListener('load', function() {
        // console.log('Page loaded, checking CKEditor availability...');
        // console.log('window.CKEDITOR available:', typeof window.CKEDITOR !== 'undefined');
        
        if (typeof window.CKEDITOR !== 'undefined') {
            // console.log('CKEditor 5 UMD build detected, initializing...');
            setTimeout(initCKEditor, 500);
        } else {
            // console.log('CKEditor 5 not available, trying CKEditor 4...');
            window.ckEditorFallback();
        }
    });

    // Centralized function to toggle the visibility of section fields
    function toggleSectionFields($section) {
        const sectionType = $section.find(".section-type-select").val();

        // Hide all fields first
        $section.find('.image-with-text-fields').hide();
        $section.find('.image-with-list-fields').hide();
        $section.find('.heading-subheading-fields').hide();
        $section.find('.left-heading-image-right-text-fields').hide();
        $section.find('.right-heading-image-left-text-fields').hide();
        $section.find('.hero-section-fields').hide();
        $section.find('.three-column-fields').hide();
        $section.find('.call-out-cards-fields').hide();
        $section.find('.tabs-section-fields').hide();

        // Show only the relevant fields based on section type
        if (sectionType === 'image-with-text') {
            $section.find('.image-with-text-fields').show();
        } else if (sectionType === 'image-with-list') {
            $section.find('.image-with-list-fields').show();
        } else if (sectionType === 'heading-subheading') {
            $section.find('.heading-subheading-fields').show();
        } else if (sectionType === 'left-heading-image-right-text') {
            $section.find('.left-heading-image-right-text-fields').show();
        } else if (sectionType === 'right-heading-image-left-text') {
            $section.find('.right-heading-image-left-text-fields').show();
        } else if (sectionType === 'hero-section') {
            $section.find('.hero-section-fields').show();
            // Reinitialize CKEditor for this section after it becomes visible
            setTimeout(initCKEditor, 300);
        } else if (sectionType === 'three-column-info') {
            $section.find('.three-column-fields').show();
        } else if (sectionType === 'call-out-cards') {
            $section.find('.call-out-cards-fields').show();
            setTimeout(initCKEditor, 300);
        } else if (sectionType === 'tabs-section') {
            $section.find('.tabs-section-fields').show();
            // Auto-create 8 tabs if none exist
            const $tabsContainer = $section.find('.tabs-container');
            if ($tabsContainer.find('.tab-item').length === 0) {
                for (let i = 1; i <= 8; i++) {
                    const tabHtml = \`
                        <div class="tab-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold text-sm">Tab #\${i}</span>
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-sm">Title:</label>
                                <input type="text" class="form-control border border-neutral-200 radius-8 tab-title" placeholder="Tab Title">
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-sm">Heading:</label>
                                <input type="text" class="form-control border border-neutral-200 radius-8 tab-heading" placeholder="Tab Heading">
                            </div>
                            <div>
                                <label class="form-label text-sm">Paragraph:</label>
                                <textarea class="form-control border border-neutral-200 radius-8 tab-paragraph ckeditor-paragraph" rows="3" placeholder="Tab content"></textarea>
                            </div>
                        </div>\`;
                    $tabsContainer.append(tabHtml);
                }
            }
            // Initialize CKEditor for tab textareas (both existing and newly created)
            setTimeout(initCKEditor, 300);
        }
    }

    // Template sections have fixed structure - no dynamic item management

    // Generic image upload handler to keep code DRY
    function handleImageUpload(inputSelector, previewSelector, removeSelector, wrapperSelector, folderName) {
        $(document).on("change", inputSelector, function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $wrapper = $(this).closest(wrapperSelector);
                const $preview = $wrapper.find(previewSelector);
                const $remove = $wrapper.find(removeSelector);
                const $input = $(this);

                // Use FileReader for a robust preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $preview.attr("src", event.target.result).show();
                    $remove.show();
                    $input.hide(); // Hide the input label
                };
                reader.readAsDataURL(file);

                // AJAX upload
                const formData = new FormData();
                // append folder first so multer's destination sees it when processing the file
                formData.append("folder", folderName);
                formData.append("file", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            // Store the URL in a data attribute for submission
                            $input.data("server-url", response.url);
                            console.log("server-url", response);

                            // showToast("Image uploaded successfully", "success");
                        } else {
                            showToast(response.message || "Image upload failed", "error");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred", "error");
                    }
                });
            }
        });

        // Handle image removal
        $(document).on("click", removeSelector, function () {
            const $wrapper = $(this).closest(wrapperSelector);
            $wrapper.find(previewSelector).attr("src", "").hide();
            $(this).hide();
            $wrapper.find(inputSelector).val("").data("server-url", "").show(); // Clear input and data
        });
    }

    // Template sections are fixed - no dynamic section management needed

    // Main document ready function
    $(document).ready(function () {
        // Initialize existing sections (only real sections inside the container)
        $("#sectionsContainer .section-block").each(function () {
            toggleSectionFields($(this));
        });
        
        // Initialize CKEditor after sections are visible
        setTimeout(initCKEditor, 1000);

        // Template sections are read-only - prevent structure changes
        $("#sectionsContainer").on("change", ".section-type-select", function () {
            showToast('Section types are fixed by the page template. Change the template in Page Master to modify structure.', 'warning');
            // Revert to original value
            const originalType = $(this).closest('.section-block').find('.original-section-type').val();
            $(this).val(originalType);
        });

        // Initialize all image upload handlers
        handleImageUpload(".upload-file-iwt-input", ".uploaded-img-iwt__preview", ".uploaded-img-iwt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-iwl-input", ".uploaded-img-iwl__preview", ".uploaded-img-iwl__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-lhrt-input", ".uploaded-img-lhrt__preview", ".uploaded-img-lhrt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-rhlt-input", ".uploaded-img-rhlt__preview", ".uploaded-img-rhlt__remove", ".upload-image-wrapper", "section");
        handleImageUpload(".upload-file-hero-input", ".uploaded-img-hero__preview", ".uploaded-img-hero__remove", ".upload-image-wrapper", "hero");

        // Helpful links add/remove handlers (for contact-section)
        $(document).on('click', '.add-helpful-link-btn', function() {
            const $section = $(this).closest('.section-block');
            const $list = $section.find('.cs-helpful-links-list');
            const itemHtml = \`
                <div class="d-flex align-items-center gap-2 mb-2 cs-helpful-item">
                    <input type="text" class="form-control cs-helpful-text" value="" placeholder="Button text">
                    <input type="text" class="form-control cs-helpful-link" value="" placeholder="/path or https://...">
                    <button type="button" class="btn btn-sm btn-danger-600 remove-helpful-link"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                </div>\`;
            $list.append(itemHtml);
        });

        $(document).on('click', '.remove-helpful-link', function() {
            $(this).closest('.cs-helpful-item').remove();
        });

        // Initialize existing hero images on page load
        $(".upload-file-hero-input").each(function() {
            const existingImage = $(this).data("existing-image");
            if (existingImage && existingImage !== '' && existingImage !== '/images/user.png') {
                const $wrapper = $(this).closest(".upload-image-wrapper");
                const $section = $(this).closest(".hero-section-fields");
                
                // Hide the "Current Image" label and static image
                $section.find(".existing-image").closest(".mb-2").hide();
                
                // Show the image in the upload preview area
                $wrapper.find(".uploaded-img-hero__preview").attr("src", existingImage);
                $wrapper.find(".uploaded-img-hero").removeClass("d-none");
                $wrapper.find(".upload-file-hero").addClass("d-none");
                $(this).data("server-url", existingImage);
            }
        });

        // Hero Section image handler with proper show/hide logic
        $(document).on("change", ".upload-file-hero-input", function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $section = $(this).closest(".section-block");
                const $wrapper = $(this).closest(".upload-image-wrapper");
                const $input = $(this);

                // Show preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $wrapper.find(".uploaded-img-hero__preview").attr("src", event.target.result);
                    $wrapper.find(".uploaded-img-hero").removeClass("d-none");
                    $wrapper.find(".upload-file-hero").addClass("d-none");
                };
                reader.readAsDataURL(file);

                // Upload to server
                const formData = new FormData();
                formData.append("folder", "hero");
                formData.append("file", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        console.log('Upload response:', response);
                        if (response.success) {
                            $input.data("server-url", response.url);
                            showToast("Hero image uploaded successfully", "success");
                        } else {
                            showToast(response.message || "Image upload failed", "error");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Upload error:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        // Check if it's actually a success but parsed as error
                        if (xhr.status === 200 && xhr.responseText) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                if (response.success) {
                                    $input.data("server-url", response.url);
                                    showToast("Hero image uploaded successfully", "success");
                                    return;
                                }
                            } catch (e) {
                                console.error('Failed to parse response:', e);
                            }
                        }
                        
                        showToast(xhr.responseJSON?.message || "An error occurred during upload", "error");
                    }
                });
            }
        });

        // Hero Section image change handler
        $(document).on("change", ".upload-file-hero-input-change", function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $wrapper = $(this).closest(".upload-image-wrapper");
                const $input = $(this);

                // Show preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $wrapper.find(".uploaded-img-hero__preview").attr("src", event.target.result);
                };
                reader.readAsDataURL(file);

                // Upload to server
                const formData = new FormData();
                formData.append("image", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            $wrapper.find(".upload-file-hero-input").data("server-url", response.url);
                            showToast("Hero image updated successfully", "success");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred during upload", "error");
                    }
                });
            }
        });

        // Hero Section image remove handler
        $(document).on("click", ".uploaded-img-hero__remove", function () {
            const $wrapper = $(this).closest(".upload-image-wrapper");
            $wrapper.find(".uploaded-img-hero__preview").attr("src", "");
            $wrapper.find(".uploaded-img-hero").addClass("d-none");
            $wrapper.find(".upload-file-hero").removeClass("d-none");
            $wrapper.find(".upload-file-hero-input").val("").data("server-url", "");
            $wrapper.find(".upload-file-hero-input-change").val("");
        });

        // Three Column Info image handler with proper show/hide logic
        $(document).on("change", ".upload-file-tci-input", function (e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const $section = $(this).closest(".section-block");
                const $wrapper = $(this).closest(".upload-image-wrapper");
                const $input = $(this);

                // Show preview
                const reader = new FileReader();
                reader.onload = function (event) {
                    $wrapper.find(".uploaded-img-tci__preview").attr("src", event.target.result);
                    $wrapper.find(".uploaded-img-tci").removeClass("d-none");
                    $wrapper.find(".upload-file-tci").hide();
                };
                reader.readAsDataURL(file);

                // Upload to server
                const formData = new FormData();
                formData.append("folder", "section");
                formData.append("file", file);

                $.ajax({
                    url: "/api/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            $input.data("server-url", response.url);
                            showToast("Image uploaded successfully", "success");
                        } else {
                            showToast(response.message || "Image upload failed", "error");
                        }
                    },
                    error: function (xhr) {
                        showToast(xhr.responseJSON?.message || "An error occurred", "error");
                    }
                });
            }
        });

        // Three Column Info image remove handler
        $(document).on("click", ".uploaded-img-tci__remove", function () {
            const $wrapper = $(this).closest(".upload-image-wrapper");
            $wrapper.find(".uploaded-img-tci__preview").attr("src", "");
            $wrapper.find(".uploaded-img-tci").addClass("d-none");
            $wrapper.find(".upload-file-tci").show();
            $wrapper.find(".upload-file-tci-input").val("").data("server-url", "");
        });

        // Helper function to focus on field with proper scroll behavior
        function focusFieldWithScroll($field, message) {
            if (message) {
                showToast(message, 'warning');
            }
            if ($field && $field.length) {
                // Reset button state
                const saveBtn = $('#editContentForm button[type="submit"]')[0];
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Save Changes';
                }
                
                setTimeout(() => {
                    $field[0].scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    $field.focus();
                }, 100);
            }
        }

        // Form submission logic
        $("#editContentForm").on("submit", function (e) {
            const saveBtn = $('#editContentForm button[type="submit"]')[0];
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
            e.preventDefault();

            const contentId = $("#contentId").val();
            const pageId = $("#pageId").val();
            const status = $("#status").val();

            if (!pageId) {
                showToast("Please select a page.", "warning");
                return;
            }

            const sectionsData = [];
            let isValid = true;

            $("#sectionsContainer .section-block").each(function (index) {
                const $section = $(this);
                // For template-based pages, get from original value if select is disabled
                let sectionType = $section.find(".section-type-select").val();
                if (!sectionType || $section.find(".section-type-select").is(':disabled')) {
                    sectionType = $section.find(".original-section-type").val();
                }

                if (!sectionType) {
                    showToast("Please select a section type for all sections.", "warning");
                    isValid = false;
                    return false; // Break the loop
                }

                const sectionData = {
                    id: $section.data("id"), // Keep track of the section
                    order: index + 1,
                    sectionType: sectionType,
                    customFields: {},
                    heroSection: {},
                    threeColumnInfo: {}
                };

                // Populate data based on section type
                if (sectionType === "image-with-text") {
                    sectionData.customFields.heading = $section.find(".iwt-heading").val();
                    sectionData.customFields.subheading = $section.find(".iwt-subheading").val();
                    sectionData.customFields.richText = $section.find(".iwt-text").val();
                    sectionData.customFields.image = $section.find(".upload-file-iwt-input").data("server-url") || $section.find(".uploaded-img-iwt__preview").attr("src");
                } else if (sectionType === "image-with-list") {
                    sectionData.customFields.heading = $section.find(".iwl-heading").val();
                    sectionData.customFields.items = $section.find(".iwl-item-input").map(function () {
                        return $(this).val();
                    }).get();
                    sectionData.customFields.image = $section.find(".upload-file-iwl-input").data("server-url") || $section.find(".uploaded-img-iwl__preview").attr("src");
                } else if (sectionType === "heading-subheading") {
                    sectionData.customFields.heading = $section.find(".hs-heading").val();
                    sectionData.customFields.subheading = $section.find(".hs-subheading").val();
                    sectionData.customFields.alignCenter = $section.find(".hs-center").is(":checked");
                } else if (sectionType === "hero-section") {
                    const ctas = [];
                    $section.find(".cta-item").each(function () {
                        const text = $(this).find(".cta-text").val();
                        const link = $(this).find(".cta-link").val();
                        const style = $(this).find(".cta-style").val() || 'primary';
                        if (text && link) {
                            ctas.push({ text, link, style });
                        }
                    });
                    sectionData.heroSection.heading = $section.find(".hero-heading").val();
                    
                    // Validate hero section heading
                    if (!sectionData.heroSection.heading || !sectionData.heroSection.heading.trim()) {
                        const $heroHeadingField = $section.find(".hero-heading");
                        focusFieldWithScroll($heroHeadingField, 'Hero Section heading is required');
                        isValid = false;
                        return false;
                    }
                    
                    // Get CKEditor 5 content
                    const paragraphEditor = $section.find(".hero-paragraph");
                    const editorId = paragraphEditor.attr('id');
                    sectionData.heroSection.paragraph = editorInstances[editorId] ? editorInstances[editorId].getData() : paragraphEditor.val();
                    // Get ad object from dropdown
                    const adImageInput = $section.find(".ad-image-input");
                    const adData = adImageInput.val();
                    
                    // Save the ad object
                    console.log(' Processing ad data for form submission:', adData);
                    if (adData && adData.trim() !== '') {
                        try {
                            const adObject = JSON.parse(adData);
                            sectionData.heroSection.ad = adObject;
                            console.log(' Ad object saved to section:', adObject);
                        } catch (e) {
                            console.error(' Error parsing ad data:', e);
                            // Fallback for old format (just image URL)
                            sectionData.heroSection.ad = {
                                image: adData,
                                link: '',
                                target: '_self'
                            };
                            console.log(' Using fallback ad object:', sectionData.heroSection.ad);
                        }
                    } else {
                        sectionData.heroSection.ad = null;
                        console.log(' No ad data found, setting ad to null');
                    }
                    sectionData.heroSection.ctas = ctas;
                } else if (sectionType === "left-heading-image-right-text") {
                    // Left heading + image on left, right text
                    sectionData.customFields.leftHeading = $section.find('.lhrt-heading').val();
                    sectionData.customFields.leftImage = $section.find('.upload-file-lhrt-input').data('server-url') || $section.find('.uploaded-img-lhrt__preview').attr('src');
                    sectionData.customFields.rightText = $section.find('.lhrt-right-text').val();
                } else if (sectionType === "right-heading-image-left-text") {
                    // Right heading + image on right, left text
                    sectionData.customFields.rightHeading = $section.find('.rhlt-heading').val();
                    sectionData.customFields.rightImage = $section.find('.upload-file-rhlt-input').data('server-url') || $section.find('.uploaded-img-rhlt__preview').attr('src');
                    sectionData.customFields.leftText = $section.find('.rhlt-left-text').val();
                } else if (sectionType === "three-column-info") {
                    const $tciInput = $section.find(".upload-file-tci-input");
                    const newImageUrl = $tciInput.data("server-url");
                    const existingImageUrl = $tciInput.data("existing-image");
                    const heading = $section.find(".tci-heading").val();
                    const subheading = $section.find(".tci-subheading").val();
                    const imageUrl = newImageUrl || existingImageUrl || "";

                    sectionData.title = heading || "Three Column Info";
                    sectionData.thumbnail = imageUrl;
                    sectionData.threeColumnInfo.heading = heading;
                    sectionData.threeColumnInfo.subheading = subheading;
                    sectionData.threeColumnInfo.imageOnLeft = $section.find(".tci-image-left").is(":checked");
                    sectionData.threeColumnInfo.image = imageUrl;
                    sectionData.threeColumnInfo.columns = $section.find(".column-item").map(function () {
                        return {
                            title: $(this).find(".column-title").val(),
                            description: $(this).find(".column-description").val(),
                            buttonText: $(this).find(".column-btn-text").val(),
                            buttonLink: $(this).find(".column-btn-link").val()
                        };
                    }).get();
                } else if (sectionType === "call-out-cards") {
                    const cards = $section.find(".callout-item").map(function () {
                        const $subheadingTextarea = $(this).find(".callout-subheading");
                        let subheadingContent = $subheadingTextarea.val();
                        
                        // Get CKEditor content if editor exists
                        const editorId = $subheadingTextarea.attr('id');
                        if (editorId && editorInstances[editorId]) {
                            subheadingContent = editorInstances[editorId].getData();
                        }
                        
                        return {
                            heading: $(this).find(".callout-heading").val(),
                            subheading: subheadingContent,
                            link: $(this).find(".callout-link").val()
                        };
                    }).get();

                    // Allow 0 cards - no minimum requirement

                    if (cards.length > 6) {
                        showToast('Maximum 6 Call Out Section allowed', 'warning');
                        isValid = false;
                        return false;
                    }

                    // Check if all cards have headings (only if cards exist)
                    if (cards.length > 0) {
                        const invalidCard = cards.find(card => !card.heading);
                        if (invalidCard) {
                            // Find the first empty heading field and focus on it with proper scroll
                            const $emptyHeadingField = $section.find(".callout-heading").filter(function() {
                                return !$(this).val().trim();
                            }).first();
                            focusFieldWithScroll($emptyHeadingField, 'All Call Out Section must have a heading');
                            isValid = false;
                            return false;
                        }
                    }

                    sectionData.title = cards.length > 0 ? (cards[0].heading || "Call Out Section") : "Call Out Section";
                    sectionData.callOutCards = { cards: cards };
                } else if (sectionType === "tabs-section") {
                    const tabs = $section.find(".tab-item").map(function () {
                        const $paragraphTextarea = $(this).find(".tab-paragraph");
                        let paragraphContent = $paragraphTextarea.val();
                        
                        // Get CKEditor content if editor exists
                        const editorId = $paragraphTextarea.attr('id');
                        if (editorId && editorInstances[editorId]) {
                            try {
                                paragraphContent = editorInstances[editorId].getData();
                            } catch (error) {
                                console.error('Error getting CKEditor content for tab:', error);
                                paragraphContent = $paragraphTextarea.val();
                            }
                        }
                        
                        return {
                            title: $(this).find(".tab-title").val(),
                            heading: $(this).find(".tab-heading").val(),
                            paragraph: paragraphContent
                        };
                    }).get();

                    sectionData.title = "Tabs Section";
                    sectionData.tabsSection = { tabs: tabs };
                } else if (sectionType === "community-groups") {
                    const heading = $section.find(".cg-heading").val();
                    const subheading = $section.find(".cg-subheading").val();
                    const category = "community"; // Default to community category
                    const displayOrder = $section.find(".cg-display-order").val();
                    
                    // Get selected pages
                    const selectedPages = [];
                    $section.find(".selected-page-item").each(function(index) {
                        const pageId = $(this).data("page-id");
                        const order = $(this).data("order") || index;
                        if (pageId) {
                            selectedPages.push({
                                page: pageId,
                                order: order
                            });
                        }
                    });
                    
                    console.log('Community Groups Data (Main Form):', {
                        heading: heading,
                        subheading: subheading,
                        displayOrder: displayOrder,
                        selectedPages: selectedPages
                    });
                    
                    sectionData.title = heading || "Community Groups";
                    sectionData.communityGroups = {
                        heading: heading,
                        subheading: subheading,
                        category: category,
                        displayOrder: displayOrder,
                        selectedPages: selectedPages
                    };
                } else if (sectionType === "contact-section") {
                    // Collect contact section fields
                    const cs = {};
                    cs.heading = $section.find('.cs-heading').val();
                    cs.subheading = $section.find('.cs-subheading').val();

                    cs.email = {
                        heading: $section.find('.cs-email-heading').val(),
                        subheading: $section.find('.cs-email-subheading').val(),
                        address: $section.find('.cs-email-address').val()
                    };

                    cs.call = {
                        heading: $section.find('.cs-call-heading').val(),
                        subheading: $section.find('.cs-call-subheading').val(),
                        phone: $section.find('.cs-call-phone').val()
                    };

                    cs.generalContactForm = {
                        heading: $section.find('.cs-form-heading').val(),
                        subheading: $section.find('.cs-form-subheading').val(),
                        openFormLink: $section.find('.cs-form-link').val()
                    };

                    // helpful links
                    cs.helpfulLinks = $section.find('.cs-helpful-item').map(function() {
                        return {
                            text: $(this).find('.cs-helpful-text').val(),
                            link: $(this).find('.cs-helpful-link').val()
                        };
                    }).get();

                    // Validate email if present
                    const emailVal = cs.email.address || '';
                    if (emailVal && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal)) {
                        focusFieldWithScroll($section.find('.cs-email-address'), 'Please enter a valid email address');
                        isValid = false;
                        return false;
                    }

                    // Validate phone - allow digits, spaces, + and parentheses only
                    const phoneVal = cs.call.phone || '';
                    if (phoneVal && !/^[0-9+\s()]+$/.test(phoneVal)) {
                        focusFieldWithScroll($section.find('.cs-call-phone'), 'Phone number contains invalid characters');
                        isValid = false;
                        return false;
                    }

                    sectionData.title = cs.heading || 'Contact Section';
                    sectionData.contactSection = cs;
                }

                sectionsData.push(sectionData);
            });

            if (!isValid) return;

            // Get thumbnail data
            const pageThumbnail = $("#pageThumbnail").val();

            // Consolidate all data into one payload
            const payload = {
                pageId: pageId,
                status: status,
                sections: sectionsData,
                pageThumbnail: pageThumbnail || null
            };
            
            console.log('Complete payload being sent:', payload);
            console.log(' Hero section data being sent:', payload.sections.find(s => s.sectionType === 'hero-section'));

            // Single AJAX call to update everything
            $.ajax({
                url: \`/api/content/\${contentId}\`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.success) {
                        showToast("Content updated successfully!", "success");
                        // Redirect after a short delay
                        setTimeout(() => {
                            // window.location.href = "/page-master/web-page-master";
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast(response.message || "An error occurred.", "error");
                    }
                },
                error: function (xhr) {
                    showToast(xhr.responseJSON?.message || "An error occurred.", "error");
                }
            });
        });

        // Handle "Update & Manage SEO" button
        $("#updateAndSeoBtn").on("click", function(e) {
            e.preventDefault();

            // First update the content, then redirect to SEO management
            const contentId = $("#contentId").val();
            const pageId = $("#pageId").val();
            const status = $("#status").val();

            if (!pageId) {
                showToast("Please select a page.", "warning");
                return;
            }

            const sectionsData = [];
            let isValid = true;

            // Same validation and data collection as the main form
            $("#sectionsContainer .section-block").each(function (index) {
                const $section = $(this);
                // For template-based pages, get from original value if select is disabled
                let sectionType = $section.find(".section-type-select").val();
                if (!sectionType || $section.find(".section-type-select").is(':disabled')) {
                    sectionType = $section.find(".original-section-type").val();
                }

                if (!sectionType) {
                    showToast("Please select a section type for all sections.", "warning");
                    isValid = false;
                    return false;
                }

                const sectionData = {
                    id: $section.data("id"),
                    order: index + 1,
                    sectionType: sectionType,
                    customFields: {},
                    heroSection: {},
                    threeColumnInfo: {}
                };

                // Same data population logic as main form (abbreviated for brevity)
                if (sectionType === "hero-section") {
                    const ctas = [];
                    $section.find(".cta-item").each(function () {
                        const text = $(this).find(".cta-text").val();
                        const link = $(this).find(".cta-link").val();
                        const style = $(this).find(".cta-style").val() || 'primary';
                        if (text && link) {
                            ctas.push({ text, link, style });
                        }
                    });
                    sectionData.heroSection.heading = $section.find(".hero-heading").val();
                    
                    // Validate hero section heading
                    if (!sectionData.heroSection.heading || !sectionData.heroSection.heading.trim()) {
                        const $heroHeadingField = $section.find(".hero-heading");
                        focusFieldWithScroll($heroHeadingField, 'Hero Section heading is required');
                        isValid = false;
                        return false;
                    }
                    
                    // Get CKEditor 5 content
                    const paragraphEditor2 = $section.find(".hero-paragraph");
                    const editorId2 = paragraphEditor2.attr('id');
                    sectionData.heroSection.paragraph = editorInstances[editorId2] ? editorInstances[editorId2].getData() : paragraphEditor2.val();
                    // Get ad object from dropdown
                    const adImageInput2 = $section.find(".ad-image-input");
                    const adData2 = adImageInput2.val();
                    
                    // Save the ad object
                    if (adData2 && adData2.trim() !== '') {
                        try {
                            const adObject2 = JSON.parse(adData2);
                            sectionData.heroSection.ad = adObject2;
                            console.log('Ad object saved to section (handler 2):', adObject2);
                        } catch (e) {
                            console.error('Error parsing ad data (handler 2):', e);
                            // Fallback for old format (just image URL)
                            sectionData.heroSection.ad = {
                                image: adData2,
                                link: '',
                                target: '_self'
                            };
                            console.log('Using fallback ad object (handler 2):', sectionData.heroSection.ad);
                        }
                    } else {
                        sectionData.heroSection.ad = null;
                        console.log('No ad data found (handler 2), setting ad to null');
                    }
                    sectionData.heroSection.ctas = ctas;
                } else if (sectionType === "three-column-info") {
                    const heading = $section.find(".tci-heading").val();
                    const subheading = $section.find(".tci-subheading").val();
                    sectionData.title = heading || "Three Column Info";
                    sectionData.threeColumnInfo.heading = heading;
                    sectionData.threeColumnInfo.subheading = subheading;
                    sectionData.threeColumnInfo.columns = $section.find(".column-item").map(function () {
                        return {
                            title: $(this).find(".column-title").val(),
                            description: $(this).find(".column-description").val(),
                            buttonText: $(this).find(".column-btn-text").val(),
                            buttonLink: $(this).find(".column-btn-link").val()
                        };
                    }).get();
                } else if (sectionType === "call-out-cards") {
                    const cards = $section.find(".callout-item").map(function () {
                        const $subheadingTextarea = $(this).find(".callout-subheading");
                        let subheadingContent = $subheadingTextarea.val();
                        
                        // Get CKEditor content if editor exists
                        const editorId = $subheadingTextarea.attr('id');
                        if (editorId && editorInstances[editorId]) {
                            subheadingContent = editorInstances[editorId].getData();
                        }
                        
                        return {
                            heading: $(this).find(".callout-heading").val(),
                            subheading: subheadingContent,
                            link: $(this).find(".callout-link").val()
                        };
                    }).get();

                    // Allow 0 cards - no minimum requirement

                    // Check if all cards have headings (only if cards exist)
                    if (cards.length > 0) {
                        const invalidCard = cards.find(card => !card.heading);
                        if (invalidCard) {
                            // Find the first empty heading field and focus on it with proper scroll
                            const $emptyHeadingField = $section.find(".callout-heading").filter(function() {
                                return !$(this).val().trim();
                            }).first();
                            focusFieldWithScroll($emptyHeadingField, 'All Call Out Section must have a heading');
                            isValid = false;
                            return false;
                        }
                    }

                    sectionData.title = cards.length > 0 ? (cards[0].heading || "Call Out Section") : "Call Out Section";
                    sectionData.callOutCards = { cards: cards };
                } else if (sectionType === "tabs-section") {
                    const tabs = $section.find(".tab-item").map(function () {
                        const $paragraphTextarea = $(this).find(".tab-paragraph");
                        let paragraphContent = $paragraphTextarea.val();
                        
                        // Get CKEditor content if editor exists
                        const editorId = $paragraphTextarea.attr('id');
                        if (editorId && editorInstances[editorId]) {
                            try {
                                paragraphContent = editorInstances[editorId].getData();
                            } catch (error) {
                                console.error('Error getting CKEditor content for tab:', error);
                                paragraphContent = $paragraphTextarea.val();
                            }
                        }
                        
                        return {
                            title: $(this).find(".tab-title").val(),
                            heading: $(this).find(".tab-heading").val(),
                            paragraph: paragraphContent
                        };
                    }).get();

                    sectionData.title = "Tabs Section";
                    sectionData.tabsSection = { tabs: tabs };
                } else if (sectionType === "community-groups") {
                    const heading = $section.find(".cg-heading").val();
                    const subheading = $section.find(".cg-subheading").val();
                    const category = "community"; // Default to community category
                    const displayOrder = $section.find(".cg-display-order").val();
                    
                    // Get selected pages
                    const selectedPages = [];
                    $section.find(".selected-page-item").each(function(index) {
                        const pageId = $(this).data("page-id");
                        const order = $(this).data("order") || index;
                        if (pageId) {
                            selectedPages.push({
                                page: pageId,
                                order: order
                            });
                        }
                    });
                    
                    sectionData.title = heading || "Community Groups";
                    sectionData.communityGroups = {
                        heading: heading,
                        subheading: subheading,
                        category: category,
                        displayOrder: displayOrder,
                        selectedPages: selectedPages
                    };
                } else if (sectionType === "contact-section") {
                    // Collect contact section fields for SEO update flow
                    const cs = {};
                    cs.heading = $section.find('.cs-heading').val();
                    cs.subheading = $section.find('.cs-subheading').val();

                    cs.email = {
                        heading: $section.find('.cs-email-heading').val(),
                        subheading: $section.find('.cs-email-subheading').val(),
                        address: $section.find('.cs-email-address').val()
                    };

                    cs.call = {
                        heading: $section.find('.cs-call-heading').val(),
                        subheading: $section.find('.cs-call-subheading').val(),
                        phone: $section.find('.cs-call-phone').val()
                    };

                    cs.generalContactForm = {
                        heading: $section.find('.cs-form-heading').val(),
                        subheading: $section.find('.cs-form-subheading').val(),
                        openFormLink: $section.find('.cs-form-link').val()
                    };

                    cs.helpfulLinks = $section.find('.cs-helpful-item').map(function() {
                        return {
                            text: $(this).find('.cs-helpful-text').val(),
                            link: $(this).find('.cs-helpful-link').val()
                        };
                    }).get();

                    // Validation as above
                    const emailVal = cs.email.address || '';
                    if (emailVal && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal)) {
                        focusFieldWithScroll($section.find('.cs-email-address'), 'Please enter a valid email address');
                        isValid = false;
                        return false;
                    }
                    const phoneVal = cs.call.phone || '';
                    if (phoneVal && !/^[0-9+\s()]+$/.test(phoneVal)) {
                        focusFieldWithScroll($section.find('.cs-call-phone'), 'Phone number contains invalid characters');
                        isValid = false;
                        return false;
                    }

                    sectionData.title = cs.heading || 'Contact Section';
                    sectionData.contactSection = cs;
                }

                sectionsData.push(sectionData);
            });

            if (!isValid) {
                return;
            }

            // Update content first, then redirect to SEO
            const payload = {
                pageId: pageId,
                status: status,
                sections: sectionsData
            };

            $.ajax({
                url: \`/api/content/\${contentId}\`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.success) {
                        showToast("Content updated successfully! Redirecting to SEO management...", "success");
                        setTimeout(() => {
                            // Check if SEO exists for this page via API, then redirect appropriately
                            $.ajax({
                                url: \`/api/seo/check-page/\${pageId}\`,
                                type: 'GET',
                                success: function(seoResponse) {
                                    if (seoResponse.success && seoResponse.seoExists) {
                                        // SEO exists, go to edit
                                        window.location.href = \`/seo/edit-seo-content/\${seoResponse.seoId}?from=content\`;
                                    } else {
                                        // No SEO, go to add with page pre-selected
                                        window.location.href = \`/seo/add-seo-content?pageId=\${pageId}&from=content\`;
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error("SEO check failed:", error);
                                    // Fallback to SEO management page
                                    window.location.href = '/seo/seo-management';
                                }
                            });
                        }, 1000);
                    } else {
                        showToast(response.message || "An error occurred.", "error");
                    }
                },
                error: function (xhr) {
                    console.error("Content update failed:", xhr.responseJSON?.message || xhr.statusText);
                    showToast(xhr.responseJSON?.message || "An error occurred.", "error");
                }
            });
        });
    });
    $(document).on('input', '.callout-link,.column-btn-link,.cta-link', function() {
        const $input = $(this);
        const query = $input.val().trim();

        if (query.length < 2) {
            $input.next('.autocomplete-list').remove();
            return;
        }

        $.ajax({
            url: '/api/pages/all-pages/search',
            data: { q: query },
            success: function(pages) {
            $input.next('.autocomplete-list').remove();

            if (!pages || pages.length === 0) return;

            const $list = $('<div class="autocomplete-list border bg-white position-absolute w-100 radius-8 shadow-sm mt-1 z-1"></div>');

            pages.forEach(page => {
                const $item = $(\`
                <div class="autocomplete-item p-2 text-sm cursor-pointer hover:bg-neutral-100">
                    $\{page.name} <small class="text-muted">($\{page.slug})</small>
                </div>
                \`);
                // const baseUrl = window.location.origin;
                const baseUrl = $("#frontendUrl").val();

                $item.on('click', function() {
                $input.val(page.slug);
                $input.val(\`$\{baseUrl}/$\{page.slug}\`);
                $list.remove();
                });

                $list.append($item);
            });

            $input.after($list);
            },
            error: function(err) {
            console.error('Autocomplete error:', err);
            }
        });
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest('.callout-link, .column-btn-link, .cta-link, .autocomplete-list').length) {
            $('.autocomplete-list').remove();
        }
    });

    // CTA Button Handlers
    $(document).on('click', '.add-cta-btn', function() {
        
        const $container = $(this).siblings('.cta-container');
        const ctaCount = $container.find('.cta-item').length;
        
        if (ctaCount >= 3) {
            $(this).attr("disabled", true);
            showToast('Maximum 3 CTA buttons allowed', 'warning');
            return;
        }
        
        const ctaHtml = \`
            <div class="cta-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold text-sm">CTA Button #\${ctaCount + 1}</span>
                    <button type="button" class="btn btn-sm btn-danger-600 remove-cta-btn"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Button Text:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 cta-text"
                        placeholder="e.g., Learn More">
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Button Link:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 cta-link"
                        placeholder="e.g., /about">
                </div>
            </div>
        \`;
        
        $container.append(ctaHtml);
        updateCtaNumbers($container);
    });

    $(document).on('click', '.remove-cta-btn', function() {
        const $container = $(this).closest('.cta-container');
        $(this).closest('.cta-item').remove();
        updateCtaNumbers($container);
    });

    function updateCtaNumbers($container) {
        $container.find('.cta-item').each(function(index) {
            $(this).find('.fw-semibold').text(\`CTA Button #\${index + 1}\`);
        });
    }

    // Tab Handlers
    $(document).on('click', '.add-tab-btn', function() {
        const $container = $(this).siblings('.tabs-container');
        const tabCount = $container.find('.tab-item').length;
        
        if (tabCount >= 8) {
            $(this).attr("disabled", true);
            showToast('Maximum 8 tabs allowed', 'warning');
            return;
        }
        
        const tabHtml = \`
            <div class="tab-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold text-sm">Tab #\${tabCount + 1}</span>
                    <button type="button" class="btn btn-sm btn-danger-600 remove-tab-btn"><iconify-icon icon="material-symbols:delete-outline"></iconify-icon></button>
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Title:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-title"
                        placeholder="Tab Title">
                </div>
                <div class="mb-2">
                    <label class="form-label text-sm">Heading:</label>
                    <input type="text" class="form-control border border-neutral-200 radius-8 tab-heading"
                        placeholder="Tab Heading">
                </div>
                <div>
                    <label class="form-label text-sm">Paragraph:</label>
                    <textarea class="form-control border border-neutral-200 radius-8 tab-paragraph ckeditor-paragraph" rows="3"
                        placeholder="Tab content"></textarea>
                </div>
            </div>
        \`;
        
        $container.append(tabHtml);
        updateTabNumbers($container);
        
        // Hide "No tabs found" message if it exists
        $container.find('.text-muted').hide();
        
        // Initialize CKEditor for the new textarea
        setTimeout(initCKEditor, 300);
    });

    $(document).on('click', '.remove-tab-btn', function() {
        const $container = $(this).closest('.tabs-container');
        const $tabItem = $(this).closest('.tab-item');
        
        // Don't allow removing if it's the last tab
        if ($container.find('.tab-item').length <= 1) {
            showToast('At least one tab is required', 'warning');
            return;
        }
        
        // Destroy CKEditor instance if it exists
        const $textarea = $tabItem.find('.tab-paragraph');
        const editorId = $textarea.attr('id');
        if (editorId && editorInstances[editorId]) {
            const editorInstance = editorInstances[editorId];
            if (editorInstance && typeof editorInstance.destroy === 'function') {
                try {
                    const destroyResult = editorInstance.destroy();
                    // Check if destroy returns a Promise (CKEditor 5) or undefined (CKEditor 4)
                    if (destroyResult && typeof destroyResult.then === 'function') {
                        destroyResult.then(() => {
                            delete editorInstances[editorId];
                        }).catch(error => {
                            console.error('Error destroying CKEditor:', error);
                            delete editorInstances[editorId];
                        });
                    } else {
                        // CKEditor 4 or synchronous destroy
                        delete editorInstances[editorId];
                    }
                } catch (error) {
                    console.error('Error calling destroy on CKEditor:', error);
                    delete editorInstances[editorId];
                }
            } else {
                delete editorInstances[editorId];
            }
        }
        
        $tabItem.remove();
        updateTabNumbers($container);
        
        // Show "No tabs found" message if no tabs left
        if ($container.find('.tab-item').length === 0) {
            $container.append('<p class="text-muted">No tabs found. Click "Add Tab" to create one.</p>');
        }
    });

    function updateTabNumbers($container) {
        $container.find('.tab-item').each(function(index) {
            $(this).find('.fw-semibold').text(\`Tab #\${index + 1}\`);
        });
    }

    // Community Groups Handlers - Category filter removed, defaulting to community

    function loadAvailablePages(category, $section) {
        const $availableList = $section.find('.available-pages-list');
        $availableList.html('<p class="text-muted text-sm">Loading pages...</p>');
        
        $.ajax({
            url: '/api/pages/by-category/' + category,
            type: 'GET',
            success: function(response) {
                if (response.success && response.data.length > 0) {
                    let html = '';
                    response.data.forEach(page => {
                        html += \`
                            <div class="available-page-item border border-neutral-300 radius-4 p-2 mb-2 bg-white d-flex justify-content-between align-items-center cursor-pointer" data-page-id="\${page._id}">
                                <span class="page-name">\${page.name}</span>
                                <button type="button" class="btn btn-sm btn-primary add-page-btn">Add</button>
                            </div>
                        \`;
                    });
                    $availableList.html(html);
                } else {
                    $availableList.html('<p class="text-muted text-sm">No pages found with this category. Create pages with "' + category + '" category first.</p>');
                }
            },
            error: function() {
                $availableList.html('<p class="text-danger text-sm">Error loading pages. Please try again.</p>');
            }
        });
    }

    $(document).on('click', '.add-page-btn', function() {
        const $pageItem = $(this).closest('.available-page-item');
        const pageId = $pageItem.data('page-id');
        const pageName = $pageItem.find('.page-name').text();
        const $section = $(this).closest('.community-groups-fields');
        const $selectedList = $section.find('.selected-pages-list');
        
        // Check if page is already selected
        if ($selectedList.find(\`[data-page-id="\${pageId}"]\`).length > 0) {
            showToast('Page is already selected', 'warning');
            return;
        }
        
        // Add to selected list
        const selectedHtml = \`
            <div class="selected-page-item border border-neutral-300 radius-4 p-2 mb-2 bg-white d-flex justify-content-between align-items-center" data-page-id="\${pageId}" data-order="0">
                <span class="page-name">\${pageName}</span>
                <button type="button" class="btn btn-sm btn-danger remove-page-btn">Remove</button>
            </div>
        \`;
        
        // Remove "No pages selected" message if it exists
        $selectedList.find('.text-muted').remove();
        $selectedList.append(selectedHtml);
        
        // Hide the page from available list
        $pageItem.hide();
        
        updatePageOrders($selectedList);
        
        // Reinitialize sortable after adding new item
        initializeCommunityGroupsSortable();
    });

    $(document).on('click', '.remove-page-btn', function() {
        const $pageItem = $(this).closest('.selected-page-item');
        const pageId = $pageItem.data('page-id');
        const $section = $(this).closest('.community-groups-fields');
        
        // Show the page back in available list
        $section.find(\`.available-page-item[data-page-id="\${pageId}"]\`).show();
        
        // Remove from selected list
        $pageItem.remove();
        
        const $selectedList = $section.find('.selected-pages-list');
        if ($selectedList.find('.selected-page-item').length === 0) {
            $selectedList.html('<p class="text-muted text-sm">No pages selected. Click on available pages to add them.</p>');
        }
        
        updatePageOrders($selectedList);
        
        // Reinitialize sortable after removing item
        initializeCommunityGroupsSortable();
    });

    function updatePageOrders($selectedList) {
        $selectedList.find('.selected-page-item').each(function(index) {
            $(this).attr('data-order', index);
        });
    }

    // Initialize community groups on page load
    $(document).ready(function() {
        $('.community-groups-fields').each(function() {
            // Default to community category since filter is removed
            loadAvailablePages('community', $(this));
        });
        
        // Initialize sortable for community groups
        initializeCommunityGroupsSortable();
    });
    
    // Initialize sortable functionality for community groups
    function initializeCommunityGroupsSortable() {
        $('.selected-pages-list').each(function() {
            if (this.sortable) {
                this.sortable.destroy();
            }
            
            this.sortable = new Sortable(this, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    updatePageOrders($(evt.to));
                }
            });
        });
    }
    var pageTemplate = $("#pageTemplate").val();
    if(pageTemplate == 'legislation'){
        $(".add-callout-btn").hide();
    }
    // Call Out Card Handlers
    $(document).on('click', '.add-callout-btn', function() {
        const $container = $(this).siblings('.callout-container');
        const calloutCount = $container.find('.callout-item').length;

        if(pageTemplate == 'legislation'){
            $(this).attr("disabled", true);
            return;
        }
        // Max 6 cards
        if (calloutCount >= 6) {
            $(this).attr("disabled", true);
            showToast('Maximum 6 Call Out Cards allowed', 'warning');
            return;
        }

        const cardNumber = calloutCount + 1;
        const calloutHtml = \`
        <div class="callout-item border border-neutral-200 radius-8 p-3 mb-2 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center gap-2">
                    <span class="fw-semibold text-sm">Card #\${cardNumber}</span>
                    <span class="badge custom-badge bg-secondary">Template Card</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-callout-btn">
                    <iconify-icon icon="material-symbols:delete-outline"></iconify-icon>
                </button>
            </div>
            <div class="mb-2">
                <label class="form-label text-sm">Heading: <span class="text-danger-600">*</span></label>
                <input type="text" class="form-control border border-neutral-200 radius-8 callout-heading" placeholder="Call Out Card \${cardNumber}">
            </div>
            <div class="mb-2">
                <label class="form-label text-sm">Paragraph:</label>
                <textarea class="form-control border border-neutral-200 radius-8 callout-subheading ckeditor-paragraph" rows="5" placeholder="Enter description here"></textarea>
            </div>
            <div>
                <label class="form-label text-sm">Link:</label>
                <input type="text" class="form-control border border-neutral-200 radius-8 callout-link" placeholder="e.g., /more">
            </div>
        </div>
        \`;
        $container.append(calloutHtml);
        updateCalloutNumbers($container);
        
        // Initialize CKEditor for the new textarea
        setTimeout(initCKEditor, 300);
    });

    $(document).on('click', '.remove-callout-btn', function() {
        const $container = $(this).closest('.callout-container');
        const $item = $(this).closest('.callout-item');
        
        // Destroy CKEditor instance if it exists
        const $textarea = $item.find('.callout-subheading');
        const editorId = $textarea.attr('id');
        if (editorId && editorInstances[editorId]) {
            const editorInstance = editorInstances[editorId];
            if (editorInstance && typeof editorInstance.destroy === 'function') {
                try {
                    const destroyResult = editorInstance.destroy();
                    // Check if destroy returns a Promise (CKEditor 5) or undefined (CKEditor 4)
                    if (destroyResult && typeof destroyResult.then === 'function') {
                        destroyResult.then(() => {
                            delete editorInstances[editorId];
                        }).catch(error => {
                            console.error('Error destroying CKEditor:', error);
                            delete editorInstances[editorId];
                        });
                    } else {
                        // CKEditor 4 or synchronous destroy
                        delete editorInstances[editorId];
                    }
                } catch (error) {
                    console.error('Error calling destroy on CKEditor:', error);
                    delete editorInstances[editorId];
                }
            } else {
                delete editorInstances[editorId];
            }
        }
        
        $item.remove();
        updateCalloutNumbers($container);
    });

    function updateCalloutNumbers($container) {
        $container.find('.callout-item').each(function(index) {
            $(this).find('.fw-semibold').text(\`Card #\${index + 1}\`);
        });
    }

    // Template placeholder logic
    $(document).ready(function() {
        const pageTemplate = $('#pageTemplate').val();
        
        // Template configurations
        const templateDefaults = {
            home: {
                heroSection: {
                    heading: 'Welcome to Our Website',
                    paragraph: 'Enter hero section description here',
                    ctas: [
                        { text: 'Get Started', link: '' },
                        { text: 'Learn More', link: '' }
                    ]
                },
                callOutCards: {
                    cards: [
                        { heading: 'Call Out Card 1', subheading: 'Enter description here', link: '' },
                        { heading: 'Call Out Card 2', subheading: 'Enter description here', link: '' },
                        { heading: 'Call Out Card 3', subheading: 'Enter description here', link: '' }
                    ]
                }
            },
            about: {
                heroSection: {
                    heading: 'About Us',
                    paragraph: 'Learn more about our organization and mission',
                    ctas: [{ text: 'Learn More', link: '' }]
                },
                tabsSection: {
                    tabs: [
                        { title: 'Tab 1', heading: 'First Tab', paragraph: 'Content for the first tab' },
                        { title: 'Tab 2', heading: 'Second Tab', paragraph: 'Content for the second tab' },
                        { title: 'Tab 3', heading: 'Third Tab', paragraph: 'Content for the third tab' }
                    ]
                }
            },
            legislation: {
                heroSection: {
                    heading: 'Legislation & Policy',
                    paragraph: 'Stay informed about our legislative initiatives and policy positions',
                    ctas: [
                        { text: 'View Legislation', link: '' },
                        { text: 'Policy Documents', link: '' }
                    ]
                },
                callOutCards: {
                    cards: [
                        { heading: 'Call Out Card', subheading: 'Enter description here', link: '' }
                    ]
                }
            },
            newsletter: {
                heroSection: {
                    heading: 'Newsletter',
                    paragraph: 'Stay updated with our latest news and updates',
                    ctas: [{ text: 'Subscribe Now', link: '' }]
                },
                tabsSection: {
                    tabs: [
                        { title: 'Tab 1', heading: 'First Tab', paragraph: 'Content for the first tab' },
                        { title: 'Tab 2', heading: 'Second Tab', paragraph: 'Content for the second tab' },
                        { title: 'Tab 3', heading: 'Third Tab', paragraph: 'Content for the third tab' }
                    ]
                }
            }
        };

        // Apply template placeholders
        if (pageTemplate && templateDefaults[pageTemplate]) {
            const template = templateDefaults[pageTemplate];
            
            // Process each section
            $('.section-block').each(function() {
                const $section = $(this);
                const sectionType = $section.find('.original-section-type').val();
                
                if (sectionType === 'hero-section' && template.heroSection) {
                    // Hero heading
                    const $heading = $section.find('.hero-heading');
                    if ($heading.val() === template.heroSection.heading || $heading.val() === '') {
                        $heading.val('').attr('placeholder', template.heroSection.heading);
                    }
                    
                    // Hero paragraph
                    const $paragraph = $section.find('.hero-paragraph');
                    if ($paragraph.val() === template.heroSection.paragraph || $paragraph.val() === '') {
                        $paragraph.val('').attr('placeholder', template.heroSection.paragraph);
                    }
                    
                    // CTA buttons
                    $section.find('.cta-item').each(function(index) {
                        const $cta = $(this);
                        if (template.heroSection.ctas && template.heroSection.ctas[index]) {
                            const templateCta = template.heroSection.ctas[index];
                            
                            const $ctaText = $cta.find('.cta-text');
                            if ($ctaText.val() === templateCta.text || $ctaText.val() === '') {
                                $ctaText.val('').attr('placeholder', templateCta.text);
                            }
                        }
                    });
                }
                
                // Call-out-cards section
                if (sectionType === 'call-out-cards' && template.callOutCards) {
                    $section.find('.callout-item').each(function(index) {
                        const $card = $(this);
                        if (template.callOutCards.cards && template.callOutCards.cards[index]) {
                            const templateCard = template.callOutCards.cards[index];
                            
                            // Card heading
                            const $heading = $card.find('.callout-heading');
                            if ($heading.val() === templateCard.heading || $heading.val() === '') {
                                $heading.val('').attr('placeholder', templateCard.heading);
                            }
                            
                            // Card subheading/paragraph
                            const $subheading = $card.find('.callout-subheading');
                            if ($subheading.val() === templateCard.subheading || $subheading.val() === '') {
                                $subheading.val('').attr('placeholder', templateCard.subheading);
                            }
                            
                            // Card link
                            const $link = $card.find('.callout-link');
                            if ($link.val() === templateCard.link || $link.val() === '') {
                                $link.val('').attr('placeholder', templateCard.link || 'e.g., /more');
                            }
                        }
                    });
                }
                
                // Tabs section
                if (sectionType === 'tabs-section' && template.tabsSection) {
                    $section.find('.tab-item').each(function(index) {
                        const $tab = $(this);
                        if (template.tabsSection.tabs && template.tabsSection.tabs[index]) {
                            const templateTab = template.tabsSection.tabs[index];
                            
                            // Tab title
                            const $title = $tab.find('.tab-title');
                            if ($title.val() === templateTab.title || $title.val() === '') {
                                $title.val('').attr('placeholder', templateTab.title);
                            }
                            
                            // Tab heading
                            const $heading = $tab.find('.tab-heading');
                            if ($heading.val() === templateTab.heading || $heading.val() === '') {
                                $heading.val('').attr('placeholder', templateTab.heading);
                            }
                            
                            // Tab paragraph
                            const $paragraph = $tab.find('.tab-paragraph');
                            if ($paragraph.val() === templateTab.paragraph || $paragraph.val() === '') {
                                $paragraph.val('').attr('placeholder', templateTab.paragraph);
                            }
                        }
                    });
                }
            });
        }
    });
    // Initialize media picker for hero image
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize media picker for hero image input
        const heroImageInputs = document.querySelectorAll('.hero-image-input');
        
        heroImageInputs.forEach(input => {
            const sectionBlock = input.closest('.section-block');
            const sectionId = sectionBlock ? sectionBlock.dataset.id : 'hero';
            
            window.initMediaPicker(\`input[name="heroImage"]\`, {
                allowedTypes: ['image'],
                title: 'Select Hero Image',
                buttonText: 'Select Image',
                onSelect: function(selectedMedia, inputElement) {
                    console.log('Hero image selected:', selectedMedia);
                    
                    // Update any existing preview elements
                    const existingImage = sectionBlock.querySelector('.existing-image img');
                    if (existingImage) {
                        existingImage.src = selectedMedia.src;
                    }
                    
                    // Show success message
                    if (window.showToast) {
                        window.showToast('Hero image selected successfully!', 'success');
                    }
                },
                onClear: function(inputElement) {
                    console.log('Hero image cleared');
                    
                    // Clear any existing preview elements
                    const existingImage = sectionBlock.querySelector('.existing-image img');
                    if (existingImage) {
                        existingImage.src = '/images/placeholder.jpg';
                    }
                    
                    if (window.showToast) {
                        window.showToast('Hero image removed', 'info');
                    }
                }
            });
        });
    });
    
    // AD Image Dropdown Functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Load ads for dropdown
        function loadAdsForDropdown() {
            // Load ads from server-side data instead of AJAX
            const adsData = window.adsData || [];
            console.log('Ads loaded from server:', adsData);
            populateAdDropdowns(adsData);
            
            // Show previews for already selected ads after population
            setTimeout(function() {
                $('.ad-image-select').each(function() {
                    const $select = $(this);
                    const selectedOption = $select.find('option:selected');
                    if (selectedOption.val() && selectedOption.val() !== '') {
                        const title = selectedOption.data('title');
                        const description = selectedOption.data('description');
                        const imageUrl = selectedOption.data('image');
                        if (title && imageUrl) {
                            console.log('Showing preview for selected ad:', title);
                            showAdPreview($select, title, description, imageUrl);
                        }
                    }
                });
            }, 100);
        }
        
        // Populate all AD dropdowns
        function populateAdDropdowns(ads) {
            console.log('Populating ad dropdowns with:', ads);
            $('.ad-image-select').each(function() {
                const $select = $(this);
                const currentValue = $select.data('current-value');
                const dropdownAdId = $select.data('id');
                console.log('Current value for dropdown:', currentValue);
                console.log('Type of current value:', typeof currentValue);
                
                // Clear existing options except the first one
                $select.find('option:not(:first)').remove();
                
                // Reset selection to default
                $select.val('');
                
                // Add ads as options
                ads.forEach(function(ad, index) {
                    console.log('Processing ad ' + (index + 1) + ':', {
                        id: ad._id,
                        title: ad.title,
                        media_url: ad.media_url,
                        link_url: ad.link_url,
                        link_target: ad.link_target
                    });
                    if (ad.media_url) {
                        const fullUrl = ad.media_url.startsWith('http') ? ad.media_url : window.location.origin + ad.media_url;
                        const adObject = {
                            id: ad._id,
                            image: fullUrl,
                            link: ad.link_url || '',
                            target: ad.link_target || '_self'
                        };
                        console.log('Created ad object:', adObject);
                        
                        const option = $('<option></option>')
                            .attr('value', ad._id)
                            .attr('data-ad-id', ad._id)
                            .attr('data-title', ad.title)
                            .attr('data-description', ad.description)
                            .attr('data-image', fullUrl)
                            .attr('data-link', ad.link_url || '')
                            .attr('data-target', ad.link_target || '_self')
                            .text(ad.title);

                        if (dropdownAdId == ad._id) {
                            option.prop('selected', true);

                            const adObject = {
                                id: ad._id,
                                image: fullUrl,
                                link: ad.link_url || '',
                                target: ad.link_target || '_self'
                            };

                            $select.siblings('.ad-image-input').val(JSON.stringify(adObject));

                            showAdPreview($select, ad.title, ad.description, fullUrl);
                        }
                        
                        // Check if this matches current value
                        if (currentValue && currentValue.trim() !== '') {
                            let shouldSelect = false;
                            let currentAd = null;
                            
                            try {
                                currentAd = JSON.parse(currentValue);
                                console.log(' Comparing current ad image:', currentAd.image);
                                console.log(' With dropdown ad image:', fullUrl);
                                console.log(' Ad media_url:', ad.media_url);
                                
                                // Extract filename from URLs for comparison
                                const currentImageFile = currentAd.image ? currentAd.image.split('/').pop() : '';
                                const adImageFile = ad.media_url ? ad.media_url.split('/').pop() : '';
                                const fullUrlFile = fullUrl ? fullUrl.split('/').pop() : '';
                                
                                console.log(' Comparing filenames:', {
                                    current: currentImageFile,
                                    adFile: adImageFile,
                                    fullUrlFile: fullUrlFile
                                });
                                
                                // Match by image URL or filename
                                if (currentAd.image === fullUrl || 
                                    currentAd.image === ad.media_url ||
                                    currentImageFile === adImageFile ||
                                    currentImageFile === fullUrlFile) {
                                    shouldSelect = true;
                                    console.log(' Match found for ad:', ad.title);
                                }
                            } catch (e) {
                                console.error(' Error parsing current value:', e, 'Value:', currentValue);
                                // Handle old format (just image URL)
                                if (currentValue === fullUrl || currentValue === ad.media_url) {
                                    shouldSelect = true;
                                    console.log(' Match found (old format) for ad:', ad.title);
                                }
                            }
                            
                            if (shouldSelect) {
                                // option.prop('selected', true);
                                $select.val(JSON.stringify(adObject));
                                showAdPreview($select, ad.title, ad.description, fullUrl);
                                console.log(' Selected ad option for:', ad.title, adObject);
                                
                                // Update the hidden input with the current ad object
                                const $adInput = $select.siblings('.ad-image-input');
                                $adInput.val(JSON.stringify(adObject));
                                
                                // Mark that we found a match
                                $select.data('match-found', true);
                            }
                        }
                        
                        $select.append(option);
                    }
                });
                
                // If no match was found and we have a current value, log it
                if (currentValue && currentValue.trim() !== '' && !$select.data('match-found')) {
                    console.log(' No match found for current value:', currentValue);
                    console.log(' Available ads:', ads.map(ad => ({
                        title: ad.title,
                        media_url: ad.media_url
                    })));
                }
            });
        }
        
        // Show AD preview
        function showAdPreview($select, title, description, imageUrl) {
            const $container = $select.siblings('.ad-preview-container');
            const $image = $container.find('.ad-preview-image');
            const $title = $container.find('.ad-preview-title');
            const $description = $container.find('.ad-preview-description');
            
            $image.attr('src', imageUrl);
            $title.text(title);
            $description.text(description);
            $container.show();
        }
        
        // Hide AD preview
        function hideAdPreview($select) {
            const $container = $select.siblings('.ad-preview-container');
            $container.hide();
        }
        
        // Handle AD selection change
        $(document).on('change', '.ad-image-select', function() {
            const $select = $(this);
            const selectedOption = $select.find('option:selected');
            const $adImageInput = $select.siblings('.ad-image-input');
            
            console.log(' Ad selection changed');
            console.log('Selected option value:', selectedOption.val());
            console.log('Selected option data:', {
                title: selectedOption.data('title'),
                description: selectedOption.data('description'),
                image: selectedOption.data('image'),
                link: selectedOption.data('link'),
                target: selectedOption.data('target')
            });
            
            if (selectedOption.val()) {
                const title = selectedOption.data('title');
                const description = selectedOption.data('description');
                const imageUrl = selectedOption.data('image');
                const linkUrl = selectedOption.data('link');
                const linkTarget = selectedOption.data('target');
                const adId = selectedOption.data('ad-id');
                
                // Create ad object with image, link, and target
                const adObject = {
                    id: adId,
                    image: imageUrl,
                    link: linkUrl,
                    target: linkTarget
                };
                
                console.log(' Created ad object:', adObject);
                
                // Update hidden input with ad object
                $adImageInput.val(JSON.stringify(adObject));
                console.log(' Updated hidden input value:', $adImageInput.val());
                console.log(' Hidden input element found:', $adImageInput.length);
                
                // Show preview
                showAdPreview($select, title, description, imageUrl);
                
                showToast('Advertisement selected successfully', 'success');
            } else {
                // Clear selection
                $adImageInput.val('');
                hideAdPreview($select);
                console.log(' Cleared ad selection');
            }
        });
        
        // Debug button handler
        $(document).on('click', '.debug-ad-btn', function() {
            const $section = $(this).closest('.section-block');
            const $select = $section.find('.ad-image-select');
            const $input = $section.find('.ad-image-input');
            
            console.log(' DEBUG AD DATA:');
            console.log('Selected option:', $select.find('option:selected').text());
            console.log('Selected value:', $select.val());
            console.log('Hidden input value:', $input.val());
            console.log('Current data-current-value:', $select.data('current-value'));
            
            console.log(' ALL DROPDOWN OPTIONS:');
            $select.find('option').each(function(index) {
                const $option = $(this);
                console.log('Option ' + index + ':', {
                    text: $option.text(),
                    value: $option.val(),
                    selected: $option.prop('selected'),
                    dataImage: $option.data('image')
                });
            });
            
            console.log(' AVAILABLE ADS DATA:', window.adsData);
            
            alert('Check console for detailed ad debug data');
        });
        
        // Load ads on page load
        loadAdsForDropdown();
    });
    
    // Thumbnail Selection Functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Handle thumbnail selection button click
        $(document).on('click', '.select-thumbnail-btn', function() {
            const button = $(this);
            const currentThumbnail = button.data('current-thumbnail');
            
            // Create media picker instance directly (same as ads management)
            const mediaPicker = new MediaPicker({
                allowedTypes: ['image'],
                title: 'Select Page Thumbnail',
                buttonText: 'Select Thumbnail',
                multiple: false,
                onSelect: function(selectedMedia) {
                    console.log('Thumbnail selected:', selectedMedia);
                    
                    // Update hidden input
                    $('#pageThumbnail').val(selectedMedia.src);
                    
                    // Update or create preview
                    let previewContainer = $('.current-thumbnail-preview');
                    if (previewContainer.length === 0) {
                        // Create preview container if it doesn't exist
                        previewContainer = $(\`
                            <div class="current-thumbnail-preview mb-3">
                                // <label class="form-label text-sm">Current Thumbnail:</label>
                                <div class="thumbnail-preview-container">
                                    <img src="" alt="Current Thumbnail" class="img-thumbnail current-thumbnail-img" 
                                         style="max-width: 150px; max-height: 100px; object-fit: cover;">
                                </div>
                            </div>
                        \`);
                        button.parent().prepend(previewContainer);
                    }
                    
                    // Update preview image
                    previewContainer.find('.current-thumbnail-img').attr('src', selectedMedia.src);
                    previewContainer.show();
                    
                    // Update button text
                    button.html('<iconify-icon icon="solar:gallery-outline" class="me-2"></iconify-icon>Change Thumbnail');
                    
                    // Add remove button if it doesn't exist
                    let removeBtn = $('.remove-thumbnail-btn');
                    if (removeBtn.length === 0) {
                        removeBtn = $(\`
                            <button type="button" class="btn btn-outline-danger btn-sm w-100 mt-2 remove-thumbnail-btn">
                                <iconify-icon icon="solar:trash-bin-minimalistic-outline" class="me-2"></iconify-icon>
                                Remove Thumbnail
                            </button>
                        \`);
                        button.after(removeBtn);
                    }
                    removeBtn.show();
                    
                    showToast('Thumbnail selected successfully', 'success');
                }
            });
            
            // Open the media picker
            mediaPicker.open();
        });
        
        // Handle remove thumbnail button click
        $(document).on('click', '.remove-thumbnail-btn', function() {
            const button = $(this);
            
            // Clear hidden input
            $('#pageThumbnail').val('');
            
            // Hide preview
            $('.current-thumbnail-preview').hide();
            
            // Update select button text
            $('.select-thumbnail-btn').html('<iconify-icon icon="solar:gallery-outline" class="me-2"></iconify-icon>Select Thumbnail');
            
            // Hide remove button
            button.hide();
            
            showToast('Thumbnail removed', 'success');
        });
    });

    </script>
    ` %>

<!-- WordPress-style Media Picker -->
<link rel="stylesheet" href="/css/media-picker.css">
<script src="/js/media-picker.js"></script>
<script src="/js/media-picker-integration.js"></script>

<script>
// Initialize media picker for hero image
/* document.addEventListener('DOMContentLoaded', function() {
    // Initialize media picker for ad image input
    const adImageInputs = document.querySelectorAll('.ad-image-input');
    
    adImageInputs.forEach(input => {
        const sectionBlock = input.closest('.section-block');
        const sectionId = sectionBlock ? sectionBlock.dataset.id : 'hero';
        
        window.initMediaPicker(`input[name="heroImage"]`, {
            allowedTypes: ['image'],
            title: 'Select Hero Image',
            buttonText: 'Select Image',
            onSelect: function(selectedMedia, inputElement) {
                console.log('Hero image selected:', selectedMedia);
                
                // Update any existing preview elements
                const existingImage = sectionBlock.querySelector('.existing-image img');
                if (existingImage) {
                    existingImage.src = selectedMedia.src;
                }
                
                // Show success message
                if (window.showToast) {
                    window.showToast('Hero image selected successfully!', 'success');
                }
            },
            onClear: function(inputElement) {
                console.log('Hero image cleared');
                
                // Clear any existing preview elements
                const existingImage = sectionBlock.querySelector('.existing-image img');
                if (existingImage) {
                    existingImage.src = '/images/placeholder.jpg';
                }
                
                if (window.showToast) {
                    window.showToast('Hero image removed', 'info');
                }
            }
        });
    });
}); */
</script>